function CMPanelTime(TheCanvasMap){this.TheCanvasMap=TheCanvasMap;this.RightSide=100;this.VerticalSpacing=20;this.TimeSpacing=50;this.SelectedRow=0;this.SelectedColumn=0;var TimePanelElement;this.SetElement=function(NewElement){TimePanelElement=NewElement;var TheElement=document.createElement("canvas");TheElement.width=500;TheElement.height=500;TheElement.id="TIME_EDITOR_CANVAS";TimePanelElement.appendChild(TheElement);TimePanelElement.GetColumnFromEvent=function(TheEvent){var Coordinate=CMUtilities.GetElementCoordinate(TheEvent.clientX,TheEvent.clientY,this);var X=Coordinate.x;var TheColumn=Math.floor((X-this.TimePanel.RightSide)/this.TimePanel.TimeSpacing);return(TheColumn);}
TimePanelElement.GetSelectedRowFromEvent=function(TheEvent){var Coordinate=CMUtilities.GetElementCoordinate(TheEvent.clientX,TheEvent.clientY,this);var Y=Coordinate.y;var Row=Math.floor((Y)/this.TimePanel.VerticalSpacing-1);return(Row);}
TimePanelElement.TimePanel=this;TimePanelElement.addEventListener('mousedown',function(TheEvent){var TheColumn=this.GetColumnFromEvent(TheEvent);var TheRow=this.GetSelectedRowFromEvent(TheEvent);var NumRows=this.TimePanel.GetNumRows();var TheScene=this.TimePanel.TheCanvasMap.GetScene();var TheTimeSlices=TheScene.GetTimes();var TheSlice=TheTimeSlices[TheColumn];var NumTimeSlices=TheTimeSlices.length;if(NumTimeSlices<=0)NumTimeSlices=1;event.preventDefault();if(event.button==0){if((TheColumn>=-1)&&(TheColumn<NumTimeSlices)&&(TheRow>=-1)&&(TheRow<NumRows)){this.TimePanel.SelectedRow=TheRow;this.TimePanel.SelectedColumn=TheColumn;this.TimePanel.TheCanvasMap.GetScene().SetTimeRange(TheTimeSlices[TheColumn]);TheScene.Repaint();this.TimePanel.PaintTimeEditor();if(this.TimePanel.SelectedRow==0){this.TimePanel.SettingsPanel.Setup(TheScene);TheScene.SetSelected(true);}else{var TheObject=this.TimePanel.GetRowObject(this.TimePanel.SelectedRow);if(TheObject!=null){this.TimePanel.SettingsPanel.Setup(TheObject);TheObject.SetSelected(true);}}}}if(event.button!=0){if(TheRow==-1){var ThePopupMenu=CMUtilities.GetPopupMenu("CM_LayerPopupMenu",TheEvent.clientX,TheEvent.clientY);if(TheColumn>=0){var InsertSlice=TheSlice+1;if(TheColumn!=TheTimeSlices.length-1){InsertSlice=(TheTimeSlices[TheColumn+1]+TheSlice)/2;}var PropertiesElement=document.createElement('div');PropertiesElement.setAttribute("id","CM_SettingsElement");PropertiesElement.className="CM_LayerListPopupMenuItem";PropertiesElement.innerHTML="Insert Right...";PropertiesElement.TheSlice=InsertSlice;PropertiesElement.TimePanel=this.TimePanel;PropertiesElement.ThePopupMenu=ThePopupMenu;PropertiesElement.addEventListener('click',function(event){var TheScene=this.TimePanel.TheCanvasMap.GetScene();TheScene.InsertTime(this.TheSlice);this.ThePopupMenu.style.visibility="hidden";event.stopPropagation();});ThePopupMenu.appendChild(PropertiesElement);}if(TheColumn>0){var InsertSlice=(TheTimeSlices[TheColumn-1]+TheSlice)/2;var PropertiesElement=document.createElement('div');PropertiesElement.setAttribute("id","CM_SettingsElement");PropertiesElement.className="CM_LayerListPopupMenuItem";PropertiesElement.innerHTML="Insert Left...";PropertiesElement.TheSlice=InsertSlice;PropertiesElement.TimePanel=this.TimePanel;PropertiesElement.ThePopupMenu=ThePopupMenu;PropertiesElement.addEventListener('click',function(event){var TheScene=this.TimePanel.TheCanvasMap.GetScene();TheScene.InsertTime(this.TheSlice);this.ThePopupMenu.style.visibility="hidden";event.stopPropagation();});ThePopupMenu.appendChild(PropertiesElement);}if(TheColumn>0){var PropertiesElement=document.createElement('div');PropertiesElement.setAttribute("id","CM_SettingsElement");PropertiesElement.className="CM_LayerListPopupMenuItem";PropertiesElement.innerHTML="Delete...";PropertiesElement.TheSlice=TheSlice;PropertiesElement.TimePanel=this.TimePanel;PropertiesElement.ThePopupMenu=ThePopupMenu;PropertiesElement.addEventListener('click',function(event){var TheScene=this.TimePanel.TheCanvasMap.GetScene();TheScene.DeleteTime(this.TheSlice);this.ThePopupMenu.style.visibility="hidden";event.stopPropagation();});ThePopupMenu.appendChild(PropertiesElement);}if(ThePopupMenu.childNodes.length==0)CMMainContainer.HidePopupWindow();}else{var ThePopupMenu=CMUtilities.GetPopupMenu("CM_LayerPopupMenu",TheEvent.clientX,TheEvent.clientY);if(TheColumn>=0){var TheObject=this.TimePanel.GetRowObject(this.TimePanel.SelectedRow);var TheTimeSlices=TheObject.GetTimes();var TimeIndex=TheTimeSlices.indexOf(TheSlice);var PropertiesElement=document.createElement('div');PropertiesElement.setAttribute("id","CM_SettingsElement");PropertiesElement.className="CM_LayerListPopupMenuItem";PropertiesElement.TheSlice=TheSlice;PropertiesElement.TimePanel=this.TimePanel;PropertiesElement.ThePopupMenu=ThePopupMenu;if(TimeIndex==-1){PropertiesElement.innerHTML="Add Settings...";PropertiesElement.addEventListener('click',function(event){var TheObject=this.TimePanel.GetRowObject(this.TimePanel.SelectedRow);TheObject.InsertTime(this.TheSlice);this.ThePopupMenu.style.visibility="hidden";event.stopPropagation();this.TimePanel.PaintTimeEditor();});ThePopupMenu.appendChild(PropertiesElement);}else if(TimeIndex!=0){PropertiesElement.innerHTML="Delete Settings...";PropertiesElement.addEventListener('click',function(event){var TheObject=this.TimePanel.GetRowObject(this.TimePanel.SelectedRow);TheObject.DeleteTime(this.TheSlice);this.ThePopupMenu.style.visibility="hidden";event.stopPropagation();});ThePopupMenu.appendChild(PropertiesElement);}}if(ThePopupMenu.childNodes.length==0)CMMainContainer.HidePopupWindow();}}event.stopPropagation();event.preventDefault();return(false);});}
var TheScene=TheCanvasMap.GetScene();TheScene.AddListener(CMScene.MESSAGE_LAYER_LIST_CHANGED,this,function(TheScene,TheListener,AdditionalInfo){TheListener.PaintTimeEditor();});TheScene.AddListener(CMScene.MESSAGE_TIME_SLICES_CHANGED,this,function(TheScene,TheListener,AdditionalInfo){TheListener.PaintTimeEditor();});TheScene.AddListener(CMScene.MESSAGE_SELECTION_CHANGED,this,function(TheScene,TheListener,AdditionalInfo){TheListener.PaintTimeEditor();});this.PaintTimeEditor();}CMPanelTime.prototype.GetRowObject=function(RowNumber){var TheObject=null;var TheScene=this.TheCanvasMap.GetScene();if(RowNumber==0){TheObject=TheScene;}else{var NumLayers=TheScene.Layers.length;var CurrentRow=1;for(var i=0;(i<NumLayers)&&(TheObject==null);i++){var TheLayer=TheScene.GetLayer(i);if(CurrentRow==RowNumber){TheObject=TheLayer;}CurrentRow++;var NumChildren=TheLayer.GetNumChildren();for(var j=0;(j<NumChildren)&&(TheObject==null);j++){var TheChild=TheLayer.GetChild(j);if(CurrentRow==RowNumber){TheObject=TheChild;}CurrentRow++;}}}return(TheObject);}
function AppendElement(ElementType,TheParent){var TheChild=document.createElement(ElementType);TheParent.appendChild(TheChild);return(TheChild);}CMPanelTime.prototype.GetColumnLeft=function(TheColumn){var TheColumnLeft=this.RightSide+TheColumn*this.TimeSpacing;return(TheColumnLeft);}
CMPanelTime.prototype.GetRowTop=function(Row){var RowTop=(Row+1)*this.VerticalSpacing;return(RowTop);}
CMPanelTime.prototype.SetSettingsPanel=function(SettingsPanel){this.SettingsPanel=SettingsPanel;}
function PaintLine(TheContext,X1,Y1,X2,Y2){TheContext.beginPath();TheContext.moveTo(X1,Y1);TheContext.lineTo(X2,Y2);TheContext.stroke();}CMPanelTime.prototype.GetNumRows=function(){var TheScene=this.TheCanvasMap.GetScene();var NumLayers=TheScene.Layers.length;var NumRows=NumLayers+1;for(var i=0;i<NumLayers;i++){var TheLayer=TheScene.GetLayer(i);NumRows+=TheLayer.GetNumChildren();}return(NumRows);}
CMPanelTime.prototype.PaintTimeSliceSettingsSymbols=function(AllTimeSlices,TheItem,Y,TheContext){for(var TimeIndex=0;TimeIndex<AllTimeSlices.length;TimeIndex++){var TheTimeSlice=AllTimeSlices[TimeIndex];var TimeSliceSettings=TheItem.GetSettings(TheTimeSlice);if(TimeSliceSettings!=null){var X=this.RightSide+TimeIndex*this.TimeSpacing;var TheText="O";TheContext.fillText(TheText,X+4,Y-4);}}}
CMPanelTime.prototype.PaintTimeEditor=function(){var TheScene=this.TheCanvasMap.GetScene();var TimeSlices=TheScene.GetTimes();var TimePanelElement=document.getElementById("TIME_EDITOR_CANVAS");if(TimePanelElement!=null){var TheContext=TimePanelElement.getContext("2d");var TheScene=this.TheCanvasMap.GetScene();var NumLayers=TheScene.Layers.length;var ElementWidth=TimePanelElement.offsetWidth;var ElementHeight=TimePanelElement.offsetWidth;var NumRows=0;TheContext.fillStyle="#ffffff";TheContext.fillRect(0,0,ElementWidth,ElementHeight);TheContext.fill();var Y=(NumRows+1)*this.VerticalSpacing;PaintLine(TheContext,0,Y,ElementWidth,Y);NumRows++;TheContext.strokeStyle="#000000";TheContext.lineWidth=1;var Y=(NumRows+1)*this.VerticalSpacing;TheContext.font="14px  arial";TheContext.fillStyle="#000000";TheContext.fillText("Layers",4,Y-4);this.PaintTimeSliceSettingsSymbols(TimeSlices,TheScene,Y,TheContext);PaintLine(TheContext,0,Y,ElementWidth,Y);NumRows++;for(var i=0;i<NumLayers;i++){var TheLayer=TheScene.GetLayer(i);var Name=TheLayer.GetName();var Y=(NumRows+1)*this.VerticalSpacing;TheContext.fillText(Name,4,Y-4);this.PaintTimeSliceSettingsSymbols(TimeSlices,TheLayer,Y,TheContext);PaintLine(TheContext,0,Y,ElementWidth,Y);NumRows++;var NumChildren=TheLayer.GetNumChildren();for(var j=0;j<NumChildren;j++){var TheChild=TheLayer.GetChild(j);var Y=(NumRows+1)*this.VerticalSpacing;TheContext.fillText(TheChild.GetName(),14,Y-4);this.PaintTimeSliceSettingsSymbols(TimeSlices,TheChild,Y,TheContext);PaintLine(TheContext,0,Y,ElementWidth,Y);NumRows++;}}for(var i=0;i<TimeSlices.length;i++){var X=this.RightSide+i*this.TimeSpacing;var TheText=TimeSlices[i];TheContext.fillText(TheText,X+4,this.VerticalSpacing-4);PaintLine(TheContext,X,0,X,ElementHeight);}var X=this.RightSide+TimeSlices.length*this.TimeSpacing;PaintLine(TheContext,X,0,X,ElementHeight);if(this.SelectedColumn!=-1){var X=this.GetColumnLeft(this.SelectedColumn);var Y=this.GetRowTop(this.SelectedRow);TheContext.strokeStyle="#000000";TheContext.lineWidth=2;TheContext.rect(X+1,Y+1,this.TimeSpacing-2,this.VerticalSpacing-2);TheContext.stroke();}}}