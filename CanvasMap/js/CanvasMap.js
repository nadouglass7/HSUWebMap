var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(a,c,d){var b=this.length||0;0>c&&(c=Math.max(0,b+c));if(null==d||d>b)d=b;d=Number(d);0>d&&(d=Math.max(0,b+d));for(c=Number(c||0);c<d;c++)this[c]=a;return this}},"es6","es3");$jscomp.polyfill("Math.log10",function(a){return a?a:function(a){return Math.log(a)/Math.LN10}},"es6","es3");CMBase.DATA_TYPE_COORDINATES=1;CMBase.DATA_TYPE_COLOR=2;CMBase.DATA_TYPE_INTEGER=3;CMBase.DATA_TYPE_BOOLEAN=4;CMBase.DATA_TYPE_FLOAT=5;
CMBase.DATA_TYPE_CSS_STYLE=6;CMBase.DATA_TYPE_ENUMERATED=7;CMBase.DATA_TYPE_URL=8;CMBase.DATA_TYPE_STRING=9;CMBase.DATA_TYPE_IMAGE=10;CMBase.DATA_TYPE_FONT=11;CMBase.UniqueNumber=1;function CMBase(){}CMBase.prototype.GetName=function(){return"Untitled"};CMBase.prototype.GetNumChildren=function(){return 0};CMBase.prototype.GetChild=function(a){return null};CMBase.prototype.SetParent=function(a){this.TheParent=a};
CMBase.prototype.GetParent=function(a){var b=null;void 0!=this.TheParent&&(void 0!=a?b=this.TheParent instanceof a?this.TheParent:this.TheParent.GetParent(a):void 0!=this.TheParent&&(b=this.TheParent));return b};CMBase.prototype.AddListener=function(a,b,c){void 0==this.Listeners&&(this.Listeners=[]);void 0==this.Listeners[a]&&(this.Listeners[a]=[]);var d=CMBase.GetUniqueNumber();this.Listeners[a].push({TheFunction:c,TheListener:b,UniqueNumber:d});return d};
CMBase.prototype.RemoveListener=function(a,b){if(void 0!=this.Listeners){a=this.Listeners[a];for(var c=0;c<a.length;c++)a[c].UniqueNumber==b&&a.splice(c,1)}};CMBase.prototype.SendMessageToListeners=function(a,b){if(void 0!=this.Listeners&&(a=this.Listeners[a],void 0!=a))for(var c=0;c<a.length;c++)a[c].TheFunction(this,a[c].TheListener,b)};CMBase.prototype.GetSettingsDefinitions=function(){return{}};CMBase.prototype.GetSettings=function(){return{}};CMBase.prototype.SetSettings=function(a){};
CMBase.GetUniqueNumber=function(){CMBase.UniqueNumber++;return CMBase.UniqueNumber-1};CMDataset.GEOJSON=1;CMDataset.PYRAMID=2;CMDataset.PYRAMID_OPEN_FORMAT=3;CMDataset.RASTER=4;CMDataset.SQL=5;CMDataset.MESSAGE_DATASET_LOADED=CMBase.GetUniqueNumber();CMDataset.MESSAGE_DATASET_SELECTION_CHANGED=CMBase.GetUniqueNumber();CMDataset.MESSAGE_DATASET_MOUSE_OVER_FEATURE_CHANGED=CMBase.GetUniqueNumber();CMDataset.LOAD_STATUS_NONE=1;CMDataset.LOAD_STATUS_LOADING=2;CMDataset.LOAD_STATUS_LOADED=3;CMDataset.LOAD_STATUS_PENDING=4;CMDataset.LOAD_STATUS_CANCELED=5;CMDataset.REQUEST_TYPE_IMAGE=1;
CMDataset.REQUEST_TYPE_TEXT=2;CMDataset.RequestQue=[];CMDataset.CurrentRequest=null;
CMDataset.MakeRequest=function(a){a.TheImage.TheRequest=a;a.TheImage.onload=function(){this.TheRequest.LoadStatus=CMDataset.LOAD_STATUS_LOADED;0<CMDataset.RequestQue.length?(CMDataset.CurrentRequest=CMDataset.RequestQue[0],CMDataset.RequestQue.shift(),CMDataset.CurrentRequest.LoadStatus=CMDataset.LOAD_STATUS_LOADING,CMDataset.CurrentRequest.TheImage.src=CMDataset.CurrentRequest.src):CMDataset.CurrentRequest=null;this.TheRequest.TheFunction()};null==CMDataset.CurrentRequest?(CMDataset.CurrentRequest=
a,a.LoadStatus=CMDataset.LOAD_STATUS_LOADING,a.TheImage.src=a.src):(a.LoadStatus=CMDataset.LOAD_STATUS_PENDING,CMDataset.RequestQue.push(a))};CMDataset.ResetRequests=function(){var a=CMDataset.RequestQue;CMDataset.RequestQue=[];for(var b=0;b<a.length;b++){var c=a[b];a[b]=null;c.LoadStatus=CMDataset.LOAD_STATUS_CANCELED}};function CMDataset(){CMBase.call(this);this.URL=null;this.MouseOverFeatureIndex=this.SelectedFeature=-1;this.ClickTolerance=8}CMDataset.prototype=Object.create(CMBase.prototype);
CMDataset.prototype.contructor=CMDataset;CMDataset.prototype.GetNumAttributeRows=function(){return 0};CMDataset.prototype.GetNumAttributeColumns=function(){return 0};CMDataset.prototype.GetAttributeHeading=function(a){return""};CMDataset.prototype.GetAttributeCell=function(a,b){return""};CMDataset.prototype.AddAttributeHeading=function(a,b){};CMDataset.prototype.GetAttributeCellByHeading=function(a,b){return""};CMDataset.prototype.SetAttributeCell=function(a,b,c){};
CMDataset.prototype.SetAttributeCellByHeading=function(a,b,c){};CMDataset.prototype.GetAttributeArrayByHeading=function(a){for(var b=this.GetNumAttributeRows(),c=[],d=0;d<b;d++)c[d]=this.GetAttributeCellByHeading(a,d);return c};CMDataset.prototype.SetProjector=function(a){this.TheProjector=a};CMDataset.prototype.GetProjector=function(){return this.TheProjector};CMDataset.prototype.SetURL=function(a,b){alert("TCMDataset.SetURL() should be overriden in a subclass")};
CMDataset.prototype.SetData=function(a){this.TheData=a};CMDataset.prototype.GetNumFeatures=function(){return 0};CMDataset.prototype.InFeature=function(a,b,c,d){return!1};CMDataset.prototype.In=function(a,b,c){return-1};CMDataset.prototype.Paint=function(a,b,c){};CMDataset.prototype.GetSearchResults=function(a,b){};CMDataset.prototype.GetIcon=function(a,b){return b};CMDataset.prototype.SetSelectedFeature=function(a){this.SelectedFeature!=a&&(this.SelectedFeature=a,this.SendMessageToListeners(CMDataset.MESSAGE_DATASET_SELECTION_CHANGED))};
CMDataset.prototype.GetSelectedFeature=function(){return this.SelectedFeature};CMDataset.prototype.SetMouseOverFeature=function(a){this.MouseOverFeatureIndex!=a&&(this.MouseOverFeatureIndex=a,this.SendMessageToListeners(CMDataset.MESSAGE_DATASET_MOUSE_OVER_FEATURE_CHANGED))};CMDataset.prototype.GetMouseOverFeature=function(){return this.MouseOverFeatureIndex};CMDataset.prototype.AddPoint=function(a,b){};CMDataset.TheDataSets=[];
CMDataset.GetDataObject=function(a,b){for(var c=null,d=0;d<CMDataset.TheDataSets.length;d++)CMDataset.TheDataSets[d].URL==a&&(c=CMDataset.TheDataSets[d]);if(null==c){switch(b){case CMDataset.GEOJSON:case void 0:c=new CMDatasetGeoJSON;break;case CMDataset.PYRAMID:c=new CMDatasetPyramid;break;case CMDataset.PYRAMID_OPEN_FORMAT:c=new CMDatasetPyramidOpenFormat;break;case CMDataset.RASTER:alert("Sorry, CMDataset.RASTER is not yet supported");break;case CMDataset.SQL:c=new CMDatasetSQL}CMDataset.TheDataSets.push(c)}return c};function CMDatasetGeoJSON(){CMDataset.call(this);this.TheData=null}CMDatasetGeoJSON.prototype=Object.create(CMDataset.prototype);CMDatasetGeoJSON.prototype.contructor=CMDatasetGeoJSON;
CMDatasetGeoJSON.prototype.GetBoundingBoxFromGeoJSON=function(a){var b={};this.FeatureBounds=[];if(null!=a){a=a.features;for(var c=0;c<a.length;c++){var d={};CMUtilities.ApplyToGeometryCoordinates(a[c].geometry,CMUtilities.UpdateGeoJSONCoordinateBounds,d);0==Object.keys(b).length?(b.XMin=d.XMin,b.XMax=d.XMax,b.YMin=d.YMin,b.YMax=d.YMax):(b.XMin>d.XMin&&(b.XMin=d.XMin),b.XMax<d.XMax&&(b.XMax=d.XMax),b.YMin>d.YMin&&(b.YMin=d.YMin),b.YMax<d.YMax&&(b.YMax=d.YMax));this.FeatureBounds[c]=d}}return b};
CMDatasetGeoJSON.prototype.PaintRefGeometry=function(a,b,c,d,e){if("LineString"==d.type)this.PaintRefLineString(d.coordinates);else if("MultiLineString"==d.type)for(var f=0;f<d.coordinates.length;f++)TheCoordinates=d.coordinates[f],this.PaintRefLineString(a,b,c,TheCoordinates,e);else if("Polygon"==d.type)for(f=0;f<d.coordinates.length;f++)TheCoordinates=d.coordinates[f],this.PaintRefPolygon(a,b,c,TheCoordinates,e);else if("MultiPolygon"==d.type)for(var g=0;g<d.coordinates.length;g++){var h=d.coordinates[g];
for(f=0;f<h.length;f++)TheCoordinates=h[f],this.PaintRefPolygon(a,b,c,TheCoordinates,e)}else if("GeometryCollection"==d.type)for(f=0;f<d.geometries.length;f++)this.PaintRefGeometry(a,b,c,d.geometries[f],e)};CMDatasetGeoJSON.prototype.PaintRefPolygon=function(a,b,c,d,e){a.PaintPoly(b,c,d,!0,e)};CMDatasetGeoJSON.prototype.PaintRefLineString=function(a,b,c,d,e){a.PaintPoly(b,c,d,!1,e)};CMDatasetGeoJSON.prototype.SetBounds=function(a){this.TheBounds=a};CMDatasetGeoJSON.prototype.GetBounds=function(){return this.TheBounds};
CMDatasetGeoJSON.prototype.GetFeatureBounds=function(a){return this.FeatureBounds[a]};CMDatasetGeoJSON.prototype.GetNumAttributeRows=function(){var a=0;null!=this.TheData&&(a=this.TheData.features.length);return a};CMDatasetGeoJSON.prototype.GetNumAttributeColumns=function(){var a=0;if(null!=this.TheData){var b=this.TheData.features[0].properties,c;for(c in b)a++}return a};
CMDatasetGeoJSON.prototype.GetAttributeHeading=function(a){var b="";if(null!=this.TheData){var c=this.TheData.features[0].properties,d=null,e=0,f;for(f in c)e==a&&(d=f),e++;null!=d&&(b=d)}return b};CMDatasetGeoJSON.prototype.GetAttributeCell=function(a,b){var c="";if(null!=this.TheData){var d=this.TheData.features[0].properties,e=null,f=0,g;for(g in d)f==a&&(e=g),f++;null!=e&&(c=this.TheData.features[b].properties[e])}return c};
CMDatasetGeoJSON.prototype.AddAttributeHeading=function(a,b){if(null!=this.TheData){var c=this.TheData.features;for(i=0;i<c.length;i++)c[i].properties[a]=b}return""};CMDatasetGeoJSON.prototype.GetAttributeCellByHeading=function(a,b){var c="";null!=this.TheData&&(c=this.TheData.features[b].properties[a]);return c};CMDatasetGeoJSON.prototype.SetAttributeCell=function(a,b,c){null!==this.TheData&&(this.TheData.features[b].properties[a]=c);return""};
CMDatasetGeoJSON.prototype.SetAttributeCellByHeading=function(a,b,c){null!=this.TheData&&(this.TheData.features[b].properties[a]=c)};
CMDatasetGeoJSON.prototype.SetURL=function(a,b){this.URL=a;var c=new XMLHttpRequest;c.open("GET",a,!0);c.TheURL=a;c.TheDataset=this;c.ZoomToBounds=b;c.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var a=JSON.parse(c.responseText),b=this.TheDataset.GetProjector();null!=b&&b.ProjectGeoJSONFromGeographic(a);this.TheDataset.SetData(a);this.ZoomToBounds&&this.TheDataset.GetParent(CMMainContainer).ZoomToBounds(this.TheDataset.GetBounds());null!=this.TheDataset.GetParent(CMMainContainer)&&
this.TheDataset.GetParent(CMMainContainer).AddToDebugPanel(this.TheDataset.GetName()+" Received info, repainting:"+CMUtilities.GetSeconds());this.TheDataset.SendMessageToListeners(CMDataset.MESSAGE_DATASET_LOADED)}else alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")")};c.send()};
CMDatasetGeoJSON.prototype.SaveDataToURL=function(a){var b=JSON.stringify(this.TheData);a+=encodeURI("?Data="+b);var c=new XMLHttpRequest;c.open("PUT",a,!0);c.TheURL=a;c.TheDataset=this;c.onreadystatechange=function(){4==this.readyState&&(200==this.status?JSON.parse(c.responseText):alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")"))};c.send(b)};CMDatasetGeoJSON.prototype.SetData=function(a){this.TheData=a;a=this.GetBoundingBoxFromGeoJSON(a);this.SetBounds(a)};
CMDatasetGeoJSON.prototype.GetNumFeatures=function(){var a=0;null!=this.TheData&&(a=this.TheData.features.length);return a};CMDatasetGeoJSON.prototype.In=function(a,b,c){var d=-1;if(null!=this.TheData){a.GetRefWidthFromPixelWidth(this.ClickTolerance);for(var e=this.TheData.features,f=0;f<e.length&&-1==d;f++)this.InFeature(a,b,c,f)&&(d=f)}return d};
CMDatasetGeoJSON.prototype.InFeature=function(a,b,c,d){var e=!1;if(null!=this.TheData){a=a.GetRefWidthFromPixelWidth(this.ClickTolerance);var f=this.TheData.features[d].geometry;e=!1;if("Point"==f.type)d=f.coordinates,Math.abs(d[0]-b)<=a&&Math.abs(d[1]-c)<=a&&(e=!0);else if("LineString"==f.type)d=f.coordinates,e=CMUtilities.InGeoJSONPolyline(b,c,d,a);else if("MultiLineString"==f.type)for(var g=0;g<f.coordinates.length&&0==e;g++)d=f.coordinates[g],e=CMUtilities.InGeoJSONPolyline(b,c,d,a);else if("Polygon"==
f.type)d=f.coordinates[0],e=CMUtilities.InGeoJSONPolygon(b,c,d);else if("MultiPolygon"==f.type)for(g=0;g<f.coordinates.length&&0==e;g++)d=f.coordinates[g][0],e=CMUtilities.InGeoJSONPolygon(b,c,d)}return e};
CMDatasetGeoJSON.prototype.Paint=function(a,b,c,d){if(b instanceof CMView2D&&null!=this.TheData){void 0==d&&(d=!1);this.GetParent(CMMainContainer).AddToDebugPanel(this.GetName()+" Starting Paint:"+CMUtilities.GetSeconds());for(var e=this.TheData.features,f=b.GetExtent(),g=0;g<e.length;g++){var h=!1;0==c&&0==d?h=!0:c&&this.SelectedFeature==g?h=!0:d&&this.MouseOverFeatureIndex==g&&(h=!0);h&&(h=this.GetFeatureBounds(g),CMUtilities.BoundsOverlap(f,h)&&(h=e[g].geometry,"Point"==h.type?(h=h.coordinates,
a.PaintPoint(b,g,h[0],h[1],c)):(h=e[g].geometry,this.PaintRefGeometry(a,b,g,h,c))))}this.GetParent(CMMainContainer).AddToDebugPanel(this.GetName()+" Leaving Paint:"+CMUtilities.GetSeconds())}};
CMDatasetGeoJSON.prototype.GetSearchResults=function(a,b){if(null!=this.TheData){TheFeatures=this.TheData.features;for(var c=0;c<TheFeatures.length;c++){var d=TheFeatures[c].properties,e=!1,f;for(f in d)if(0==e&&d.hasOwnProperty(f)){var g=d[f];"string"==typeof g&&(g=g.toLowerCase(),-1!=g.indexOf(a)&&(e=document.createElement("DIV"),e.innerHTML=d[f],e.className="CM_SearchResult",e.TheDataset=this,e.FeatureIndex=c,e.onclick=function(){var a=this.TheDataset.GetParent(CMScene);a.UnselectAll();this.TheDataset.SetSelectedFeature(this.FeatureIndex);
var b=this.TheDataset.FeatureBounds[this.FeatureIndex];a=a.GetView(0);this.className="CM_SearchResultSelected";a.ZoomToBounds(b)},b.appendChild(e),e=!0))}}}};CMDatasetGeoJSON.prototype.CMDataset_GetIcon=CMDataset.prototype.GetIcon;
CMDatasetGeoJSON.prototype.GetIcon=function(a,b){b=this.CMDataset_GetIcon(a,b);if(null!=this.TheData&&(TheFeatures=this.TheData.features,0<TheFeatures.length)){var c=TheFeatures[0].geometry;if("LineString"==c.type||"MultiLineString"==c.type)b=document.createElement("div"),b.className="CM_LayerListIconClass",b.TheLayer=this,b.style.backgroundColor="rgba(0,0,0,0)",b.style.borderColor="rgba(0,0,0,0)",c=document.createElement("CANVAS"),c.width=16,c.height=16,b.appendChild(c),a=a.GetSetting("Style","strokeStyle"),
c=c.getContext("2d"),c.strokeStyle=a,c.moveTo(0,0),c.lineTo(16,16),c.stroke()}return b};CMDatasetGeoJSON.prototype.AddPoint=function(a,b){var c=this.GetProjector();null!=c&&(b=c.ProjectFromGeographic(a,b),a=b.Easting,b=b.Northing);a={type:"Feature",properties:{scalerank:10},geometry:{type:"Point",coordinates:[a,b]}};null==this.TheData&&(this.TheData={type:"FeatureCollection",features:[]});this.TheData.features.push(a);this.GetBoundingBoxFromGeoJSON(this.TheData)};function CMDatasetPyramid(){CMDataset.call(this);this.Attributes=null;this.HeadingIndex=-1;this.TileWidthInPixels=256;this.PaintDebugTileInfo=!1;this.DebugZoomLevel=-1;this.DebugGlobalRow=this.DebugGlobalColumn=0;this.Bounds=null}CMDatasetPyramid.prototype=Object.create(CMDataset.prototype);CMDatasetPyramid.prototype.contructor=CMDatasetPyramid;CMDatasetPyramid.prototype.SetDebugTile=function(a,b,c){this.PaintDebugTileInfo=!0;this.DebugZoomLevel=a;this.DebugGlobalColumn=b;this.DebugGlobalRow=c};
CMDatasetPyramid.prototype.SetURL=function(a,b){this.URL=a;this.ZoomToBounds=b;a=this.URL+"Info.js";b=new XMLHttpRequest;b.open("GET",a,!0);b.TheURL=a;b.TheDataset=this;b.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var a=JSON.parse(this.responseText);null===this.TheDataset.GetName()&&this.TheDataset.SetName(a.Title);this.TheDataset.SetBounds(a.Bounds);this.TheDataset.OriginalBounds=a.OriginalBounds;this.TheDataset.Attributes=a.Attributes;this.TheDataset.TileRefWidth=a.TileRefWidth;
this.TheDataset.MinColumn=Math.round(a.MinColumn);this.TheDataset.MaxColumn=Math.round(a.MaxColumn);this.TheDataset.NumColumns=Math.round(a.NumColumns);this.TheDataset.MinRow=Math.round(a.MinRow);this.TheDataset.MaxRow=Math.round(a.MaxRow);this.TheDataset.NumRows=Math.round(a.NumRows);this.TheDataset.TopZoomLevel=Math.round(a.TopZoomLevel);this.TheDataset.Tiles=[];a=this.TheDataset.GetParent(CMMainContainer).GetScene().GetView(0);for(Row=0;Row<this.TheDataset.NumRows;Row++)for(this.TheDataset.Tiles[Row]=
[],Column=0;Column<this.TheDataset.NumColumns;Column++)this.TheDataset.Tiles[Row][Column]=new CMTile(this.TheDataset,this.TheDataset.TopZoomLevel,Column+this.TheDataset.MinColumn,this.TheDataset.MaxRow-Row),this.PaintDebugTileInfo&&TheChildTile.SetPaintTileInfo(this.PaintDebugTile),this.TheDataset.Tiles[Row][Column].LoadTile(a);this.TheDataset.ZoomToBounds&&a.ZoomToBounds(this.TheDataset.GetBounds());this.TheDataset.GetParent(CMScene).Repaint();null!=this.TheDataset.OnLoad&&this.TheDataset.OnLoad()}else alert("HTTP error "+
this.status+" "+this.statusText+" ("+this.TheURL+")")};b.send()};CMDatasetPyramid.prototype.In=function(a,b,c){for(var d=-1,e=0;e<this.NumRows&&-1==d;e++)for(Column=0;Column<this.NumColumns&&-1==d;Column++)d=this.Tiles[e][Column].In(a,b,c);return d};CMDatasetPyramid.prototype.GetHeadingIndex=function(){if(-1==this.HeadingIndex)for(var a=0;a<this.Attributes.Headings.length;a++)this.Attributes.Headings[a]==this.HTMLAttribute&&(this.HeadingIndex=a)};
CMDatasetPyramid.prototype.ShowInfoWindow=function(a,b,c,d){null!=this.HTMLAttribute&&(this.GetHeadingIndex(),a=b.CreateInfoWindow("CMDatasetPyramid.InfoWindow",c,d,200,30,this.Attributes.Values[this.HeadingIndex][a]),CMMainContainer.SetPopupWindow(a))};
CMDatasetPyramid.prototype.MouseDown=function(a,b,c){var d=!1;if(this.IsVisible()&&a.GetTool()==CMView.TOOL_INFO&&a.GetTool()==CMView.TOOL_SELECT)for(var e=0;e<this.NumRows&&0==d;e++)for(Column=0;Column<this.NumColumns&&0==d;Column++)d=this.Tiles[e][Column].MouseDown(a,b,c);return d};CMDatasetPyramid.prototype.SetBounds=function(a){this.TheBounds=a};CMDatasetPyramid.prototype.GetNumAttributeRows=function(){var a=0;null!=this.Attributes&&(a=this.Attributes.Values[0].length);return a};
CMDatasetPyramid.prototype.GetNumAttributeColumns=function(){var a=0;null!=this.Attributes&&0<this.Attributes.Values.length&&(a=this.Attributes.Headings.length);return a};CMDatasetPyramid.prototype.GetAttributeHeading=function(a){var b="";null!=this.Attributes&&(b=this.Attributes.Headings[a]);return b};CMDatasetPyramid.prototype.GetAttributeCell=function(a,b){var c="";null!=this.Attributes&&(c=this.Attributes.Values[a][b]);return c};
CMDatasetPyramid.prototype.GetFeatureBounds=function(a){for(var b=null,c=0;c<this.NumRows;c++)for(Column=0;Column<this.NumColumns;Column++)b=this.Tiles[c][Column].AddToFeatureBounds(a,b);return b};
CMDatasetPyramid.prototype.Paint=function(a,b,c,d){if(void 0!=this.NumRows&&0==c&&(void 0==d||0==d)){this.GetParent(CMMainContainer).AddToDebugPanel(this.GetName()+" Starting Paint:"+CMUtilities.GetSeconds());b.GetContext();for(d=0;d<this.NumRows;d++)for(Column=0;Column<this.NumColumns;Column++)this.Tiles[d][Column].PaintTile(a,b,c,this.TileRefWidth);this.GetParent(CMMainContainer).AddToDebugPanel(this.GetName()+" Leaving Paint:"+CMUtilities.GetSeconds())}};
CMDatasetPyramid.prototype.GetSearchResults=function(a,b){if(this.IsVisible()&&null!=this.Attributes)for(var c=this.GetNumAttributeRows(),d=this.GetNumAttributeColumns(),e=0;e<d;e++)for(var f=this.Attributes.Values[e],g=0;g<c;g++){var h=f[g];h=h.toLowerCase();-1!=h.indexOf(a)&&(h=document.createElement("DIV"),h.innerHTML=f[g],h.TheLayer=this,h.FeatureIndex=g,h.onclick=function(){this.TheLayer.TheScene.UnselectAll();this.TheLayer.SetSelectedFeature(this.FeatureIndex);var a=this.TheLayer.GetFeatureBounds(this.FeatureIndex),
b=this.TheLayer.TheScene.GetView(0);this.className="CM_SearchResultSelected";b.ZoomToBounds(a)},b.appendChild(h))}return""};function CMDatasetPyramidOpenFormat(){CMDataset.call(this);this.TileWidthInPixels=256;this.PaintDebugTile=!1;this.DebugZoomLevel=-1;this.DebugGlobalRow=this.DebugGlobalColumn=0;this.FileExtension=null}CMDatasetPyramidOpenFormat.prototype=Object.create(CMDataset.prototype);CMDatasetPyramidOpenFormat.prototype.contructor=CMDatasetPyramidOpenFormat;
CMDatasetPyramidOpenFormat.prototype.GetUpperLeftColumnRow=function(a){var b=a.GetRefXFromPixelX(0),c=a.GetRefYFromPixelY(0);a=256/Math.pow(2,Math.floor(a.ZoomLevel));b=Math.floor(b/a);c=Math.floor(-c/a);-0==b&&(b=0);-0==c&&(c=0);return{LeftColumnIndex:b,TopRowIndex:c}};
CMDatasetPyramidOpenFormat.prototype.CreateImageTile=function(a,b,c){c=Math.floor(c.ZoomLevel);if(null==this.ImageTiles[c][b][a]){this.ImageTiles[c][b][a]=new Image;var d=this.ImageTiles[c][b][a];d.Loaded=!1;d.TheDataset=this;d.onload=function(){this.Loaded=!0;this.TheDataset.GetParent(CMScene).Repaint()};c=18+c;var e=this.LeftColumnIndex+a,f=this.TopRowIndex+b;e=a;f=b;if(0<=e&&0<=f){a="";for(b=0;3>b;b++)0!=b&&(a+="/"),"x"==this.CoordinateValueOrder[b]&&(a+=e),"y"==this.CoordinateValueOrder[b]&&(a+=
f),"z"==this.CoordinateValueOrder[b]&&(a+=c);null!=this.FileExtension&&(a+="."+this.FileExtension);d.src=this.URL+a}}};CMDatasetPyramidOpenFormat.prototype.SetDebugTile=function(a,b,c){this.PaintDebugTile=!0;this.DebugZoomLevel=a;this.DebugGlobalColumn=b;this.DebugGlobalRow=c};
CMDatasetPyramidOpenFormat.prototype.SetURL=function(a,b){a=a.trim();"}"!=a[a.length-1]&&(b=a.lastIndexOf("."),this.FileExtension=a.substr(b+1));b=a.indexOf("{x}");var c=a.indexOf("{y}"),d=a.indexOf("{z}"),e=d;this.CoordinateValueOrder=[];b<c?b<d?(e=b,this.CoordinateValueOrder=c<d?["x","y","z"]:["x","z","y"]):this.CoordinateValueOrder=["z","x","y"]:b<d?this.CoordinateValueOrder=["y","x","z"]:c<d?(e=c,this.CoordinateValueOrder=["y","z","x"]):this.CoordinateValueOrder=["z","y","x"];this.URL=a=a.substr(0,
e);this.ImageTiles=[];this.GetParent(CMScene).Repaint()};
CMDatasetPyramidOpenFormat.prototype.Paint=function(a,b,c,d){if(0==c&&(void 0==d||0==d)){c=b.GetContext();var e=!1,f=Math.floor(b.ZoomLevel);if(null!=this.ImageTiles){null==this.ImageTiles[f]&&(this.ImageTiles[f]=[]);d=this.GetUpperLeftColumnRow(b);var g=d.LeftColumnIndex,h=d.TopRowIndex;d=b.GetCanvasElement();var k=Math.floor(d.height/this.TileWidthInPixels)+2,l=Math.floor(d.width/this.TileWidthInPixels)+2;b.GetPixelXFromRefX(0);b.GetPixelYFromRefY(0);d=a.GetStyle(b);void 0!=d&&b.SetStyle(d);for(var m=
0;m<k;m++){var p=m+h;null==this.ImageTiles[f][p]&&(this.ImageTiles[f][p]=[]);for(var q=0;q<l;q++){var n=q+g;var r=this.ImageTiles[f][p][n];if(null==r)this.CreateImageTile(n,p,b);else if(r.Loaded){var w=256/Math.pow(2,f);var v=n*w;var y=-(p*w);b.PaintRefImageScaled(r,v,y,w,-w);e=!0}}}void 0!=d&&b.RestoreStyle();d=a.GetStyle(b,0,"Text");if(null!=d){void 0!=d&&b.SetStyle(d);a.SetupLabelFont(b,-1);for(m=0;m<k;m++){p=m+h;try{for(q=0;q<l;q++)if(n=q+g,r=this.ImageTiles[f][p][n],null!=r&&r.Loaded){var u=
n+","+p;v=n*w+w/2;y=-(p*w)-w/2;b.PaintRefText(u,v,y,12,"center");b.GetRefXFromPixelX(X);b.GetRefYFromPixelY(Y)}}catch(z){}}void 0!=d&&b.RestoreStyle()}}0==e&&null!=this.TheBounds&&void 0!=a.GetStyle(b)&&(d=this.GetStyle(b),void 0!=d&&b.SetStyle(d),y=b.GetPixelXFromRefX(this.TheBounds.XMin),a=b.GetPixelYFromRefY(this.TheBounds.YMax),v=b.GetPixelWidthFromRefWidth(this.TheBounds.XMax-this.TheBounds.XMin),r=b.GetPixelHeightFromRefHeight(this.TheBounds.YMin-this.TheBounds.YMax),4>v&&(v=4),4>r&&(r=4),null!=
c.strokeStyle&&c.strokeRect(y,a,v,r),void 0!=d&&b.RestoreStyle())}};CMDialog.DIALOG_WIDTH=400;CMDialog.DIALOG_HEIGHT=400;CMDialog.CreateCloseBox=function(a,b,c,d,e,f){var g=document.createElement("canvas");CMUtilities.AbsolutePosition(g,b,c,d,e);g.style.border="1px solid "+f;g.width=d;g.height=e;a instanceof CMDialog?a.TheElement.appendChild(g):a.appendChild(g);g.TheDialog=a;g.onmousedown=function(a){this.TheDialog instanceof CMDialog?this.TheDialog.SetVisible(!1):this.TheDialog.style.visibility="hidden"};CMDialog.PaintCloseBox(g,d,e,f);return g};
CMDialog.PaintCloseBox=function(a,b,c,d){a=a.getContext("2d");a.strokeStyle=d;a.lineWidth=2;a.beginPath();a.moveTo(0,0);a.lineTo(b,c);a.stroke();a.beginPath();a.moveTo(b,0);a.lineTo(0,c);a.stroke();a.strokeRect(1,1,b-2,c-2)};
function CMDialog(a,b,c,d){-1==b&&(b=CMDialog.DIALOG_WIDTH);-1==c&&(c=CMDialog.DIALOG_HEIGHT);this.TheElement=document.getElementById(a);if(null==this.TheElement)this.TheElement=document.createElement("DIV"),this.TheElement.id=a,document.body.appendChild(this.TheElement);else for(;this.TheElement.firstChild;)this.TheElement.removeChild(this.TheElement.firstChild);this.TheElement.className="CM_SettingsDialog";this.TheElement.style.visibility="visible";var e=$(window).height();a=$(window).width();CMUtilities.AbsolutePosition(this.TheElement,
(a-b)/2,(e-c)/2,b,c);CMDialog.CreateCloseBox(this,b-26,10,16,16,"#ffffff");this.DisablePage=document.getElementById("DialogDisablePage");null==this.DisablePage&&(this.DisablePage=document.createElement("DIV"),this.DisablePage.id="DialogDisablePage",document.body.appendChild(this.DisablePage));this.DisablePage.style.visibility="hidden";d&&(this.DisablePage.style.backgroundColor="white",this.DisablePage.style.visibility="visible",this.DisablePage.style.opacity="0.5",this.DisablePage.style.zIndex="99999999",
e=$(window).height(),a=$(window).width(),CMUtilities.AbsolutePosition(this.DisablePage,0,0,a,e))}CMDialog.prototype.SetVisible=function(a){a?(this.TheElement.style.visibility="visible",this.DisablePage.style.visibility="visible"):(this.TheElement.style.visibility="hidden",this.DisablePage.style.visibility="hidden")};CMDialog.AddLabelToPanel=function(a,b,c,d){var e=document.createElement("div");e.innerHTML=b;a.appendChild(e);CMUtilities.AbsolutePosition(e,c+10,d,300,30);return e};
CMDialog.AddParagraphToPanel=function(a,b,c,d,e,f){var g=document.createElement("p");g.innerHTML=b;a.appendChild(g);CMUtilities.AbsolutePosition(g,c+10,d,e,f);return g};
CMDialog.AddColorControlToPanel=function(a,b,c,d,e){var f=document.createElement("div");f.innerHTML=b;a.appendChild(f);CMUtilities.AbsolutePosition(f,c+10,d,100,30);document.createElement("input");b=document.createElement("div");b.innerHTML="<input id='ColorControl' type='color'>";b=b.childNodes[0];e=CMUtilities.GetHexColorFromColor(e);b.value=e;a.appendChild(b);CMUtilities.AbsolutePosition(b,c+110,d,100,20);return b};
CMDialog.AddButtonControlToPanel=function(a,b,c,d){var e=document.createElement("button");b=document.createTextNode(b);e.appendChild(b);a.appendChild(e);CMUtilities.AbsolutePosition(e,c+10,d,80,30);return e};CMDialog.AddSliderControlToPanel=function(a,b,c,d,e,f,g){b=CMUtilities.CreateLabelControl(b);CMUtilities.AbsolutePosition(b,c+10,d,80,30);a.appendChild(b);e=CMUtilities.CreateSliderControl(e,f,g);CMUtilities.AbsolutePosition(e,c+110,d,100,30);a.appendChild(e);return e};
CMDialog.AddCheckBoxControlToPanel=function(a,b,c,d,e){var f=document.createElement("input");f.type="checkbox";f.name=b;f.text=b;f.checked=e?!0:!1;a.appendChild(f);CMUtilities.AbsolutePosition(f,c,d,40,30);e=document.createElement("div");e.innerHTML=b;a.appendChild(e);CMUtilities.AbsolutePosition(e,c+60,d+8,80,30);return f};
CMDialog.AddTextControlToPanel=function(a,b,c,d,e){var f=document.createElement("div");f.innerHTML=b;a.appendChild(f);CMUtilities.AbsolutePosition(f,c+10,d+8,100,30);f=document.createElement("input");f.type="text";f.name=b;void 0!=e&&(f.value=e);a.appendChild(f);CMUtilities.AbsolutePosition(f,c+110,d,80,24);return f};
CMDialog.AddRadioControlToPanel=function(a,b,c,d,e,f){for(var g=[],h=0;h<e.length;h++){var k=document.createElement("input");k.type="radio";k.name=b;k.value=e[h];f==e[h]&&(k.checked=!0);a.appendChild(k);CMUtilities.AbsolutePosition(k,c+10,d,24,24);var l=document.createElement("div");l.innerHTML=e[h];a.appendChild(l);CMUtilities.AbsolutePosition(l,c+50,d+8,100,30);d+=30;g.push(k)}return g};
CMDialog.AddSelectControlToPanel=function(a,b,c,d,e,f){var g=document.createElement("div");g.innerHTML=b;a.appendChild(g);CMUtilities.AbsolutePosition(g,c+10,d+8,100,30);e=CMUtilities.CreateSelectControl(e,f);e.name=b;a.appendChild(e);CMUtilities.AbsolutePosition(e,c+110,d,150,24);return e};CMDialog.prototype.AddLabel=function(a,b,c){return CMDialog.AddLabelToPanel(this.TheElement,a,b,c)};
CMDialog.prototype.AddParagraph=function(a,b,c,d,e){return CMDialog.AddParagraphToPanel(this.TheElement,a,b,c,d,e)};CMDialog.prototype.AddColorControl=function(a,b,c,d){return CMDialog.AddColorControlToPanel(this.TheElement,a,b,c,d)};CMDialog.prototype.AddButtonControl=function(a,b,c){return CMDialog.AddButtonControlToPanel(this.TheElement,a,b,c)};CMDialog.prototype.AddSliderControl=function(a,b,c,d,e,f){return CMDialog.AddSliderControlToPanel(this.TheElement,a,b,c,d,e,f)};
CMDialog.prototype.AddCheckBoxControl=function(a,b,c,d){return CMDialog.AddCheckBoxControlToPanel(this.TheElement,b,c,d)};CMDialog.prototype.AddTextControl=function(a,b,c,d){return CMDialog.AddTextControlToPanel(this.TheElement,a,b,c,d)};CMDialog.prototype.AddRadioControl=function(a,b,c,d,e){return CMDialog.AddRadioControlToPanel(this.TheElement,a,b,c,d,e)};CMDialog.prototype.AddSelectControl=function(a,b,c,d,e){return CMDialog.AddSelectControlToPanel(this.TheElement,a,b,c,d,e)};
CMDialog.GetRGBAFromControls=function(a,b){b=b.value;a=CMUtilities.GetRGBFromHex(a.value);a=a.Red+","+a.Green+","+a.Blue;return 100!=b?"rgba("+a+","+b/100+")":"rgb("+a+")"};CMDialogSettings=function(){};CMDialogSettings.SetStyle=function(a,b,c,d){var e=a.GetProperty(b,null);null==e&&(e={});e[c]=d;a.SetProperty(b,e);a.GetScene().Repaint()};
CMDialogSettings.AddPenPanel=function(a,b,c){var d=10,e=document.createElement("div");a.TheElement.appendChild(e);var f=0;a=b.GetProperty(c,null);var g=null;null!=a&&(g=a.strokeStyle);g=CMDialog.AddColorControlToPanel(e,"Pen Color:",f,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(b,c,"strokeStyle",this.value)});d+=40;g=["None","butt","round","square"];var h="None";null!=a&&(h=a.lineCap);g=CMDialog.AddSelectControlToPanel(e,"Cap:",f,d,g,h);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(b,
c,"lineCap",this.value)});d+=40;g=["None","bevel","round","miter"];h="None";null!=a&&(h=a.lineJoin);g=CMDialog.AddSelectControlToPanel(e,"Join:",f,d,g,h);g.TheLayer=b;$(g).change(function(){var a=this.value;"None"==a&&(a=void 0);CMDialogSettings.SetStyle(b,c,"lineJoin",a)});d+=40;g=null;null!=a&&(g=a.miterLimit);g=CMDialog.AddTextControlToPanel(e,"Miter Limit:",f,d,g);g.TheLayer=b;$(g).change(function(){""==this.value&&(this.value=void 0);CMDialogSettings.SetStyle(b,c,"miterLimit",this.value)});d+=
40;g=null;null!=a&&(g=a.lineWidth);g=CMDialog.AddTextControlToPanel(e,"Width:",f,d,g);g.TheLayer=b;$(g).change(function(){""==this.value&&(this.value=void 0);CMDialogSettings.SetStyle(b,c,"lineWidth",this.value)});d+=50;h=null;null!=a&&(h=a.fillStyle);g=CMDialog.AddColorControlToPanel(e,"Fill Color:",f,d,h);g.TheLayer=b;$(g).change(function(){var a=CMDialog.GetRGBAFromControls(this,this.FillTransparencyControl);CMDialogSettings.SetStyle(this.TheLayer,c,"fillStyle",a)});d+=40;h=100;null!=a&&(h=a.fillStyle,
h=100*CMUtilities.GetRGBAValuesFromRGBA(h).Transparency);f=CMDialog.AddSliderControlToPanel(e,"Transparency:",f,d,0,100,h);f.TheLayer=b;$(f).change(function(){var a=CMDialog.GetRGBAFromControls(this.FillColorControl,this);CMDialogSettings.SetStyle(this.TheLayer,c,"fillStyle",a)});f.FillColorControl=g;g.FillTransparencyControl=f;d+=40;g.FillTransparencyControl=f;f.FillColorControl=g;f=270;d=10;CMDialog.AddLabelToPanel(e,"Shadow Settings:",f,d).style.fontSize="18px";d+=40;g=null;null!=a&&(g=a.shadowColor);
g=CMDialog.AddColorControlToPanel(e,"Color:",f,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(this.TheLayer,c,"shadowColor",this.value)});d+=40;g=0;null!=a&&(g=a.shadowBlur);g=CMDialog.AddTextControlToPanel(e,"Blur:",f,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(this.TheLayer,c,"shadowBlur",this.value)});d+=40;g=0;null!=a&&(g=a.shadowOffsetX);g=CMDialog.AddTextControlToPanel(e,"X Offset:",f,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(this.TheLayer,
c,"shadowOffsetX",this.value)});g=0;null!=a&&(g=a.shadowOffsetY);d=CMDialog.AddTextControlToPanel(e,"Y Offset:",f,d+40,g);d.TheLayer=b;$(d).change(function(){CMDialogSettings.SetStyle(this.TheLayer,c,"shadowOffsetY",this.value)});return e};
CMDialogSettings.AddGeneralPanel=function(a,b,c){var d=10,e=document.createElement("div");a.TheElement.appendChild(e);a=b.GetProperty(c,null);var f=100;null!=a&&(f=100*a.globalAlpha);var g=CMDialog.AddSliderControlToPanel(e,"Global Opacity:",10,d,0,100,f);g.TheLayer=b;$(g).change(function(){var a=g.value/100;1<a&&(a=1);0>a&&(a=0);CMDialogSettings.SetStyle(b,c,"globalAlpha",a)});d+=40;a=b.GetPropertyAttribute(CMLayer.INFO);f=b.GetDataset().GetAttributeHeadings();var h=CMDialog.AddSelectControlToPanel(e,
"Attribute:",10,d,f,a);h.TheLayer=b;$(h).change(function(){this.TheLayer.SetPropertyAttribute(CMLayer.INFO,h.value);this.TheLayer.GetScene().Repaint()});return e};CMDialogSettings.Fonts="Arial;Verdana;Times New Roman;Courier New;serif;sans-serif".split(";");CMDialogSettings.FontWeights=["normal","bold","bolder","lighter"];CMDialogSettings.LabelDirectionStrings="Top Left;Top;Top Right;Right;Bottom Right;Bottom;Bottom Left;Left".split(";");
CMDialogSettings.AddFontPanel=function(a,b){var c=10,d=10,e=document.createElement("div");a.TheElement.appendChild(e);var f=b.GetProperty(CMLayer.LABEL_FONT,null),g="40",h="Arial";a="normal";if(null!=f){var k=f.indexOf("px");-1!=k&&(g=f.substring(0,k),k=g.lastIndexOf(" "),-1!=k&&(g=g.substring(k+1)),g=parseInt(g));for(k=0;k<CMDialogSettings.Fonts.length;k++)-1!=f.indexOf(CMDialogSettings.Fonts[k])&&(h=CMDialogSettings.Fonts[k]);for(k=0;k<CMDialogSettings.FontWeights.length;k++)-1!=f.indexOf(CMDialogSettings.FontWeights[k])&&
(a=CMDialogSettings.FontWeights[k]);f.indexOf("italic")}f=CMDialog.AddSelectControlToPanel(e,"Font Family:",c,d,CMDialogSettings.Fonts,h);f.TheLayer=b;$(f).change(function(){CMDialogSettings.SetFont(this.Controls,this.TheLayer)});d+=40;a=CMDialog.AddSelectControlToPanel(e,"Font Weight:",c,d,CMDialogSettings.FontWeights,a);a.TheLayer=b;$(a).change(function(){CMDialogSettings.SetFont(this.Controls,this.TheLayer)});d+=40;g=CMDialog.AddTextControlToPanel(e,"Font Size:",c,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetFont(this.Controls,
this.TheLayer)});d+=40;h={FontControl:f,FontWeightControl:a,FontSizeControl:g};f.Controls=h;a.Controls=h;g.Controls=h;LabelDirection="TR";a=b.GetProperty(CMLayer.LABEL_POSITION);null!=a&&(LabelDirection=a.Direction);k=CMLayer.LabelDirections.indexOf(LabelDirection);LabelDirectionString=CMDialogSettings.LabelDirectionStrings[k];var l=CMDialog.AddSelectControlToPanel(e,"Direction:",c,d,CMDialogSettings.LabelDirectionStrings,LabelDirectionString);l.TheLayer=b;$(l).change(function(){var a=l.selectedIndex,
b=this.TheLayer.GetProperty(CMLayer.LABEL_POSITION);b.Direction=CMLayer.LabelDirections[a];this.TheLayer.SetProperty(CMLayer.LABEL_POSITION,b);this.TheLayer.GetScene().Repaint()});d+=40;f=10;null!=a&&(f=a.OffsetX);var m=CMDialog.AddTextControlToPanel(e,"X Offset:",c,d,f);m.TheLayer=b;$(m).change(function(){var a=this.TheLayer.GetProperty(CMLayer.LABEL_POSITION);a.OffsetX=parseInt(m.value);this.TheLayer.SetProperty(CMLayer.LABEL_POSITION,a);this.TheLayer.GetScene().Repaint()});f=10;null!=a&&(f=a.OffsetY);
var p=CMDialog.AddTextControlToPanel(e,"Y Offset:",c,d+40,f);p.TheLayer=b;$(p).change(function(){var a=this.TheLayer.GetProperty(CMLayer.LABEL_POSITION);a.OffsetY=parseInt(p.value);this.TheLayer.SetProperty(CMLayer.LABEL_POSITION,a);this.TheLayer.GetScene().Repaint()});c=300;d=10;a=b.GetPropertyAttribute(CMLayer.LABEL);f=b.GetDataset().GetAttributeHeadings();l=CMDialog.AddSelectControlToPanel(e,"Attribute:",c,d,f,a);l.TheLayer=b;$(l).change(function(){this.TheLayer.SetPropertyAttribute(CMLayer.LABEL,
l.value);this.TheLayer.GetScene().Repaint()});return e};CMDialogSettings.MarkTypes=["Circle","Triangle","Square","Star"];
CMDialogSettings.AddMarkPanel=function(a,b){var c=10,d=document.createElement("div");a.TheElement.appendChild(d);a=b.GetProperty(CMLayer.MARK_TYPE);a=CMDialog.AddSelectControlToPanel(d,"Mark Type:",10,c,CMDialogSettings.MarkTypes,CMDialogSettings.MarkTypes[a]);a.TheLayer=b;$(a).change(function(){this.TheLayer.SetProperty(CMLayer.MARK_TYPE,this.selectedIndex);this.TheLayer.GetScene().Repaint()});c+=40;a=b.GetProperty(CMLayer.MARK_SIZE);c=CMDialog.AddTextControlToPanel(d,"Mark Size:",10,c,a);c.TheLayer=
b;$(c).change(function(){var a=parseInt(this.value);this.TheLayer.SetProperty(CMLayer.MARK_SIZE,a);this.TheLayer.GetScene().Repaint()});return d};CMDialogSettings.SetFont=function(a,b){b.SetProperty(CMLayer.LABEL_FONT,a.FontWeightControl.value+" "+a.FontSizeControl.value+"px "+a.FontControl.value);b.GetScene().Repaint()};CMDialogSettings.HidePanels=function(a){for(var b=0;b<a.Panels.length;b++)a.Panels[b].style.visibility="hidden",a.Tabs[b].className="CM_SettingsDialogTab"};
CMDialogSettings.AddTab=function(a,b,c,d,e,f,g,h){d=document.createElement("LI");d.className="CM_SettingsDialogTab";a.appendChild(d);a=document.createTextNode(c);d.appendChild(a);d.TargetPanel=h;d.TargetTab=d;d.TheDialog=b;d.addEventListener("click",function(){CMDialogSettings.HidePanels(this.TheDialog);this.TargetTab.className="CM_SettingsDialogTab_Selected";this.TargetPanel.style.visibility="visible"});return d};
CMDialogSettings.ShowSettingsDialog=function(a){var b=new CMDialog("LayerVector_Settings_Dialog",600,400);b.SuperClass_SetVisible=b.SetVisible;b.SetVisible=function(a){this.SuperClass_SetVisible(a);!1===a&&CMDialogSettings.HidePanels(this)};null==a.TheStyle&&(a.TheStyle={});var c=document.createElement("UL");b.TheElement.appendChild(c);var d=CMDialogSettings.AddGeneralPanel(b,a,CMLayer.FEATURE_STYLE);d.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(d,10,40,500,500);var e=CMDialogSettings.AddPenPanel(b,
a,CMLayer.FEATURE_STYLE);e.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(e,10,40,500,500);var f=CMDialogSettings.AddPenPanel(b,a,CMLayer.LABEL_STYLE);f.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(f,10,40,500,500);var g=CMDialogSettings.AddFontPanel(b,a);g.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(g,10,40,500,500);var h=CMDialogSettings.AddMarkPanel(b,a);h.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(h,10,40,500,500);var k=CMDialogSettings.AddPenPanel(b,
a,CMLayer.MOUSE_OVER_STYLE);k.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(k,10,40,500,500);a=CMDialogSettings.AddPenPanel(b,a,CMLayer.SELECTED_STYLE);a.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(a,10,40,500,500);b.Panels=[];b.Tabs=[];b.Panels.push(d);b.Panels.push(e);b.Panels.push(f);b.Panels.push(g);b.Panels.push(h);b.Panels.push(k);b.Panels.push(a);d=CMDialogSettings.AddTab(c,b,"General",10,10,100,30,d);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Feature",10,10,100,
30,e);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Labels",10,10,100,30,f);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Font",10,10,100,30,g);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Marks",10,10,100,30,h);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Mouse",10,10,100,30,k);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Selected",10,10,100,30,a);b.Tabs.push(d);CMDialogSettings.HidePanels(b);b.Panels[0].style.visibility="visible";return b};
CMDialogSettings.ShowSettingsDialogForStyle=function(a){var b=new CMDialog("LayerVector_Settings_Dialog",600,400);b.SuperClass_SetVisible=b.SetVisible;b.SetVisible=function(a){this.SuperClass_SetVisible(a);!1===a&&CMDialogSettings.HidePanels(this)};null==a&&(a={});a=document.createElement("UL");b.TheElement.appendChild(a);var c=CMDialogSettings.AddPenPanel(b,TheLayer,CMLayer.LABEL_STYLE);c.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(c,10,40,500,500);var d=CMDialogSettings.AddFontPanel(b,
TheLayer);d.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(d,10,40,500,500);b.Panels=[];b.Tabs=[];b.Panels.push(c);b.Panels.push(d);TheTab=CMDialogSettings.AddTab(a,b,"Labels",10,10,100,30,c);b.Tabs.push(TheTab);TheTab=CMDialogSettings.AddTab(a,b,"Font",10,10,100,30,d);b.Tabs.push(TheTab);CMDialogSettings.HidePanels(b);b.Panels[0].style.visibility="visible";return b};CMItem.SettingDefintions={Style:{strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},lineWidth:{Name:"Line Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",
Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y",Type:CMBase.DATA_TYPE_FLOAT,Default:1}},Text:{Text:{Name:"Text",Type:CMBase.DATA_TYPE_STRING,Default:null},font:{Name:"Font",Type:CMBase.DATA_TYPE_FONT,Default:"12px Arial"},strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},fillStyle:{Name:"Fill Style",
Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"}}};CMItem.UniqueNumber=0;
function CMItem(){CMBase.call(this);this.UniqueNumber=CMItem.UniqueNumber;this.TimeSlices=[{UniqueNumber:CMItem.UniqueNumber,Time:0,Settings:{Style:{strokeStyle:"rgb(0,0,0)",lineWidth:1,fillStyle:"rgb(255,255,255)"},Text:{}}}];CMItem.UniqueNumber++;this.LastStyle=null;this.LastTimeSlice=0}CMItem.prototype=Object.create(CMBase.prototype);CMItem.prototype.contructor=CMItem;
CMItem.prototype.GetSettingsDefinitions=function(){var a={};for(Key in CMItem.SettingDefintions)a[Key]=CMItem.SettingDefintions[Key];return a};CMItem.prototype.GetSettings=function(a){var b=null;a=CMItem.FindTimeSliceIndex(this.TimeSlices,a);-1!=a&&(b=this.TimeSlices[a].Settings);return b};CMItem.prototype.SetSettings=function(a,b){var c=0;void 0!=b&&(c=CMItem.FindTimeSliceIndex(this.TimeSlices,b));-1!=c&&(this.TimeSlices[c].Settings=a);this.LastStyle=null;this.Repaint()};
CMItem.prototype.SetSettingGroup=function(a,b,c){var d=0;void 0!=c&&(d=CMItem.FindTimeSliceIndex(this.TimeSlices,c));-1!=d&&(this.TimeSlices[d].Settings[a]=b);this.LastStyle=null;this.Repaint()};CMItem.prototype.GetSettingGroup=function(a,b,c){var d=null;void 0!=b&&(d=b);b=0;void 0!=c&&(b=CMItem.FindTimeSliceIndex(this.TimeSlices,c));-1!=b&&(d=this.TimeSlices[b].Settings[a]);return d};
CMItem.prototype.SetSetting=function(a,b,c,d){var e=0;void 0!=d&&(e=CMItem.FindTimeSliceIndex(this.TimeSlices,d));-1!=e&&(this.TimeSlices[e].Settings[a][b]=c);this.LastStyle=null;this.Repaint()};CMItem.prototype.GetSetting=function(a,b,c,d){var e=null;void 0!=c&&(e=c);c=0;void 0!=d&&(c=CMItem.FindTimeSliceIndex(this.TimeSlices,d));-1!=c&&(a=this.TimeSlices[c].Settings[a],void 0!=a&&b in a&&(e=a[b]));return e};CMItem.prototype.UnselectAll=function(a){this.Selected&&(this.Selected=!1,a&&this.GetParent(CMScene).SelectionChanged(this))};
CMItem.prototype.GetSelected=function(){return this.Selected};CMItem.prototype.SetSelected=function(a){if(this.Selected!=a){var b=this instanceof CMScene?this:this.GetParent(CMScene);a?(b.UnselectAll(!1),this.Selected=!0):this.Selected=!1;b.SelectionChanged(this)}};CMItem.FindTimeSliceIndex=function(a,b){var c=-1;if(void 0==b)0<a.length&&(c=0);else for(var d=0;d<a.length&&-1==c;d++)a[d].Time==b&&(c=d);return c};
CMItem.prototype.GetTimes=function(a){a=[];for(var b=0;b<this.TimeSlices.length;b++)CMUtilities.InsertIntoSortedArray(a,parseFloat(this.TimeSlices[b].Time));return a};CMItem.prototype.InsertTime=function(a){for(var b=this.TimeSlices,c=-1,d=0;d<b.length;d++)b[d].Time==a?c=d:b[d].Time>a&&(c=d,b.splice(c,0,a));-1==c&&(c=b.length,b.push({Settings:{},Time:a}));if(-1!=c)for(ClassKey in a=b[c-1].Settings,b=b[c].Settings,a)d=a[ClassKey],d=CMUtilities.Clone(d),b[ClassKey]=d;this.Repaint();return c};
CMItem.prototype.DeleteTime=function(a){for(var b=this.TimeSlices,c=-1,d=0;d<b.length;d++)b[d].Time==a&&(c=d,b.splice(c,1));this.Repaint();return c};CMItem.GetTimeFactor=function(a){a=a[1].Time-a[0].Time;return(a-TimeSlice)/a};CMItem.GetTweenFloatValue=function(a,b,c,d){void 0!=a?c=void 0!=b?a*d+b*(1-d):a:void 0!=b&&(c=b);return c};
CMItem.GetTweenColorValue=function(a,b,c,d){var e=null;void 0!=a?(e=CMUtilities.GetColorsFromAnyColor(a),void 0!=b?(a=CMUtilities.GetColorsFromAnyColor(b),e={Red:Math.round(e.Red*d+a.Red*(1-d)),Green:Math.round(e.Green*d+a.Green*(1-d)),Blue:Math.round(e.Blue*d+a.Blue*(1-d))}):e=a):void 0!=b&&(e=b);null!=e&&(c="rgb("+e.Red+","+e.Green+","+e.Blue+")");return c};CMItem.GetTweenStyleValue=function(a,b,c,d){return CMItem.GetTweenColorValue(a,b,c,d)};
CMItem.prototype.GetBoundingTimeSlices=function(a){void 0==a&&(a=this.GetParent(CMScene).GetTimeRange());for(var b=null,c=null,d=0;d<this.TimeSlices.length&&null==b;d++){var e=parseFloat(this.TimeSlices[d].Time);e==a?b=this.TimeSlices[d]:e>a&&(0==d?b=this.TimeSlices[0]:(b=this.TimeSlices[d-1],c=this.TimeSlices[d]))}null==b&&0<this.TimeSlices.length&&(b=this.TimeSlices[this.TimeSlices.length-1]);return[b,c]};
CMItem.prototype.GetStyle=function(a,b,c){void 0==b&&(b=0);void 0==c&&(c="Style");this.LastStyle=null;this.LastTimeSlice=b;a=this.GetBoundingTimeSlices(b);var d=a[0];b=d.Settings;var e=a[1];if(null!=d){var f;if(null==e)for(TheSettingKey1 in b=b[c],b)void 0===f&&(f={}),c=b[TheSettingKey1],f[TheSettingKey1]=c;else for(TheSettingKey1 in d=e.Settings,a=CMItem.GetTimeFactor(a),b=b[c],d=d[c],b)void 0===f&&(f={}),c=b[TheSettingKey1],e=d[TheSettingKey1],f[TheSettingKey1]="strokeStyle"==TheSettingKey1||"fillStyle"==
TheSettingKey1?CMItem.GetTweenStyleValue(c,e,"rgb(0,0,0)",a):"shadowColor"==TheSettingKey1?CMItem.GetTweenColorValue(c,e,"rgb(0,0,0)",a):CMItem.GetTweenFloatValue(c,e,0,a);for(key in f);this.LastStyle=f}return this.LastStyle};CMItem.prototype.ResetStyle=function(){};CMItem.prototype.Repaint=function(){var a=this.GetParent(CMScene);null!=a&&a.Repaint()};CMItem.prototype.Paint=function(a){};CMItem.prototype.PaintSelected=function(a){};
CMItem.prototype.SetVisible=function(a){this.Visible!=a&&(this.Visible=a,this.Repaint())};CMItem.prototype.GetVisible=function(){void 0==this.Visible&&(this.Visible=!0);return this.Visible};CMItemPoly.SettingDefintions={Curve:{Coordinates:{Name:"Coordinates",Type:CMBase.DATA_TYPE_COORDINATES,Default:null}}};function CMItemPoly(){CMItem.call(this);this.Anchor=null;this.Creating=this.Dragging=!1;this.SelectedPart=-1;this.TimeSlices[0].Settings.Curve={Coordinates:{Xs:[0,10,20,30,40,50],Ys:[0,10,20,30,40,50]}}}CMItemPoly.prototype=Object.create(CMItem.prototype);CMItemPoly.prototype.contructor=CMItemPoly;
CMItemPoly.prototype.GetAnchor=function(a,b,c,d){var e=this.GetParent(CMScene).GetTimeRange();a.GetRefWidthFromPixelWidth(3);a=this.GetControlPoints(e);return{X:c-a.Ys[d],Y:b-a.Xs[d]}};CMItemPoly.prototype.GetName=function(){return"Curve"};CMItemPoly.prototype.CMItem_GetSettingsDefinitions=CMItem.prototype.GetSettingsDefinitions;
CMItemPoly.prototype.GetSettingsDefinitions=function(){var a=this.CMItem_GetSettingsDefinitions();for(Key in CMItemPoly.SettingDefintions)a[Key]=CMItemPoly.SettingDefintions[Key];return a};
CMItemPoly.prototype.MouseDown=function(a,b,c,d){var e=!1;if(0==e&&this.Creating){e=this.GetParent(CMScene).GetTimeRange();var f=this.GetControlPoints(e),g=f.Xs.length;2==d.detail?(this.Dragging=this.Creating=!1,f.Xs.pop(),f.Ys.pop()):(f.Xs.splice(g-1,0,b),f.Ys.splice(g-1,0,c));this.SetControlPoints(e,f.Xs,f.Ys);e=!0;this.Repaint()}0!=e||a.GetTool()!=CMView.TOOL_INFO&&a.GetTool()!=CMView.TOOL_SELECT||(d=this.InPart(a,b,c,3),-1!=d&&(this.Dragging=!0,this.SelectedPart=d,this.Anchor=this.GetAnchor(a,
b,c,d),e=!0));return e};CMItemPoly.prototype.MouseMove=function(a,b,c,d){d=this.GetParent(CMScene).GetTimeRange();this.Creating?(a=this.GetControlPoints(d),d=a.Xs.length,a.Xs[d-1]=b,a.Ys[d-1]=c,this.Repaint()):this.Dragging?(a=this.GetControlPoints(d),a.Xs[this.SelectedPart]=b+this.Anchor.X,a.Ys[this.SelectedPart]=c+this.Anchor.Y,this.Repaint()):-1!==this.InPart(a,b,c,3)&&(this.GetParent().GetCanvasMap().GetElement(CMMainContainer.CANVAS).style.cursor="move");return!1};
CMItemPoly.prototype.MouseUp=function(a,b,c,d){a=!1;this.Dragging&&0==this.Creating&&(this.Dragging=!1,a=!0);return a};CMItemPoly.prototype.StartCreating=function(a,b){this.Anchor={X:0,Y:0};this.SelectedPart=CMItem.PART_LOWER_RIGHT;this.Creating=this.Dragging=!0};
CMItemPoly.prototype.Paint=function(a){var b=this.GetTweenedControlPoints(),c=b.Xs;b=b.Ys;var d=this.GetParent(CMScene).GetTimeRange();var e=this.GetStyle(a,d);void 0!=e&&a.SetStyle(e,!0);if(!(1>=c.length))if(2==c.length)a.PaintRefLine(c[0],b[0],c[1],b[1]);else{var f=CMUtilityBezier.GetSecondOrderEndPoints3D(10,c[0],b[0],0,c[1],b[1],0,c[2],b[2],0);d=f[0].length;a.PaintRefLine(c[0],b[0],f[0][0],f[1][0]);for(var g=0;g<d-1;g++)a.PaintRefLine(f[0][g],f[1][g],f[0][g+1],f[1][g+1]);a.PaintRefLine(f[0][d-
1],f[1][d-1],c[1],b[1]);for(var h=1;h<c.length-2;h++){f=CMUtilityBezier.GetSecondOrderPoints2D(10,c[h-1],b[h-1],c[h],b[h],c[h+1],b[h+1],c[h+2],b[h+2]);d=f[0].length;a.PaintRefLine(c[h],b[h],f[0][0],f[1][0]);for(g=0;g<d-1;g++)a.PaintRefLine(f[0][g],f[1][g],f[0][g+1],f[1][g+1]);a.PaintRefLine(f[0][d-1],f[1][d-1],c[h+1],b[h+1])}h=c.length-1;f=CMUtilityBezier.GetSecondOrderEndPoints3D(10,c[h],b[h],0,c[h-1],b[h-1],0,c[h-2],b[h-2],0);d=f[0].length;a.PaintRefLine(f[0][d-1],f[1][d-1],c[h-1],b[h-1]);for(g=
0;g<d-1;g++)a.PaintRefLine(f[0][g],f[1][g],f[0][g+1],f[1][g+1]);a.PaintRefLine(f[0][0],f[1][0],c[h],b[h])}void 0!=e&&a.RestoreStyle()};CMItemPoly.prototype.PaintSelected=function(a){if(this.Selected){a.SaveStyle();a.SetStyle({fillStyle:"rgba(0,0,0,1)",strokeStyle:"white"});var b=this.GetParent(CMScene).GetTimeRange(),c=this.GetControlPoints(b);if(null!=c){b=c.Xs;c=c.Ys;for(var d=0;d<b.length;d++)a.PaintRefCircle(b[d],c[d],5)}a.RestoreStyle()}};
CMItemPoly.prototype.GetControlPoints=function(a){a=this.GetBoundingTimeSlices(a);Settings=a[0].Settings;void 0!=Settings&&(a={Xs:Settings.Curve.Coordinates.Xs,Ys:Settings.Curve.Coordinates.Ys});return a};CMItemPoly.prototype.SetControlPoints=function(a,b,c){Settings=this.GetBoundingTimeSlices(a)[0].Settings;void 0!=Settings?(Settings.Curve.Coordinates.Xs=b,Settings.Curve.Coordinates.Ys=c):alert("Sorry, time slice "+a+" is not defined")};
CMItemPoly.prototype.GetTweenedControlPoints=function(){var a=[],b=[];this.GetParent(CMMainContainer);var c=this.GetParent(CMScene).GetTimeRange();var d=this.GetBoundingTimeSlices(c);c=d[0].Time;if(null==d[1])d=this.GetControlPoints(c),a=d.Xs,b=d.Ys;else{CMItem.GetTimeFactor(d);d=this.GetControlPoints(c);c=d.Xs;var e=d.Ys;d=this.GetControlPoints(TheTime2);var f=d.Xs;d=d.Ys;for(var g=0;g<c.length;g++)a[g]=c[g]*Factor1+f[g]*Factor2,b[g]=e[g]*Factor1+d[g]*Factor2}return{Xs:a,Ys:b}};
CMItemPoly.prototype.InPart=function(a,b,c,d){var e=-1,f=this.GetParent(CMScene).GetTimeRange();a=a.GetRefWidthFromPixelWidth(d);d=this.GetControlPoints(f);if(null!=d){f=d.Xs;d=d.Ys;for(var g=0;g<f.length;g++){var h=d[g];Math.abs(f[g]-b)<a&&Math.abs(h-c)<a&&(e=g)}}return e};CMItemPolyArrow.NUM_STEPS=30;CMItemPolyArrow.SettingDefintions={Arrow:{BarbX:{Name:"Barb Width",Type:CMBase.DATA_TYPE_INTEGER,Default:2},BarbY:{Name:"Barb Length",Type:CMBase.DATA_TYPE_INTEGER,Default:3},NotchX:{Name:"Shaft Width",Type:CMBase.DATA_TYPE_INTEGER,Default:.5},NotchY:{Name:"Head Length",Type:CMBase.DATA_TYPE_INTEGER,Default:2}}};
function CMItemPolyArrow(){CMItemPoly.call(this);this.BarbDX=2;this.BarbDY=3;this.NotchDX=.5;this.NotchDY=2;this.Type=CMLayerItems.ARROW;this.SpineYs=this.SpineXs=this.FinalYs=this.FinalXs=null;this.TimeSlices[0].Settings.Arrow={BarbX:3,BarbY:2,NotchX:3,NotchY:2}}CMItemPolyArrow.prototype=Object.create(CMItemPoly.prototype);CMItemPolyArrow.prototype.contructor=CMItemPolyArrow;CMItemPolyArrow.prototype.ResetCoordinates=function(){this.FinalYs=this.FinalXs=null};
CMItemPolyArrow.prototype.InitializeCoordinates=function(){null==this.FinalXs&&this.FindCoordinates()};function FindBannerPoints(a,b,c,d,e,f,g){c=e-c;d=f-d;f=Math.sqrt(c*c+d*d);c=c/f*g;d=d/f*g;return[{X:a+d,Y:b-c},{X:a-d,Y:b+c}]}function GetPointsOffLine(a,b,c,d,e){var f=Math.sin(c);c=Math.cos(c);return Result={RightX:a-f*e-c*d,RightY:b-c*e+f*d,LeftX:a-f*e+c*d,LeftY:b-c*e-f*d}}
CMItemPolyArrow.prototype.FindCoordinates=function(){var a=this.GetTweenedControlPoints();var b=a.Xs,c=a.Ys,d=b.length-1,e=[],f=[];e.push(b[0]);f.push(c[0]);var g=CMUtilityBezier.GetSecondOrderEndPoints3D(CMItemPolyArrow.NUM_STEPS,b[0],c[0],0,b[1],c[1],0,b[2],c[2],0);for(a=0;a<g[0].length;a++)e.push(g[0][a]),f.push(g[1][a]);for(var h=1;h<b.length-1;h++){e.push(b[h]);f.push(c[h]);var k=CMUtilityBezier.GetSecondOrderPoints2D(CMItemPolyArrow.NUM_STEPS,b[h-1],c[h-1],b[h],c[h],b[h+1],c[h+1],b[h+2],c[h+
2]);for(a=0;a<k[0].length;a++)e.push(k[0][a]),f.push(k[1][a])}e.push(b[d-1]);f.push(c[d-1]);k=CMUtilityBezier.GetSecondOrderEndPoints3D(CMItemPolyArrow.NUM_STEPS,b[d],c[d],0,b[d-1],c[d-1],0,b[d-2],c[d-2],0);for(a=k[0].length-1;0<=a;a--)e.push(k[0][a]),f.push(k[1][a]);this.SpineXs=e;this.SpineYs=f;var l=0,m=b[d],p=c[d];h=e.length-1;for(a=0;a<k[0].length&&l<this.NotchDX;a++)l+=CMUtilities.GetLength(m,p,k[0][a],k[1][a]),h--,m=k[0][a],p=k[1][a];0<h&&h--;var q=Math.atan2(b[d]-k[0][0],c[d]-k[1][0]);a=GetPointsOffLine(b[d],
c[d],q,this.BarbDX,this.BarbDY);k=a.RightX;l=a.RightY;m=a.LeftX;p=a.LeftY;a=GetPointsOffLine(b[d],c[d],q,this.NotchDX,this.NotchDY);q=a.RightX;var n=a.RightY,r=a.LeftX,w=a.LeftY,v=[],y=[],u=[],z=[];g=FindBannerPoints(b[0],c[0],b[0],c[0],g[0][1],g[1][1],this.NotchDX);v.push(g[0].X);y.push(g[0].Y);u.push(g[1].X);z.push(g[1].Y);for(a=0;a<h;a++)g=FindBannerPoints(e[a],f[a],e[a],f[a],e[a+1],f[a+1],this.NotchDX),v.push(g[0].X),y.push(g[0].Y),u.push(g[1].X),z.push(g[1].Y);e=[];f=[];for(a=0;a<u.length;a++)e.push(u[a]),
f.push(z[a]);e.push(q);f.push(n);e.push(k);f.push(l);e.push(b[d]);f.push(c[d]);e.push(m);f.push(p);e.push(r);f.push(w);for(a=0;a<v.length;a++)e.push(v[v.length-a-1]),f.push(y[y.length-a-1]);e.push(e[0]);f.push(f[0]);this.FinalXs=e;this.FinalYs=f};
CMItemPolyArrow.prototype.Private_SetupProperties=function(a,b){var c=this.GetBoundingTimeSlices(b);a=c[0].Settings;this.BarbDX=a.Arrow.BarbX;this.BarbDY=a.Arrow.BarbY;this.NotchDX=a.Arrow.NotchX;this.NotchDY=a.Arrow.NotchY;null!=c[1]&&(b=c[1].Settings,c=CMItem.GetTimeFactor(c),this.BarbDX=a.Arrow.BarbX*(1-c)+b.Arrow.BarbX*c,this.BarbDY=a.Arrow.BarbY,this.NotchDX=a.Arrow.NotchX,this.NotchDY=a.Arrow.NotchY)};CMItemPolyArrow.prototype.GetName=function(){return"Arrow"};
CMItemPolyArrow.prototype.CMItemPoly_GetSettingsDefinitions=CMItemPoly.prototype.GetSettingsDefinitions;CMItemPolyArrow.prototype.GetSettingsDefinitions=function(){var a=this.CMItemPoly_GetSettingsDefinitions();for(Key in CMItemPolyArrow.SettingDefintions)a[Key]=CMItemPolyArrow.SettingDefintions[Key];return a};
CMItemPolyArrow.prototype.Paint=function(a){this.InitializeCoordinates();var b=this.GetParent(CMScene).GetTimeRange();this.Private_SetupProperties(a,b);this.FindCoordinates();b=this.GetStyle(a,b);void 0!=b&&a.SetStyle(b,!0);a.PaintRefPoly2(this.FinalXs,this.FinalYs,!0,!0);void 0!=b&&a.RestoreStyle()};CMItemPolyArrow.prototype.CMItemPoly_SetControlPoints=CMItemPoly.prototype.SetControlPoints;CMItemPolyArrow.prototype.SetControlPoints=function(a,b,c){this.CMItemPoly_SetControlPoints(a,b,c);this.ResetCoordinates()};CMItemRect.RECTANGLE=0;CMItemRect.OVAL=1;CMItemRect.ROUNDED_RECTANGLE=2;CMItemRect.PART_UPPER_LEFT=0;CMItemRect.PART_UPPER_RIGHT=1;CMItemRect.PART_LOWER_RIGHT=2;CMItemRect.PART_LOWER_LEFT=3;CMItemRect.PART_TOP=4;CMItemRect.PART_RIGHT=5;CMItemRect.PART_BOTTOM=6;CMItemRect.PART_LEFT=7;CMItemRect.PART_INSIDE=8;
CMItemRect.SettingDefintions={Rectangle:{Coordinates:{Name:"Coordinates",Type:CMBase.DATA_TYPE_COORDINATES,Default:null}},RoundedRectangle:{RoundedCornerWidth:{Name:"Corner Width",Type:CMBase.DATA_TYPE_FLOAT,Default:3},RoundedCornerHeight:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:3}}};
function CMItemRect(a){CMItem.call(this);this.Type=a;switch(a){case CMItemRect.RECTANGLE:this.Name="Rectangle";break;case CMItemRect.OVAL:this.Name="Oval";break;case CMItemRect.ROUNDED_RECTANGLE:this.Name="Rounded Rectangle"}this.Anchor=null;this.Dragging=!1;this.TimeSlices[0].Settings.Rectangle={Coordinates:{Xs:[0,10],Ys:[0,10]}};this.TimeSlices[0].Settings.RoundedRectangle={RoundedCornerWidth:3,RoundedCornerHeight:3}}CMItemRect.prototype=Object.create(CMItem.prototype);
CMItemRect.prototype.contructor=CMItemRect;CMItemRect.prototype.GetName=function(){return this.Name};CMItemRect.prototype.CMItem_GetSettingsDefinitions=CMItem.prototype.GetSettingsDefinitions;CMItemRect.prototype.GetSettingsDefinitions=function(){var a=this.CMItem_GetSettingsDefinitions();for(Key in CMItemRect.SettingDefintions)a[Key]=CMItemRect.SettingDefintions[Key];return a};
CMItemRect.prototype.GetControlBounds=function(){var a=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;return{XMin:a.Xs[0],XMax:a.Xs[1],YMin:a.Ys[0],YMax:a.Ys[1]}};CMItemRect.prototype.SetControlBounds=function(a,b,c,d){var e=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;e.Xs[0]=a;e.Xs[1]=b;e.Ys[0]=c;e.Ys[1]=d};
CMItemRect.prototype.GetAnchor=function(a,b,c){var d=0,e=0,f=this.GetControlBounds();switch(c){case CMItemRect.PART_LOWER_LEFT:e=a-f.XMin;d=b-f.YMin;break;case CMItemRect.PART_UPPER_LEFT:e=a-f.XMin;d=b-f.YMax;break;case CMItemRect.PART_LEFT:e=a-f.XMin;break;case CMItemRect.PART_LOWER_RIGHT:e=a-f.XMax;d=b-f.YMin;break;case CMItemRect.PART_UPPER_RIGHT:e=a-f.XMax;d=b-f.YMax;break;case CMItemRect.PART_RIGHT:e=a-f.XMax;break;case CMItemRect.PART_TOP:d=b-f.YMax;break;case CMItemRect.PART_BOTTOM:d=b-f.YMin;
break;case CMItemRect.PART_INSIDE:e=a-f.XMin,d=b-f.YMin}return{X:e,Y:d}};
CMItemRect.prototype.InPart=function(a,b,c,d){var e=-1;a=a.GetRefWidthFromPixelWidth(d);d=this.GetControlBounds();b<d.XMax+a&&b>d.XMin-a&&c<d.YMax+a&&c>d.YMin-a&&(b<d.XMin+a?(e=c<d.YMin+a?CMItemRect.PART_LOWER_LEFT:c>d.YMax-a?CMItemRect.PART_UPPER_LEFT:CMItemRect.PART_LEFT,d.AnchorX=b-d.XMin):e=b>d.XMax-a?c<d.YMin+a?CMItemRect.PART_LOWER_RIGHT:c>d.YMax-a?CMItemRect.PART_UPPER_RIGHT:CMItemRect.PART_RIGHT:c>d.YMax-a?CMItemRect.PART_TOP:c<d.YMin+a?CMItemRect.PART_BOTTOM:CMItemRect.PART_INSIDE);return e};
CMItemRect.prototype.SetXMin=function(a){var b=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;b.Xs[0]=a;b.Xs[0]>b.Xs[1]&&(b.Xs[0]=b.Xs[1])};CMItemRect.prototype.SetXMax=function(a){var b=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;b.Xs[1]=a;b.Xs[1]<b.Xs[0]&&(b.Xs[1]=b.Xs[0])};CMItemRect.prototype.SetYMin=function(a){var b=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;b.Ys[0]=a;b.Ys[0]>b.Ys[1]&&(b.Ys[0]=b.Ys[1])};
CMItemRect.prototype.SetYMax=function(a){var b=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;b.Ys[1]=a;b.Ys[1]<b.Ys[0]&&(b.Ys[1]=b.Ys[0])};CMItemRect.prototype.MouseDown=function(a,b,c,d){a=this.InPart(a,b,c,4);-1!=a&&(this.Dragging=!0,this.SelectedPart=a,this.Anchor=this.GetAnchor(b,c,a))};
CMItemRect.prototype.MouseMove=function(a,b,c,d){d=!1;if(this.Dragging){d=this.Anchor;switch(this.SelectedPart){case CMItemRect.PART_UPPER_LEFT:this.SetXMin(b+d.X);this.SetYMax(c+d.Y);break;case CMItemRect.PART_UPPER_RIGHT:this.SetXMax(b+d.X);this.SetYMax(c+d.Y);break;case CMItemRect.PART_LOWER_RIGHT:this.SetXMax(b+d.X);this.SetYMin(c+d.Y);break;case CMItemRect.PART_LOWER_LEFT:this.SetXMin(b+d.X);this.SetYMin(c+d.Y);break;case CMItemRect.PART_TOP:this.SetYMax(c+d.Y);break;case CMItemRect.PART_RIGHT:this.SetXMax(b+
d.X);break;case CMItemRect.PART_BOTTOM:this.SetYMin(c+d.Y);break;case CMItemRect.PART_LEFT:this.SetXMin(b+d.X);break;case CMItemRect.PART_INSIDE:a=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;var e=a.Xs[1]-a.Xs[0],f=a.Ys[1]-a.Ys[0];a.Xs[0]=b-d.X;a.Ys[0]=c-d.Y;a.Xs[1]=b+e-d.X;a.Ys[1]=c+f-d.Y}d=!0;this.Repaint()}else switch(b=this.InPart(a,b,c),c=this.GetParent().GetCanvasMap().GetElement(CMMainContainer.CANVAS),c.style.cursor="crosshair",b){case CMLayerItems.PART_UPPER_LEFT:c.style.cursor=
"nw-resize";break;case CMLayerItems.PART_UPPER_RIGHT:c.style.cursor="ne-resize";break;case CMLayerItems.PART_LOWER_RIGHT:c.style.cursor="se-resize";break;case CMLayerItems.PART_LOWER_LEFT:c.style.cursor="sw-resize";break;case CMLayerItems.PART_TOP:case CMLayerItems.PART_BOTTOM:c.style.cursor="s-resize";break;case CMLayerItems.PART_RIGHT:case CMLayerItems.PART_LEFT:c.style.cursor="e-resize";break;case CMLayerItems.PART_INSIDE:c.style.cursor="move"}return d};
CMItemRect.prototype.MouseUp=function(a,b,c,d){a=!1;this.Dragging&&(this.Dragging=!1,a=!0);return a};
CMItemRect.prototype.Paint=function(a){var b=this.GetParent(CMScene).GetTimeRange(),c=this.GetStyle(a,b);void 0!=c&&a.SetStyle(c,!0);var d=this.GetControlBounds();switch(this.Type){case CMItemRect.RECTANGLE:a.PaintRefRect(d.XMin,d.XMax,d.YMin,d.YMax);break;case CMItemRect.OVAL:a.PaintRefArc(d.XMin,d.XMax,d.YMin,d.YMax,0,2*Math.PI);break;case CMItemRect.ROUNDED_RECTANGLE:b=this.GetBoundingTimeSlices(b)[0].Settings.RoundedRectangle,a.PaintRefRoundedRect(d.XMin,d.XMax,d.YMin,d.YMax,b.RoundedCornerWidth,
b.RoundedCornerHeight)}void 0!=c&&a.RestoreStyle()};CMItemRect.prototype.PaintSelected=function(a){if(this.GetSelected()){a.SaveStyle();a.SetStyle({fillStyle:"rgba(0,0,0,1)",strokeStyle:"white"});var b=this.GetControlBounds();a.PaintRefCircle(b.XMin,b.YMin,5);a.PaintRefCircle(b.XMin,b.YMax,5);a.PaintRefCircle(b.XMax,b.YMin,5);a.PaintRefCircle(b.XMax,b.YMax,5);a.RestoreStyle()}};
CMItemRect.prototype.StartCreating=function(a,b){this.Anchor={X:0,Y:0};this.SelectedPart=CMItemRect.PART_LOWER_RIGHT;this.Dragging=!0};CMLayer.MARK_CIRCLE=0;CMLayer.MARK_TRIANGLE=1;CMLayer.MARK_SQUARE=2;CMLayer.MARK_STAR=3;CMLayer.LabelDirections="TL T TR R BR B BL L".split(" ");
CMLayer.SettingDefintions={Layer:{InfoText:{Name:"Info Text",Type:CMBase.DATA_TYPE_STRING,Default:"Undefined"},MinZoom:{Name:"Min Zoom",Type:CMBase.DATA_TYPE_FLOAT,Default:0},MaxZoom:{Name:"Max Zoom",Type:CMBase.DATA_TYPE_FLOAT,Default:0}},Mark:{Type:{Name:"Type",Type:CMBase.DATA_TYPE_ENUMERATED,Options:[CMLayer.MARK_CIRCLE,CMLayer.MARK_TRIANGLE,CMLayer.MARK_SQUARE,CMLayer.MARK_STAR],Default:CMLayer.MARK_CIRCLE},Size:{Name:"Size",Type:CMBase.DATA_TYPE_FLOAT,Default:3}},IconImage:{URL:{Name:"URL",
Type:CMBase.DATA_TYPE_URL,Default:""},TheImage:{Name:"Image",Type:CMBase.DATA_TYPE_IMAGE,Default:null},OffsetX:{Name:"Offset X",Type:CMBase.DATA_TYPE_FLOAT,Default:0},OffsetY:{Name:"Offset Y",Type:CMBase.DATA_TYPE_FLOAT,Default:0}},LabelBox:{Position:{Name:"Position",Type:CMBase.DATA_TYPE_ENUMERATED,Options:"TL T TR R BR B BL L".split(" "),Default:"UR"},OffsetX:{Name:"Offset X",Type:CMBase.DATA_TYPE_FLOAT,Default:0},OffsetY:{Name:"Offset Y",Type:CMBase.DATA_TYPE_FLOAT,Default:0},strokeStyle:{Name:"Line Style",
Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},
shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1}},MouseOverStyle:{strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,0,0)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},
lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1}},
SelectedStyle:{strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,255)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",
Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1}}};
function CMLayer(){CMItem.call(this);this.TheBounds=null;this.Clickable=!0;this.Name=this.FeatureBounds=null;this.ClickTolerance=8;this.InfoWindowWidth=300;this.TimeSlices[0].Settings.Layer={};this.TimeSlices[0].Settings.Mark={};this.TimeSlices[0].Settings.IconImage={};this.TimeSlices[0].Settings.LabelBox={};this.TimeSlices[0].Settings.MouseOverStyle={};this.TimeSlices[0].Settings.SelectedStyle={strokeStyle:"rgb(120,100,255)",lineWidth:"3",fillStyle:"rgba(0,0,0,0)"};this.SettingsAttributes=this.FeatureSettings=
null}CMLayer.prototype=Object.create(CMItem.prototype);CMLayer.prototype.contructor=CMLayer;CMLayer.prototype.SettingsChanged=function(){};CMLayer.prototype.GetName=function(){return this.Name};CMLayer.prototype.CMItem_GetSettingsDefinitions=CMItem.prototype.GetSettingsDefinitions;CMLayer.prototype.GetSettingsDefinitions=function(){var a=this.CMItem_GetSettingsDefinitions();for(Key in CMLayer.SettingDefintions)a[Key]=CMLayer.SettingDefintions[Key];return a};
CMLayer.prototype.SetName=function(a){this.Name=a;null!=this.GetScene()&&this.GetScene().LayerSettingsChanged(this)};CMLayer.prototype.SetClickable=function(a){a!=this.Clickable&&(this.Clickable=a)};CMLayer.prototype.GetClickable=function(){return this.Clickable};CMLayer.prototype.IsVisible=function(){var a=this.GetVisible();if(a){var b=this.GetSetting("Layer","MinZoom"),c=this.GetSetting("Layer","MaxZoom");CMUtilities.IsDefined(b)&&(a=this.InZoomRange([b,c]))}return a};
CMLayer.prototype.InZoomRange=function(a){var b=!0,c=this.GetScene();null!=a&&null!=c&&null!=c.GetView(0)&&(c=c.GetView(0).GetZoomLevel(),c<a[0]||c>a[1])&&(b=!1);return b};CMLayer.prototype.IsFeatureVisible=function(a){var b=this.IsVisible();if(b){var c=this.GetFeatureSetting("Layer","MinZoom",a);a=this.GetFeatureSetting("Layer","MaxZoom",a);null!=c&&(b=this.InZoomRange([c,a]))}return b};CMLayer.prototype.SetBounds=function(a){this.TheBounds=a};CMLayer.prototype.GetBounds=function(){return this.TheBounds};
CMLayer.prototype.GetScene=function(){return this.GetParent(CMScene)};CMLayer.prototype.GetCanvasMap=function(){return this.GetParent(CMMainContainer)};CMLayer.prototype.SetInfoWindowWidth=function(a){this.InfoWindowWidth=a};CMLayer.prototype.GetInfoWindowWidth=function(){return this.InfoWindowWidth};CMLayer.prototype.SetClickTolerance=function(a){this.ClickTolerance=a};CMLayer.prototype.SetSelectedFeature=function(a){};CMLayer.prototype.SetMouseOverFeature=function(a){};
CMLayer.prototype.ResetMouseOverFeature=function(){};CMLayer.prototype.SetSettingAttribute=function(a,b,c){null==this.SettingsAttributes&&(this.SettingsAttributes={});0==a in this.SettingsAttributes&&(this.SettingsAttributes[a]={});this.SettingsAttributes[a][b]=c;this.SettingsDirty=!0};CMLayer.prototype.GetSettingsAttribute=function(a,b){var c=null;null!==this.SettingsAttributes&&a in this.SettingsAttributes&&(c=this.SettingsAttributes[a][b]);return c};
CMLayer.prototype.SetFeatureSettings=function(a,b){null==this.FeatureSettings&&(this.FeatureSettings=[]);this.FeatureSettings[a]=b};CMLayer.prototype.GetFeatureSettings=function(a,b){this.SettingsChanged();null!=this.FeatureSettings&&(b=this.FeatureSettings[a]);return b};
CMLayer.prototype.SetFeatureSettingGroup=function(a,b,c){null==this.FeatureSettings&&(this.FeatureSettings=[]);void 0==this.FeatureSettings[b]&&(this.FeatureSettings[b]={});void 0==this.FeatureSettings[b][a]&&(this.FeatureSettings[b][a]={});this.FeatureSettings[b][a]=c};CMLayer.prototype.GetFeatureSettingGroup=function(a,b,c){this.SettingsChanged();null!=this.FeatureSettings&&void 0!=this.FeatureSettings[b]&&void 0!=this.FeatureSettings[b][a]&&(c=this.FeatureSettings[b][a]);return c};
CMLayer.prototype.SetFeatureSetting=function(a,b,c,d){null==this.FeatureSettings&&(this.FeatureSettings=[]);void 0==this.FeatureSettings[c]&&(this.FeatureSettings[c]={});0==a in this.FeatureSettings[c]&&(this.FeatureSettings[c][a]={});this.FeatureSettings[c][a][b]=d};CMLayer.prototype.GetFeatureSetting=function(a,b,c,d){this.SettingsChanged();d=this.GetSetting(a,b,d);if(null!==this.FeatureSettings){var e=this.FeatureSettings[c];void 0!=e&&a in e&&(d=this.FeatureSettings[c][a][b])}return d};
CMLayer.prototype.SetIconImage=function(a,b,c){var d=new Image;d.Loaded=!1;d.TheURL=a;d.TheLayer=this;d.OffsetX=b;d.OffsetY=c;d.onload=function(){this.Loaded=!0;this.TheLayer.SetSetting("IconImage","URL",this.TheURL);this.TheLayer.SetSetting("IconImage","TheImage",this);this.TheLayer.SetSetting("IconImage","OffsetX",this.OffsetX);this.TheLayer.SetSetting("IconImage","OffsetY",this.OffsetY);this.TheLayer.Repaint()};d.src=a};
CMLayer.prototype.SetFeatureIconImage=function(a,b,c,d){var e=new Image;e.FeatureIndex=a;e.Loaded=!1;e.TheLayer=this;e.OffsetX=c;e.OffsetY=d;e.onload=function(){this.Loaded=!0;this.TheLayer.SetFeatureSetting("IconImage","URL",this.FeatureIndex,this.TheURL);this.TheLayer.SetFeatureSetting("IconImage","TheImage",this.FeatureIndex,this);this.TheLayer.SetFeatureSetting("IconImage","OffsetX",this.FeatureIndex,this.OffsetX);this.TheLayer.SetFeatureSetting("IconImage","OffsetY",this.FeatureIndex,this.OffsetY);
this.TheLayer.Repaint()};e.src=b};CMLayer.prototype.SetupLabelFont=function(a,b){b=this.GetFeatureSetting("Text","font",b,"Arial 12px");var c="20";if(null!=b&&void 0!=b){var d=b.indexOf("px");-1!=d&&(c=b.substring(0,d),d=c.lastIndexOf(" "),-1!=d&&(c=c.substring(d+1)),c=parseInt(c))}a.GetContext().font=b;return c};
CMLayer.prototype.PaintPoint=function(a,b,c,d,e){if(this.IsFeatureVisible(b)){this.SettingsChanged();var f=a.GetPixelFromRef(c,d);e=f.PixelX;f=f.PixelY;var g=this.GetSettingGroup("IconImage");g=this.GetFeatureSettingGroup("IconImage",b,g);if(void 0!==g.TheImage){var h={XMin:e+g.OffsetX,XMax:e+g.OffsetX+g.TheImage.width,YMin:f+g.OffsetY,YMax:f+g.OffsetY+g.TheImage.height};0==a.CheckCollision(h)&&(a.AddToCollisions(h),a.PaintImage(g.TheImage,e+g.OffsetX,f+g.OffsetY))}else{g=this.GetStyle(a);h=this.GetFeatureSettingGroup("Style",
h,g);null!==h&&a.SetStyle(h,!1);g=this.GetFeatureSetting("Mark","Size",b,5);var k=this.GetFeatureSetting("Mark","Type",b,CMLayer.MARK_CIRCLE),l=g/2;h={XMin:e-l,XMax:e+l,YMin:f-l,YMax:f+l};if(0==a.CheckCollision(h))switch(a.AddToCollisions(h),k){case CMLayer.MARK_CIRCLE:a.PaintCircle(e,f,l);break;case CMLayer.MARK_SQUARE:a.PaintRect(e-l,e+l,f-l,f+l);break;case CMLayer.MARK_TRIANGLE:h=a.GetRefWidthFromPixelWidth(g);h=CMUtilities.GetRegularPolygon(3,h/2,c,d,180);a.PaintRefPoly2(h[0],h[1],!0,!0);break;
case CMLayer.MARK_STAR:h=a.GetRefWidthFromPixelWidth(g),h=CMUtilities.GetStar(5,h,c,d,0),a.PaintRefPoly2(h[0],h[1],!0,!0)}}h=this.GetFeatureSetting("Text","Text",b,null);if(null!=h){c=this.GetStyle(a,0,"Text");void 0!=c&&a.SetStyle(c);d=this.SetupLabelFont(a,b);g=a.GetContext();var m=10,p=10;k=null;b=this.GetFeatureSetting("LabelBox","Position",b,null);null!=b&&(m=b.OffsetX,p=b.OffsetY,k=b.Direction);b=h.split("<br>");var q=b.length*d;l=[];var n=0;for(h=0;h<b.length;h++)b[h]=b[h].trim(),l.push(g.measureText(b[h]).width),
l[h]>n&&(n=l[h]);switch(k){case "TL":case "L":case "BL":e=e-m-n;break;default:e-=n/2;break;case "BR":case "TR":case "R":e+=p}switch(k){case "TL":case "T":case "TR":h=f-p-q;break;default:h=f-q/2;break;case "BR":case "B":case "BL":h=f+p}f=e;p=h+d;h={XMin:f,XMax:f+n,YMin:p-q,YMax:p};if(0==a.CheckCollision(h))for(a.AddToCollisions(h),g.textBaseline="bottom",h=0;h<b.length;h++){switch(k){case "TL":case "L":case "BL":f=e+n-l[h];break;default:f=e+(n-l[h])/2;break;case "BR":case "TR":case "R":f=e}g.fillText(b[h],
f,p);g.strokeText(b[h],f,p);p+=d}void 0!=c&&a.RestoreStyle()}}};CMLayer.prototype.PaintPoly=function(a,b,c,d,e){this.IsFeatureVisible(b)&&(b=e?this.GetStyle(a,0,"SelectedStyle"):this.GetFeatureSettingGroup("Style",b,null),null!==b&&a.SetStyle(b,!0),a.PaintRefPoly(c,d),null!==b&&a.RestoreStyle(b))};CMLayer.prototype.OnLoad=function(){this.SettingsChanged();null==this.GetScene()?alert("Sorry, you'll need to add the layer to the CanvasMap before you can all 'SetURL()'."):this.GetScene().SetBoundsDirty()};
CMLayer.prototype.ViewMoved=function(a){};CMLayer.prototype.In=function(a,b,c){return-1};CMLayer.prototype.MouseDown=function(a,b,c){var d=!1;if(this.IsVisible()&&this.GetClickable()&&(a.GetTool()==CMView.TOOL_INFO||a.GetTool()==CMView.TOOL_SELECT)){var e=this.In(a,b,c);-1!=e&&(this.SetSelectedFeature(e),this.ShowInfoWindow(e,a,b,c),d=!0)}return d};CMLayer.prototype.MouseMove=function(a,b,c){if(this.Clickable){var d=this.In(a,b,c);-1!==d?this.MouseOver(a,b,c,d):this.ResetMouseOverFeature()}return!1};
CMLayer.prototype.MouseUp=function(a,b,c){return!1};CMLayer.prototype.MouseOver=function(a,b,c,d){this.SetMouseOverFeature(d);return!1};CMLayer.prototype.Resize=function(a){};CMLayer.prototype.GetSearchResults=function(a,b){};CMLayer.prototype.ShowInfoWindow=function(a,b,c,d){a=this.GetFeatureSetting("Layer","InfoText",a,null);null!=a&&(b=b.CreateInfoWindow("CMLayer.InfoWindow",c,d,this.GetInfoWindowWidth(),30,a),CMMainContainer.SetPopupWindow(b))};
CMLayer.prototype.GetIcon=function(){var a=this.GetSetting("IconImage","TheImage");if(null==a){var b=this.GetSetting("Mark","Type",void 0),c=this.GetSetting("Style","fillStyle"),d=this.GetSetting("Style","strokeStyle");if(0==CMUtilities.IsDefined(b))a=document.createElement("div"),a.className="CM_LayerListIconClass",a.TheLayer=this,CMUtilities.IsDefined(c)?a.style.backgroundColor=c:a.style.backgroundColor=void 0,CMUtilities.IsDefined(d)?a.style.borderColor=d:a.style.borderColor=void 0;else{a=document.createElement("div");
a.className="CM_LayerListIconClass";a.TheLayer=this;a.style.backgroundColor="rgba(0,0,0,0)";a.style.borderColor="rgba(0,0,0,0)";var e=document.createElement("CANVAS");e.width=16;e.height=16;a.appendChild(e);var f=new CMView2D;f.Setup(a,e);f.SetStyle({fillStyle:c,strokeStyle:d});switch(b){case CMLayer.MARK_CIRCLE:f.PaintCircle(8,8,7);break;case CMLayer.MARK_SQUARE:f.PaintRect(1,14,1,14);break;case CMLayer.MARK_TRIANGLE:b=CMUtilities.GetRegularPolygon(3,9,8,-9,180);f.PaintRefPoly2(b[0],b[1],!0,!0);
break;case CMLayer.MARK_STAR:b=CMUtilities.GetStar(5,14,8,-8,36),f.PaintRefPoly2(b[0],b[1],!0,!0)}}}return a};
CMLayer.prototype.FillPopupMenu=function(a){var b=document.createElement("div");b.setAttribute("id","CM_DeleteElementMenuItem");b.className="CM_LayerListPopupMenuItem";b.innerHTML="Delete";b.TheLayer=this;b.ThePopupMenu=a;b.addEventListener("click",function(a){var b=this.TheLayer.GetParent(CMScene);this.ThePopupMenu.style.visibility="hidden";var c=b.GetLayerIndex(this.TheLayer);b.DeleteLayer(c);a.stopPropagation()});a.appendChild(b);null!=this.GetBounds()&&(b=document.createElement("div"),b.className=
"CM_LayerListPopupMenuItem",b.setAttribute("id","CM_ZoomToExtentMenuItem"),b.innerHTML="Zoom To This Layer",b.TheLayer=this,b.ThePopupMenu=a,b.addEventListener("click",function(a){this.ThePopupMenu.style.visibility="hidden";var b=this.TheLayer.GetBounds();this.TheLayer.GetParent(CMScene).GetView(0).ZoomToBounds(b);a.stopPropagation()}),a.appendChild(b))};function CMLayerDataset(){CMLayer.call(this);this.TheDataset=null}CMLayerDataset.prototype=Object.create(CMLayer.prototype);CMLayerDataset.prototype.contructor=CMLayerDataset;CMLayerDataset.prototype.CMLayer_SetParent=CMLayer.prototype.SetParent;CMLayerDataset.prototype.SetParent=function(a){this.CMLayer_SetParent(a);null!=this.TheDataset&&this.TheDataset.SetParent(this.GetParent(CMScene))};CMLayerDataset.prototype.CMLayer_UnselectAll=CMLayer.prototype.UnselectAll;
CMLayerDataset.prototype.UnselectAll=function(a){this.CMLayer_UnselectAll(a);null!=this.TheDataset&&-1!=this.TheDataset.GetSelectedFeature()&&(this.TheDataset.SetSelectedFeature(-1),a&&this.GetParent(CMScene).SelectionChanged(this))};CMLayerDataset.prototype.Paint=function(a){if(this.IsVisible()&&null!=this.TheDataset){var b=this.GetStyle(a);null!==b&&a.SetStyle(b);this.TheDataset.Paint(this,a,!1);null!==b&&a.RestoreStyle()}};
CMLayerDataset.prototype.PaintSelected=function(a){if(this.IsVisible()&&null!=this.TheDataset){var b=this.GetStyle(a,void 0,"MouseOverStyle");CMUtilities.IsDefined(b)&&(a.SetStyle(b),this.TheDataset.Paint(this,a,!1,!0),a.RestoreStyle());b=this.GetStyle(a,void 0,"SelectedStyle");CMUtilities.IsDefined(b)&&(a.SetStyle(b),this.TheDataset.Paint(this,a,!0),a.RestoreStyle())}};CMLayerDataset.prototype.SetBounds=function(a){void 0!=this.GetDataset()&&(this.GetDataset().SetBounds(a),this.GetParent(CMScene).SetBoundsDirty())};
CMLayerDataset.prototype.GetBounds=function(){var a=void 0;void 0!=this.GetDataset()&&(a=this.GetDataset().GetBounds());return a};CMLayerDataset.prototype.CMLayer_SettingsChanged=CMLayerDataset.prototype.SettingsChanged;
CMLayerDataset.prototype.SettingsChanged=function(){this.CMLayer_SettingsChanged();if(this.SettingsDirty&&null!=this.SettingsAttributes){var a=this.GetDataset(),b;for(b in this.SettingsAttributes){var c=this.SettingsAttributes[b],d;for(d in c)for(var e=c[d],f=0;f<a.GetNumAttributeRows();f++){var g=a.GetAttributeCellByHeading(e,f);if(void 0!==g&&""!==g){if("IconImage"==b&&"URL"==d){var h=new Image;h.Loaded=!1;h.TheLayer=this;h.onload=function(){this.Loaded=!0;this.TheLayer.Repaint()};h.src=g}else"Mark"==
b&&"Type"==d?("MARK_CIRCLE"===g&&(g=CMLayer.MARK_CIRCLE),"MARK_TRIANGLE"===g&&(g=CMLayer.MARK_TRIANGLE),"MARK_SQUARE"===g&&(g=CMLayer.MARK_SQUARE),"MARK_STAR"===g&&(g=CMLayer.MARK_STAR)):"Mark"==b&&"Size"==d&&(g=parseInt(g));this.SetFeatureSetting(b,d,f,g)}}}this.Repaint();this.SettingsDirty=!1}};CMLayerDataset.prototype.SetProjector=function(a){null!=this.TheDataset&&this.TheDataset.SetProjector(a)};
CMLayerDataset.prototype.SetSelectedFeature=function(a){null!=this.TheDataset&&a!=this.TheDataset.GetSelectedFeature()&&(this.TheDataset.SetSelectedFeature(a),this.GetParent(CMScene).SelectionChanged(this))};CMLayerDataset.prototype.SetMouseOverFeature=function(a){null!=this.TheDataset&&this.TheDataset.GetMouseOverFeature()!=a&&this.TheDataset.SetMouseOverFeature(a)};CMLayerDataset.prototype.ResetMouseOverFeature=function(){null!=this.TheDataset&&-1!=this.TheDataset.GetMouseOverFeature()&&this.TheDataset.SetMouseOverFeature(-1)};
CMLayerDataset.prototype.In=function(a,b,c){var d=-1;if(null!=this.TheDataset)for(var e=this.TheDataset.GetNumFeatures(),f=0;f<e&&-1==d;f++)this.TheDataset.InFeature(a,b,c,f)&&this.IsFeatureVisible(f)&&(d=f);return d};CMLayerDataset.prototype.GetSearchResults=function(a,b){null!=this.TheDataset&&this.TheDataset.GetSearchResults(a,b)};CMLayerDataset.prototype.CMLayer_GetIcon=CMLayer.prototype.GetIcon;
CMLayerDataset.prototype.GetIcon=function(){var a=this.CMLayer_GetIcon();null!=this.TheDataset&&(a=this.TheDataset.GetIcon(this,a));return a};
CMLayerDataset.prototype.SetURL=function(a,b,c,d){var e=this.GetParent(CMScene);this.TheDataset=CMDataset.GetDataObject(a,c);this.TheDataset.SetParent(e);this.TheDataset.AddListener(CMDataset.MESSAGE_DATASET_LOADED,this,function(a,b,c){b.OnLoad();b.GetScene().LayerListChanged()});this.TheDataset.AddListener(CMDataset.MESSAGE_DATASET_SELECTION_CHANGED,this,function(a,b,c){b.GetScene().Repaint()});this.TheDataset.AddListener(CMDataset.MESSAGE_DATASET_MOUSE_OVER_FEATURE_CHANGED,this,function(a,b,c){b.GetScene().Repaint()});
void 0!=d&&this.TheDataset.SetProjector(d);this.TheDataset.SetURL(a,b)};CMLayerDataset.prototype.SetData=function(a,b,c,d){b=this.GetParent(CMScene);this.TheDataset=CMDataset.GetDataObject(URL,c);this.TheDataset.SetParent(b);this.TheDataset.AddListener(CMDataset.MESSAGE_DATASET_LOADED,this,function(a,b,c){b.OnLoad()});void 0!=d&&this.TheDataset.SetProjector(d);this.TheDataset.SetData(a)};CMLayerDataset.prototype.GetDataset=function(){return this.TheDataset};
CMLayerDataset.prototype.SetDataset=function(a){this.TheDataset=a};CMLayerDataset.prototype.AddPoint=function(a,b){null!=this.TheDataset?this.TheDataset.AddPoint(a,b):alert("Sorry, a dataset must be set before we can add points to a layer")};function CMLayerGraticule(){CMLayer.call(this);this.Bounds=this.BoundsProjectedNorthings=this.BoundsProjectedEastings=null;this.BoundsSpacing=10;this.RightIntersectionCoordinates=this.LeftIntersectionCoordinates=this.BottomIntersectionCoordinates=this.TopIntersectionCoordinates=this.BoundsSouthCoordinates=this.BoundsNorthCoordinates=this.BoundsEastCoordinates=this.BoundsWestCoordinates=null;this.DesiredSpacingInPixels=200}CMLayerGraticule.prototype=Object.create(CMLayer.prototype);
CMLayerGraticule.prototype.contructor=CMLayerGraticule;CMLayerGraticule.DegreeQuantized=[30,15,10,5,2,1,.5,.25,1/6,1/12,1/30,1/60,1/120,1/240,1/360,1/720,1/1800,1/3600];CMLayerGraticule.prototype.In=function(a,b,c){return!1};CMLayerGraticule.SegmentIntersectsAVertical=function(a,b,c,d,e,f,g,h,k){a<e&&c<e||a>e&&c>e||b<g&&d<g||b>f&&d>f||(c==a?a==e&&h.push({Easting:e,Northing:f}):(c=(d-b)/(c-a),a=c*e+(b-c*a),a<f&&a>g&&h.push({Easting:e,Northing:a,Latitude:k})));return null};
CMLayerGraticule.SegmentIntersectsAHorizontal=function(a,b,c,d,e,f,g,h,k){a<e&&c<e||a>f&&c>f||b<g&&d<g||b>g&&d>g||(d==b?b==g&&h.push({Easting:e,Northing:g,Longitude:k}):(c=(d-b)/(c-a),a=(g-(b-c*a))/c,a>=e&&a<=f&&h.push({Easting:a,Northing:g,Longitude:k})));return null};CMLayerGraticule.GetPolyIntersectionsWithVertical=function(a,b,c,d,e,f){for(var g=null,h=0;h<a.length-1;h++)g=CMLayerGraticule.SegmentIntersectsAVertical(a[h],b[h],a[h+1],b[h+1],c,d,e,f);return g};
CMLayerGraticule.GetPolyIntersectionsWithHorizontal=function(a,b,c,d,e,f){for(var g=null,h=0;h<a.length-1;h++)g=CMLayerGraticule.SegmentIntersectsAHorizontal(a[h],b[h],a[h+1],b[h+1],c,d,e,f);return g};
CMLayerGraticule.prototype.SetupBoundsPoly=function(a){if(null===this.BoundsProjectedEastings){a=this.GetCanvasMap().GetProjector();null==a&&(a=new CMProjector);this.Bounds=a.GetBounds();this.BoundsProjectedEastings=[];this.BoundsProjectedNorthings=[];this.BoundsWestCoordinates=[];this.BoundsEastCoordinates=[];this.BoundsNorthCoordinates=[];this.BoundsSouthCoordinates=[];for(var b=this.Bounds.South;b<=this.Bounds.North;b+=this.BoundsSpacing){var c=a.ProjectFromGeographic(this.Bounds.West,b),d=a.ProjectFromGeographic(this.Bounds.East,
b);this.BoundsWestCoordinates.push(c);this.BoundsEastCoordinates.push(d)}for(b=this.Bounds.West;b<this.Bounds.East;b+=this.BoundsSpacing)c=a.ProjectFromGeographic(b,this.Bounds.North),d=a.ProjectFromGeographic(b,this.Bounds.South),this.BoundsNorthCoordinates.push(c),this.BoundsSouthCoordinates.push(d);for(b=0;b<this.BoundsWestCoordinates.length;b++)this.BoundsProjectedEastings.push(this.BoundsWestCoordinates[b].Easting),this.BoundsProjectedNorthings.push(this.BoundsWestCoordinates[b].Northing);for(b=
0;b<this.BoundsNorthCoordinates.length;b++)this.BoundsProjectedEastings.push(this.BoundsNorthCoordinates[b].Easting),this.BoundsProjectedNorthings.push(this.BoundsNorthCoordinates[b].Northing);for(b=0;b<this.BoundsEastCoordinates.length;b++)a=this.BoundsEastCoordinates.length-1-b,this.BoundsProjectedEastings.push(this.BoundsEastCoordinates[a].Easting),this.BoundsProjectedNorthings.push(this.BoundsEastCoordinates[a].Northing);for(b=0;b<this.BoundsSouthCoordinates.length;b++)a=this.BoundsSouthCoordinates.length-
1-b,this.BoundsProjectedEastings.push(this.BoundsSouthCoordinates[a].Easting),this.BoundsProjectedNorthings.push(this.BoundsSouthCoordinates[a].Northing)}};CMLayerGraticule.prototype.PaintMeridianSegment=function(a,b,c,d,e,f,g,h,k,l){a.PaintRefLine(b,c,d,e);CMLayerGraticule.SegmentIntersectsAHorizontal(b,c,d,e,f,g,h,this.TopIntersectionCoordinates,l);CMLayerGraticule.SegmentIntersectsAHorizontal(b,c,d,e,f,g,k,this.BottomIntersectionCoordinates,l)};
CMLayerGraticule.prototype.PaintParallelSegment=function(a,b,c,d,e,f,g,h,k,l){a.PaintRefLine(b,c,d,e);CMLayerGraticule.SegmentIntersectsAVertical(b,c,d,e,f,h,k,this.LeftIntersectionCoordinates,l);CMLayerGraticule.SegmentIntersectsAVertical(b,c,d,e,g,h,k,this.RightIntersectionCoordinates,l)};
CMLayerGraticule.prototype.Paint=function(a){if(this.IsVisible()){var b=this.GetCanvasMap().GetProjector();null==b&&(b=new CMProjector);this.SetupBoundsPoly(a);var c={fillStyle:"Red"};a.SetStyle(c);var d=a.GetCanvasElement(),e=a.GetRefXFromPixelX(0),f=a.GetRefXFromPixelX(d.width),g=a.GetRefYFromPixelY(0);d=a.GetRefYFromPixelY(d.height);var h=[];CMLayerGraticule.GetPolyIntersectionsWithVertical(this.BoundsProjectedEastings,this.BoundsProjectedNorthings,e,g,d,h);CMLayerGraticule.GetPolyIntersectionsWithVertical(this.BoundsProjectedEastings,
this.BoundsProjectedNorthings,f,g,d,h);CMLayerGraticule.GetPolyIntersectionsWithHorizontal(this.BoundsProjectedEastings,this.BoundsProjectedNorthings,e,f,g,h);CMLayerGraticule.GetPolyIntersectionsWithHorizontal(this.BoundsProjectedEastings,this.BoundsProjectedNorthings,e,f,d,h);CMUtilities.InsideAPolygon(e,g,this.BoundsProjectedEastings,this.BoundsProjectedNorthings,this.BoundsProjectedEastings.length)&&h.push({Easting:e,Northing:g});CMUtilities.InsideAPolygon(f,g,this.BoundsProjectedEastings,this.BoundsProjectedNorthings,
this.BoundsProjectedEastings.length)&&h.push({Easting:f,Northing:g});CMUtilities.InsideAPolygon(f,d,this.BoundsProjectedEastings,this.BoundsProjectedNorthings,this.BoundsProjectedEastings.length)&&h.push({Easting:f,Northing:d});CMUtilities.InsideAPolygon(e,d,this.BoundsProjectedEastings,this.BoundsProjectedNorthings,this.BoundsProjectedEastings.length)&&h.push({Easting:e,Northing:d});c=[e,f,f,e];var k=[g,g,d,d];SWCoordinate=this.BoundsWestCoordinates[0];NWCoordinate=this.BoundsWestCoordinates[this.BoundsWestCoordinates.length-
1];SECoordinate=this.BoundsEastCoordinates[0];NECoordinate=this.BoundsEastCoordinates[this.BoundsEastCoordinates.length-1];var l=CMUtilities.InsideAPolygon(NWCoordinate.Easting,NWCoordinate.Northing,c,k,c.length);var m=CMUtilities.InsideAPolygon(NECoordinate.Easting,NECoordinate.Northing,c,k,c.length);var p=CMUtilities.InsideAPolygon(SECoordinate.Easting,SECoordinate.Northing,c,k,c.length);k=CMUtilities.InsideAPolygon(SWCoordinate.Easting,SWCoordinate.Northing,c,k,c.length);c={fillStyle:"Green"};
a.SetStyle(c);l&&a.PaintRefCircle(NWCoordinate.Easting,NWCoordinate.Northing,10);m&&a.PaintRefCircle(NECoordinate.Easting,NECoordinate.Northing,10);p&&a.PaintRefCircle(SECoordinate.Easting,SECoordinate.Northing,10);k&&a.PaintRefCircle(SWCoordinate.Easting,SWCoordinate.Northing,10);c={fillStyle:"Blue"};a.SetStyle(c);for(c=0;c<h.length;c++)a.PaintRefCircle(h[c].Easting,h[c].Northing,10);c={fillStyle:"Red"};a.SetStyle(c);var q=[];for(c=0;c<h.length;c++){var n=b.ProjectToGeographic(h[c].Easting,h[c].Northing);
q.push(n)}c={fillStyle:"Black"};a.SetStyle(c);if(0<q.length){var r=q[0].Latitude;var w=q[0].Latitude;var v=q[0].Longitude;var y=q[0].Longitude;for(c=1;c<q.length;c++)q[c].Latitude<r&&(r=q[c].Latitude),q[c].Latitude>w&&(w=q[c].Latitude),q[c].Longitude<v&&(v=q[c].Longitude),q[c].Longitude>y&&(y=q[c].Longitude)}l|m&&(void 0==w||this.Bounds.North>w)&&(w=this.Bounds.North);k|p&&(void 0==r||this.Bounds.South<r)&&(r=this.Bounds.South);l|k&&(void 0==v||this.Bounds.West<v)&&(v=this.Bounds.West);m|p&&(void 0==
y||this.Bounds.East>y)&&(y=this.Bounds.East);h=(y+v)/2;l=(w+r)/2;c=y-v;m=h+c/10;h=b.ProjectFromGeographic(h-c/10,l);l=b.ProjectFromGeographic(m,l);c/=5;h=l.Easting-h.Easting;0>h&&(h=-h);h=a.GetPixelWidthFromRefWidth(h);c=c/h*this.DesiredSpacingInPixels;for(h=0;CMLayerGraticule.DegreeQuantized[h]>c&&h+1<CMLayerGraticule.DegreeQuantized.length;)h++;h+1<CMLayerGraticule.DegreeQuantized.length&&0>h&&h--;l=CMLayerGraticule.DegreeQuantized[h];m=Math.floor(v/l-1)*l;y=Math.ceil(y/l+1)*l;h=Math.floor(r/l-
1)*l;v=Math.ceil(w/l+1)*l;m<this.Bounds.West&&(m=this.Bounds.West);y>this.Bounds.East&&(y=this.Bounds.East);h<this.Bounds.South&&(h=this.Bounds.South);v>this.Bounds.North&&(v=this.Bounds.North);w=this.GetStyle(a);void 0!=w&&a.SetStyle(w);r=[];c=0;for(k=v;k>=h;k-=l){r[c]=[];p=0;for(q=m;q<y;q+=l){var u=b.ProjectFromGeographic(q,k);u.Longitude=q;u.Latitude=k;r[c][p]=u;p++}c++}if(0!=r.length){this.BottomIntersectionCoordinates=[];this.TopIntersectionCoordinates=[];q=m;p=r[0].length;b=r.length;for(var z=
0;z<p;z++){if(!(1>=r.length))if(2==r.length)a.PaintRefLine(r[0][z].Easting,r[0][z].Northing,r[1][z].Easting,r[1][z].Northing);else{try{var x=r[0][z];u=r[1][z];var t=r[2][z]}catch(E){document.getElementById("demo").innerHTML=E.message}n=CMUtilityBezier.GetSecondOrderEndPoints3D(10,x.Easting,x.Northing,0,u.Easting,u.Northing,0,t.Easting,t.Northing,0);this.PaintMeridianSegment(a,x.Easting,x.Northing,n[0][0],n[1][0],e,f,g,d,q);for(c=0;c<n[0].length-1;c++)this.PaintMeridianSegment(a,n[0][c],n[1][c],n[0][c+
1],n[1][c+1],e,f,g,d,q);this.PaintMeridianSegment(a,u.Easting,u.Northing,n[0][n[0].length-1],n[1][n[0].length-1],e,f,g,d,q);x=u;for(var B=1;B<b-2;B++){var D=r[B+2][z];n=CMUtilityBezier.GetSecondOrderPoints2D(10,x.Easting,x.Northing,u.Easting,u.Northing,t.Easting,t.Northing,D.Easting,D.Northing);this.PaintMeridianSegment(a,u.Easting,u.Northing,n[0][0],n[1][0],e,f,g,d,q);for(c=0;c<n[0].length-1;c++)this.PaintMeridianSegment(a,n[0][c],n[1][c],n[0][c+1],n[1][c+1],e,f,g,d,q);this.PaintMeridianSegment(a,
n[0][n[0].length-1],n[1][n[0].length-1],t.Easting,t.Northing,e,f,g,d,q);x=u;u=t;t=D}n=CMUtilityBezier.GetSecondOrderEndPoints3D(10,t.Easting,t.Northing,0,u.Easting,u.Northing,0,x.Easting,x.Northing,0);this.PaintMeridianSegment(a,u.Easting,u.Northing,n[0][n[0].length-1],n[1][n[0].length-1],e,f,g,d,q);for(c=n[0].length-1;0<c;c--)this.PaintMeridianSegment(a,n[0][c],n[1][c],n[0][c-1],n[1][c-1],e,f,g,d,q);this.PaintMeridianSegment(a,n[0][0],n[1][0],t.Easting,t.Northing,e,f,g,d,q)}q+=l}this.LeftIntersectionCoordinates=
[];this.RightIntersectionCoordinates=[];k=h;for(B=0;B<b;B++)if(!(1>=r[B].length))if(2==r[B].length)a.PaintRefLine(r[B][0].Easting,r[B][0].Northing,r[B][1].Easting,r[B][1].Northing);else{x=r[B][0];u=r[B][1];t=r[B][2];n=CMUtilityBezier.GetSecondOrderEndPoints3D(10,x.Easting,x.Northing,0,u.Easting,u.Northing,0,t.Easting,t.Northing,0);this.PaintParallelSegment(a,x.Easting,x.Northing,n[0][0],n[1][0],e,f,g,d,k);for(c=0;c<n[0].length-1;c++)this.PaintParallelSegment(a,n[0][c],n[1][c],n[0][c+1],n[1][c+1],
e,f,g,d,k);this.PaintParallelSegment(a,n[0][n[0].length-1],n[1][n[0].length-1],u.Easting,u.Northing,e,f,g,d,k);for(z=1;z<p-2;z++){D=r[B][z+2];n=CMUtilityBezier.GetSecondOrderPoints2D(10,x.Easting,x.Northing,u.Easting,u.Northing,t.Easting,t.Northing,D.Easting,D.Northing);this.PaintParallelSegment(a,u.Easting,u.Northing,n[0][0],n[1][0],e,f,g,d,k);for(c=0;c<n[0].length-1;c++)this.PaintParallelSegment(a,n[0][c],n[1][c],n[0][c+1],n[1][c+1],e,f,g,d,k);this.PaintParallelSegment(a,n[0][n[0].length-1],n[1][n[0].length-
1],t.Easting,t.Northing,e,f,g,d,k);x=u;u=t;t=D}n=CMUtilityBezier.GetSecondOrderEndPoints3D(10,t.Easting,t.Northing,0,u.Easting,u.Northing,0,x.Easting,x.Northing,0);this.PaintParallelSegment(a,u.Easting,u.Northing,n[0][n[0].length-1],n[1][n[0].length-1],e,f,g,d,k);for(c=n[0].length-1;1<=c;c--)this.PaintParallelSegment(a,n[0][c],n[1][c],n[0][c-1],n[1][c-1],e,f,g,d,k);this.PaintParallelSegment(a,n[0][0],n[1][0],t.Easting,t.Northing,e,f,g,d,k);k+=l}}a.ResetCollisions();if(0!=r.length){var C=this.SetupLabelFont(a,
-1);p=r[0].length;b=r.length;if(m==this.Bounds.West)for(x=0;x<b;x++){t=r[x][0];a.GetTextWidthInPixels(A);u=a.GetRefWidthFromPixelWidth(4);var A=CMUtilities.GetDMSFromDD(t.Latitude,!1,!0);a.PaintRefText(A,t.Easting-u,t.Northing,C,"right",0)}if(y==this.Bounds.East)for(x=0;x<b;x++)t=r[x][p-1],u=a.GetRefWidthFromPixelWidth(4),A=CMUtilities.GetDMSFromDD(t.Latitude,!1,!0),a.PaintRefText(A,t.Easting+u,t.Northing,C,"",0);if(h==this.Bounds.South)for(u=0;u<p;u++)t=r[b-1][u],A=CMUtilities.GetDMSFromDD(t.Longitude,
!0,!0),a.PaintRefText(A,t.Easting,t.Northing,C,"center",0);if(v==this.Bounds.North)for(u=0;u<p;u++)t=r[0][u],A=CMUtilities.GetDMSFromDD(t.Longitude,!0,!0),a.PaintRefText(A,t.Easting,t.Northing,C,"center",0)}d=a.GetCanvasElement();A=d.width;t=d.height;c={fillStyle:"White",strokeStyle:"rgba(0,0,0,0)"};a.SetStyle(c);a.PaintRect(0,11,0,t);a.PaintRect(0,A,0,11);a.PaintRect(A-11,A,0,t);a.PaintRect(0,A,t-11,t);c={fillStyle:"rgba(0,0,0,0)",strokeStyle:"Black"};a.SetStyle(c);a.PaintRect(11,A-11,11,t-11);c=
{fillStyle:"Black",strokeStyle:"Black"};a.SetStyle(c);a.ResetCollisions();if(null!=this.TopIntersectionCoordinates)for(c=0;c<this.TopIntersectionCoordinates.length;c++)t=this.TopIntersectionCoordinates[c],A=CMUtilities.GetDMSFromDD(t.Longitude,!0,!0),u=a.GetRefHeightFromPixelHeight(9),a.PaintRefText(A,t.Easting,t.Northing+u,C,"center",0);if(null!=this.BottomIntersectionCoordinates)for(c=0;c<this.BottomIntersectionCoordinates.length;c++)t=this.BottomIntersectionCoordinates[c],A=CMUtilities.GetDMSFromDD(t.Longitude,
!0,!0),u=-a.GetRefHeightFromPixelHeight(1),a.PaintRefText(A,t.Easting,t.Northing+u,C,"center",0);if(null!=this.LeftIntersectionCoordinates)for(c=0;c<this.LeftIntersectionCoordinates.length;c++)t=this.LeftIntersectionCoordinates[c],A=CMUtilities.GetDMSFromDD(t.Latitude,!0,!0),u=a.GetRefWidthFromPixelWidth(9),a.PaintRefText(A,t.Easting+u,t.Northing,C,"center",-Math.PI/2);if(null!=this.RightIntersectionCoordinates)for(c=0;c<this.RightIntersectionCoordinates.length;c++)t=this.RightIntersectionCoordinates[c],
A=CMUtilities.GetDMSFromDD(t.Latitude,!0,!0),u=-a.GetRefWidthFromPixelWidth(10),a.PaintRefText(A,t.Easting+u,t.Northing,C,"center",Math.PI/2);void 0!=w&&a.RestoreStyle()}};function CMToolHandler(a){this.ObjectType=a}
CMToolHandler.prototype.MouseDown=function(a,b,c,d){a=-1;switch(this.ObjectType){case "Rectangle":d=new CMItemRect(CMItemRect.RECTANGLE);a=this.TheLayer.AddObject(d);d.SetControlBounds(b,b,c,c);break;case "RoundedRectangle":d=new CMItemRect(CMItemRect.ROUNDED_RECTANGLE);a=this.TheLayer.AddObject(d);d.SetControlBounds(b,b,c,c);break;case "Oval":d=new CMItemRect(CMItemRect.OVAL);a=this.TheLayer.AddObject(d);d.SetControlBounds(b,b,c,c);break;case "Curve":d=new CMItemPoly;a=this.TheLayer.AddObject(d);
var e=[b,b],f=[c,c];d.SetControlPoints(0,e,f);break;case "Arrow":d=new CMItemPolyArrow,a=this.TheLayer.AddObject(d),e=[b,b],f=[c,c],d.SetControlPoints(0,e,f)}this.TheLayer.TheItems[a].StartCreating(b,c);this.TheLayer.TheItems[a].SetSelected(!0);this.TheLayer.SelectedItemIndex=a;return!0};CMToolHandler.prototype.MouseMove=function(a,b,c){return!1};CMToolHandler.prototype.MouseUp=function(a,b,c){return!1};
function CMLayerItems(){CMLayer.call(this);this.TheItems=[];this.SelectedItemIndex=-1;this.ToolGroupElement=null}CMLayerItems.prototype=Object.create(CMLayer.prototype);CMLayerItems.prototype.contructor=CMLayerItems;
CMLayerItems.prototype.Unselected=function(){if(null!=this.ToolGroupElement){var a=this.GetParent(CMMainContainer),b=a.GetToolPanel();b.RemoveTool("CMLayerObjects_RectImage");b.RemoveTool("CMLayerObjects_RoundedRectImage");b.RemoveTool("CMLayerObjects_OvalImage");b.RemoveTool("CMLayerObjects_CurveImage");b.RemoveTool("CMLayerObjects_ArrowImage");b.RemoveToolGroupElement(this.ToolGroupElement);this.ToolGroupElement=null;a.GetView().SetToolHandler(null)}};CMLayerItems.prototype.GetNumChildren=function(){return this.TheItems.length};
CMLayerItems.prototype.GetChild=function(a){return this.TheItems[a]};CMLayerItems.prototype.CMLayer_UnselectAll=CMLayer.prototype.UnselectAll;CMLayerItems.prototype.UnselectAll=function(a){this.CMLayer_UnselectAll(a);for(var b=0;b<this.TheItems.length;b++)this.TheItems[b].UnselectAll(a);this.Unselected()};CMLayerItems.prototype.CMLayer_SetSelected=CMLayer.prototype.SetSelected;
CMLayerItems.prototype.SetSelected=function(a){if(a!=this.GetSelected()){this.CMLayer_SetSelected(a);var b=this.GetParent(CMMainContainer),c=b.GetToolPanel();if(a){a=c.AddTool("CMLayerObjects_RectImage",b.ImageFolder+"Icon_Rect_Default.png",b.ImageFolder+"Icon_Rect_Selected.png");CMLayerItems.SetupTool(a,this,"Rectangle");var d=c.AddTool("CMLayerObjects_RoundedRectImage",b.ImageFolder+"Icon_RoundedRect_Default.png",b.ImageFolder+"Icon_RoundedRect_Selected.png");CMLayerItems.SetupTool(d,this,"RoundedRectangle");
var e=c.AddTool("CMLayerObjects_OvalImage",b.ImageFolder+"Icon_Oval_Default.png",b.ImageFolder+"Icon_Oval_Selected.png");CMLayerItems.SetupTool(e,this,"Oval");var f=c.AddTool("CMLayerObjects_CurveImage",b.ImageFolder+"Icon_Curve_Default.png",b.ImageFolder+"Icon_Curve_Selected.png");CMLayerItems.SetupTool(f,this,"Curve");b=c.AddTool("CMLayerObjects_ArrowImage",b.ImageFolder+"Icon_Arrow_Default.png",b.ImageFolder+"Icon_Arrow_Selected.png");CMLayerItems.SetupTool(b,this,"Arrow");this.ToolGroupElement=
c.MakeToolGroup([a,d,e,f,b])}else this.Unselected()}};CMLayerItems.SetupTool=function(a,b,c){a.TheLayer=b;a.ObjectType=c;a.Original_onclick=a.onclick;a.onclick=function(){a.Original_onclick();var b=this.TheLayer.GetParent(CMMainContainer);b.GetToolPanel();b=b.GetView();var c=new CMToolHandler(this.ObjectType);c.TheLayer=this.TheLayer;b.SetToolHandler(c)};a.UnselectFunction=function(){this.TheLayer.GetParent(CMMainContainer).GetView().SetToolHandler(null)}};
CMLayerItems.prototype.CMLayer_GetTimeSlices=CMLayer.prototype.GetTimes;CMLayerItems.prototype.GetTimes=function(a){a=this.CMLayer_GetTimeSlices(a);for(var b=0;b<this.TheItems.length;b++)a=this.TheItems[b].GetTimes(a);return a};CMLayerItems.prototype.In=function(a,b,c){var d=-1;if(this.IsVisible()&&null!=this.TheItems){a.GetRefWidthFromPixelWidth(this.ClickTolerance);for(var e=0;e<this.TheItems.length&&-1==d;e++)-1!=this.TheItems[e].InPart(a,b,c,3)&&(d=e)}return d};
CMLayerItems.prototype.MouseDown=function(a,b,c,d){var e=!1;if(this.IsVisible()&&this.GetClickable()&&0==e&&(a.GetTool()==CMView.TOOL_INFO||a.GetTool()==CMView.TOOL_SELECT)){var f=this.In(a,b,c);-1!=f&&(this.TheItems[f].MouseDown(a,b,c,d),this.TheItems[f].GetSelected()&&(this.SelectedItemIndex=f,e=!0))}return e};
CMLayerItems.prototype.MouseMove=function(a,b,c,d){var e=!1;if(this.Clickable)for(var f=0;f<this.TheItems.length&&0==e;f++)this.TheItems[f].GetSelected()&&(e=this.TheItems[f].MouseMove(a,b,c,d));return e};CMLayerItems.prototype.MouseUp=function(a,b,c,d){var e=!1;if(this.Clickable)for(var f=0;f<this.TheItems.length&&0==e;f++)this.TheItems[f].GetSelected()&&(e=this.TheItems[f].MouseUp(a,b,c,d));return e};
CMLayerItems.prototype.ShowInfoWindow=function(a,b,c,d){a=this.GetFeatureSetting("Layer","InfoText",a,null);null!=a&&(b=b.CreateInfoWindow("CMLayerItems.InfoWindow",c,d,this.GetInfoWindowWidth(),30,a),CMMainContainer.SetPopupWindow(b))};
CMLayerItems.prototype.Paint=function(a){if(this.IsVisible()&&null!=this.TheItems){this.GetCanvasMap().AddToDebugPanel(this.GetName()+" Starting Paint:"+CMUtilities.GetSeconds());var b=this.GetStyle(a);void 0!=b&&a.SetStyle(b);for(var c=0;c<this.TheItems.length;c++)this.TheItems[c].Paint(a);void 0!=b&&a.RestoreStyle();this.GetCanvasMap().AddToDebugPanel(this.GetName()+" Leaving Paint:"+CMUtilities.GetSeconds())}};
CMLayerItems.prototype.PaintSelected=function(a){if(this.IsVisible()){a.SaveStyle();for(var b=0;b<this.TheItems.length;b++)this.TheItems[b].PaintSelected(a);a.RestoreStyle()}};CMLayerItems.prototype.AddObject=function(a){this.TheItems.push(a);a.SetParent(this);this.Repaint();this.GetParent(CMScene).LayerContentChanged(this);return this.TheItems.length-1};function CMLayerRaster(){CMLayer.call(this);this.TheImage=null}CMLayerRaster.prototype=Object.create(CMLayer.prototype);CMLayerRaster.prototype.contructor=CMLayerRaster;
CMLayerRaster.prototype.SetURL=function(a,b){this.TheImage=new Image;this.TheImage.Loaded=!1;this.TheImage.TheLayer=this;this.ZoomToBounds=b;this.TheImage.onload=function(){this.Loaded=!0;this.TheLayer.Repaint();this.TheLayer.ZoomToBounds&&this.TheLayer.GetParent(CMMainContainer).ZoomToBounds(this.TheLayer.GetBounds())};this.TheImage.src=a};CMLayerRaster.prototype.SetImage=function(a){this.TheImage=a};CMLayerRaster.prototype.In=function(a,b,c){return-1};
CMLayerRaster.prototype.Paint=function(a){if(this.IsVisible()&&null!=this.TheImage&&1==this.TheImage.Loaded){var b=a.GetContext(),c=this.TheBounds,d=this.GetStyle(a);void 0!=d&&a.SetStyle(d);null!=c?a.PaintRefImageScaled(this.TheImage,this.TheBounds):b.drawImage(this.TheImage,0,0,this.TheImage.width,this.TheImage.height);void 0!=d&&a.RestoreStyle()}};document.onmousedown=function(a){var b=!1;null!==CMMainContainer.PopupWindow&&(b=jQuery.contains(CMMainContainer.PopupWindow,a.target));var c=!1;a.target===CMMainContainer.PopupWindow&&(c=!0);!1===b&&!1===c&&CMMainContainer.HidePopupWindow()};CMMainContainer.SetPopupWindow=function(a){CMMainContainer.HidePopupWindow();CMMainContainer.PopupWindow=a};
CMMainContainer.HidePopupWindow=function(){null!==CMMainContainer.PopupWindow&&(CMMainContainer.PopupWindow.style.visibility="hidden");CMMainContainer.PopupWindow=null};CMMainContainer.MAP_CONTAINER=0;CMMainContainer.TOOL_CONTAINER=1;CMMainContainer.TOOL_EDIT=2;CMMainContainer.TOOL_INFO=3;CMMainContainer.TOOL_PAN=4;CMMainContainer.CANVAS_CONTAINER=5;CMMainContainer.CANVAS=6;CMMainContainer.LAYER_LIST=7;CMMainContainer.MAP_FOOTER=8;CMMainContainer.MAP_COORDINATES=9;CMMainContainer.MAP_SRS=10;
CMMainContainer.MAP_CREDITS=11;CMMainContainer.NAVIGATION=12;CMMainContainer.BACKGROUND_LIST=13;CMMainContainer.SEARCH_PANEL=14;CMMainContainer.VERTICAL_TAB_CONTAINER=15;CMMainContainer.HORIZIONAL_TAB_CONTAINER=16;CMMainContainer.SETTINGS_PANEL=17;CMMainContainer.TIME_EDITOR_PANEL=18;CMMainContainer.ATTRIBUTE_PANEL=19;CMMainContainer.TIME_SLIDER_PANEL=20;CMMainContainer.NUM_ELEMENTS=21;CMMainContainer.GESTURE_ZOOM=.2;CMMainContainer.GESTURE_PAN=8;CMMainContainer.NumMaps=0;
CMMainContainer.PopupWindow=null;
CMMainContainer.ELEMENT_DEFS=[["CM_MapContainer","div","CM_MapContainer"],["CM_ToolContainer","div","CM_ToolContainer"],["CM_ToolEdit","div","CM_Tool"],["CM_ToolInfo","div","CM_Tool"],["CM_ToolPan","div","CM_Tool"],["CM_CanvasContainer","div","CM_CanvasContainer"],["CM_Canvas","CANVAS","CM_Canvas"],["CM_LayerList","div","CM_TabContent"],["CM_MapFooter","div","CM_MapFooter"],["CM_MapCoordinates","div","CM_Credits"],["CM_SRS","div","CM_Credits"],["CM_Credits","div","CM_Credits"],["CM_Navigation","div",
"CM_Navigation"],["CM_BackgroundList","div","CM_TabContent"],["CM_SearchPanel","div","CM_TabContent"],["CM_TabContainer","div","CM_TabContainer"],["CM_HorizontalTabContainer","div","CM_HorizontalTabContainer"],["CM_SettingsPanel","div","CM_TabContent"],["CM_TimeEditPanel","div","CM_TimeEditPanel"],["CM_AttributePanel","div","CM_AttributePanel"],["CM_TimeSliderPanel","div","CM_TimeSliderPanel"]];
function CMMainContainer(){this.ExistingElements=!0;this.ImageFolder="../Images/";this.HorizontalMargin=10;this.MobileSupported=!1;this.Index=CMMainContainer.NumMaps;CMMainContainer.NumMaps++;this.Elements=this.TheScene=null;this.Test=!1;this.PanelSearch=this.PanelBackgrounds=this.PanelLayerList=this.PanelSettings=this.PanelFooter=this.ToolPanel=this.DebugPanel=null}CMMainContainer.prototype=Object.create(CMBase.prototype);CMMainContainer.prototype.contructor=CMMainContainer;
CMMainContainer.prototype.SetTest=function(a){this.Test=a};CMMainContainer.MouseWheel=function(a){CMMainContainer.HidePopupWindow();a=window.event||a;return this.TheCanvasMap.TheScene.GetView(0).MouseWheel(a)};
CMMainContainer.prototype.Private_CreateElements=function(){null==this.Elements&&(this.Elements=Array(CMMainContainer.NUM_ELEMENTS));for(var a=0;a<this.Elements.length;a++)if(void 0===this.Elements[a]){var b=CMMainContainer.ELEMENT_DEFS[a][0]+"_"+this.Index;this.ExistingElements&&(this.Elements[a]=document.getElementById(b));void 0==this.Elements[a]&&(this.Elements[a]=document.createElement(CMMainContainer.ELEMENT_DEFS[a][1]),this.Elements[a].id=b);null!=CMMainContainer.ELEMENT_DEFS[a][2]&&(this.Elements[a].className=
CMMainContainer.ELEMENT_DEFS[a][2])}};CMMainContainer.prototype.SetImageFolder=function(a){this.ImageFolder=a};CMMainContainer.prototype.SetCoordinateUnits=function(a){null!=this.PanelFooter&&(this.PanelFooter.CoordinateUnits=a)};CMMainContainer.prototype.SetDebugPanel=function(a){this.DebugPanel=a};CMMainContainer.prototype.AddToDebugPanel=function(a){null!=this.DebugPanel&&(this.DebugPanel.innerHTML+=a+"<br>")};
CMMainContainer.prototype.SetElement=function(a,b){null==this.Elements&&(this.Elements=Array(CMMainContainer.NUM_ELEMENTS));"string"==typeof b&&(b=document.getElementById(b));this.Elements[a]=b};CMMainContainer.prototype.GetElement=function(a){return this.Elements[a]};
CMMainContainer.prototype.SimpleMap=function(){this.SetElement(CMMainContainer.TOOL_CONTAINER,null);this.SetElement(CMMainContainer.NAVIGATION,null);this.SetElement(CMMainContainer.VERTICAL_TAB_CONTAINER,null);this.SetElement(CMMainContainer.LAYER_LIST,null);this.SetElement(CMMainContainer.BACKGROUND_LIST,null);this.SetElement(CMMainContainer.SEARCH_PANEL,null);this.SetElement(CMMainContainer.SETTINGS_PANEL,null);this.SetElement(CMMainContainer.MAP_FOOTER,null)};
CMMainContainer.prototype.SetMobileSupported=function(a){this.MobileSupported=a};
CMMainContainer.prototype.Initialize=function(a,b){void 0==a&&(a=!0);this.Private_CreateElements();!0===b?(this.TheScene=new CMScene3D,b=new CMView3D):(this.TheScene=new CMScene(this),b=new CMView2D);this.TheScene.SetParent(this);this.TheScene.AddView(b);b.Setup(this.Elements[CMMainContainer.CANVAS_CONTAINER],this.Elements[CMMainContainer.CANVAS]);var c=this.Elements[CMMainContainer.MAP_CONTAINER];c.TheCanvasMap=this;c.OriginalMouseDown=c.onmousedown;var d=this.Elements[CMMainContainer.CANVAS_CONTAINER];
CMUtilities.IsDefined(d)&&c.appendChild(d);var e=this.Elements[CMMainContainer.CANVAS];CMUtilities.IsDefined(e)&&d.appendChild(e);d=this.Elements[CMMainContainer.TOOL_CONTAINER];CMUtilities.IsDefined(d)&&c.appendChild(d);d=this.Elements[CMMainContainer.VERTICAL_TAB_CONTAINER];CMUtilities.IsDefined(d)&&(this.TabPanel=new CMPanelTabs(this),this.TabPanel.SetElement(d),c.appendChild(d),d=this.Elements[CMMainContainer.LAYER_LIST],CMUtilities.IsDefined(d)&&(this.PanelLayerList=new CMPanelLayerList(this),
this.TabPanel.AddTab("Layers","Layers",void 0,d),this.PanelLayerList.SetElement(d)),d=this.Elements[CMMainContainer.SETTINGS_PANEL],CMUtilities.IsDefined(d)&&(this.PanelSettings=new CMPanelSettings(this),this.TabPanel.AddTab("Settings","Settings",null,d),this.PanelSettings.SetElement(d)),d=this.Elements[CMMainContainer.BACKGROUND_LIST],CMUtilities.IsDefined(d)&&(this.PanelBackgrounds=new CMPanelBackgrounds(this),this.TabPanel.AddTab("Background","Background",null,d),this.PanelBackgrounds.SetElement(d)),
d=this.Elements[CMMainContainer.SEARCH_PANEL],CMUtilities.IsDefined(d)&&(this.PanelSearch=new CMPanelSearch(this),this.TabPanel.AddTab("Search","Search",null,d),this.PanelSearch.SetElement(d)));d=this.GetElement(CMMainContainer.TOOL_CONTAINER);if(CMUtilities.IsDefined(d)){this.ToolPanel=new CMPanelTool(this);this.ToolPanel.SetElement(d);e=this.GetElement(CMMainContainer.TOOL_EDIT);CMUtilities.IsDefined(e)&&(d=this.ToolPanel.AddTool(e,this.ImageFolder+"IconArrow_20w_Default.png",this.ImageFolder+"IconArrow_20w_Selected.png",
this,"Click to get information on features or drag the map",function(a){a.SelectTool(CMView.TOOL_SELECT)}),d.CMMainContainer=this);var f=this.GetElement(CMMainContainer.TOOL_PAN);CMUtilities.IsDefined(f)&&(d=this.ToolPanel.AddTool(f,this.ImageFolder+"IconHand_20w_Default.png",this.ImageFolder+"IconHand_20pixels_Selected.png",this,"Click to get information on features or drag the map",function(a){a.SelectTool(CMView.TOOL_HAND)}),d.CMMainContainer=this);var g=this.GetElement(CMMainContainer.TOOL_INFO);
CMUtilities.IsDefined(g)&&(d=this.ToolPanel.AddTool(g,this.ImageFolder+"Icon_I_Default.png",this.ImageFolder+"Icon_I_Selected.png",this,"Click to get information on features or drag the map",function(a){a.SelectTool(CMView.TOOL_INFO)}),d.CMMainContainer=this);this.ToolPanel.MakeToolGroup([e,f,g]);e=document.createElement("DIV");e.id="ZoomIn_0";e.className="CM_Tool";d=this.ToolPanel.AddTool(e,this.ImageFolder+"Icon_ZoomIn_Small_17H.png",this.ImageFolder+"Icon_ZoomIn_Small_17H.png",this,"Click to zoom into the map",
function(a){this.CMMainContainer.GetScene().GetView(0).ZoomIn()});d.CMMainContainer=this;f=document.createElement("DIV");f.id="Home_0";f.className="CM_Tool";d=this.ToolPanel.AddTool(f,this.ImageFolder+"Icon_HomeExtent_small_17H.png",this.ImageFolder+"Icon_HomeExtent_small_17H.png",this,"Click to zoom into the map",function(a){this.CMMainContainer.GetScene().GetView(0).ZoomToMaxBounds()});d.CMMainContainer=this;g=document.createElement("DIV");g.id="ZoomOut_0";d=this.ToolPanel.AddTool(g,this.ImageFolder+
"Icon_ZoomOut_Small_17H.png",this.ImageFolder+"Icon_ZoomOut_Small_17H.png",this,"Click to zoom into the map",function(a){this.CMMainContainer.GetScene().GetView(0).ZoomOut()});d.CMMainContainer=this;this.ToolPanel.MakeToolGroup([e,f,g])}d=this.Elements[CMMainContainer.MAP_FOOTER];CMUtilities.IsDefined(d)&&(this.PanelFooter=new CMPanelFooter(this),this.PanelFooter.SetElement(d),c.appendChild(d));c=this.Elements[CMMainContainer.HORIZIONAL_TAB_CONTAINER];CMUtilities.IsDefined(c)&&(this.HoriziontalTabContainer=
new CMPanelTabs(this),this.HoriziontalTabContainer.SetElement(c),c=this.Elements[CMMainContainer.TIME_EDITOR_PANEL],CMUtilities.IsDefined(c)&&(this.PanelTimeline=new CMPanelTime(this),this.PanelTimeline.SetElement(c),this.HoriziontalTabContainer.AddTab("Timeline","Timeline",null,c),c=this.GetPanelSettings(),this.PanelTimeline.SetSettingsPanel(c)),c=this.Elements[CMMainContainer.ATTRIBUTE_PANEL],CMUtilities.IsDefined(c)&&((new CMPanelAttributes(this)).SetElement(c),this.HoriziontalTabContainer.AddTab("Attributes",
"Attributes",null,c)));a&&b.AddMouseEventHandlers();null!=this.Elements[CMMainContainer.VERTICAL_TAB_CONTAINER]&&jQuery(this.Elements[CMMainContainer.VERTICAL_TAB_CONTAINER]).width();null!=this.Elements[CMMainContainer.MAP_FOOTER]&&jQuery(this.Elements[CMMainContainer.MAP_FOOTER]).height();d=this.GetElement(CMMainContainer.CANVAS_CONTAINER);this.MobileSupported&&b.AddMobileEvents()};CMMainContainer.prototype.GetScene=function(){return this.TheScene};CMMainContainer.prototype.GetView=function(){return this.TheScene.GetView(0)};
CMMainContainer.prototype.GetToolPanel=function(){return this.ToolPanel};CMMainContainer.prototype.GetPanelFooter=function(){return this.PanelFooter};CMMainContainer.prototype.GetPanelSettings=function(){return this.PanelSettings};CMMainContainer.prototype.SetPanelSettings=function(a){this.PanelSettings=a};CMMainContainer.prototype.GetPanelTimeline=function(){return this.PanelTimeline};CMMainContainer.prototype.SetProjector=function(a){this.TheScene.SetProjector(a)};
CMMainContainer.prototype.GetProjector=function(){return this.TheScene.GetProjector()};CMMainContainer.prototype.SelectTool=function(a){null==this.TheScene.GetView(0)&&alert("Sorry, CMMainContainer.SelectTool() cannot be called until after Initialize() is called()");this.TheScene.GetView(0).SetTool(a)};
CMMainContainer.prototype.AddLayer=function(a){var b=-1;null==this.TheScene?alert("Sorry, CMMainContainer.AddLayer() cannot be called until after Initialize() is called()"):b=this.TheScene.AddLayer(a);return b};CMMainContainer.prototype.AddBackground=function(a){null==this.TheScene?alert("Sorry, CMMainContainer.AddBackground() cannot be called until after Initialize() is called()"):this.TheScene.AddBackground(a)};
CMMainContainer.prototype.StartMap=function(a){CMUtilities.IsDefined(this.TabPanel)&&this.TabPanel.SelectTab("Layers");a?this.Resize():this.TheScene.Resize()};CMMainContainer.prototype.ZoomIn=function(){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.ZoomIn() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).ZoomIn()};
CMMainContainer.prototype.ZoomOut=function(){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.ZoomOut() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).ZoomOut()};CMMainContainer.prototype.ZoomToMax=function(){var a=this.TheScene.GetBounds();null!=a&&this.TheScene.GetView(0).ZoomToBounds(a)};
CMMainContainer.prototype.ZoomToBounds=function(a){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.ZoomToBounds() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).ZoomToBounds(a)};CMMainContainer.prototype.ZoomTo=function(a){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.ZoomTo() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).ZoomTo(a)};
CMMainContainer.prototype.SetRefCenter=function(a,b){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.SetRefCenter() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).SetRefCenter(a,b)};CMMainContainer.prototype.Resize=function(){CMMainContainer.HidePopupWindow();this.TheScene.Resize()};function CMNorthArrow(){this.x=200;this.y=300;this.AngleInRadians=0}CMNorthArrow.Coordinates=[[0,-100],[20,-40],[10,-50],[10,100],[0,100],[0,-100]];CMNorthArrow.prototype.ViewMoved=function(a){var b=this.GetCanvasMap().TheProjector,c=a.GetRefXFromPixelX(this.x),d=a.GetRefYFromPixelY(this.y-5);a=a.GetRefYFromPixelY(this.y+5);d=b.ProjectToGeographic(c,d);b=b.ProjectToGeographic(c,a);this.AngleInRadians=Math.PI-Math.atan2(b.Longitude-d.Longitude,b.Latitude-d.Latitude)};
CMNorthArrow.prototype.Paint=function(a){var b=CMNorthArrow.Coordinates;a=a.TheContext;a.translate(this.x,this.y);a.rotate(this.AngleInRadians);a.moveTo(+b[0][0],b[0][1]);for(var c=0;c<b.length;c++)a.lineTo(b[c][0],b[c][1]);a.fill();a.stroke();a.rotate(-this.AngleInRadians);a.translate(-this.x,-this.y)};function CMPanelAttributes(a){CMBase.call(this);this.SetParent(a);a.GetScene().AddListener(CMScene.MESSAGE_LAYER_LIST_CHANGED,this,function(a,c,d){c.UpdateAttributeTable()})}CMPanelAttributes.prototype=Object.create(CMBase.prototype);CMPanelAttributes.prototype.contructor=CMPanelAttributes;CMPanelAttributes.prototype.SetElement=function(a){this.AttributeTableElement=a};
CMPanelAttributes.prototype.UpdateAttributeTable=function(){for(var a=this.GetParent(CMMainContainer).GetScene(),b=null,c=0;c<a.GetNumLayers();c++)a.GetLayer(c).GetSelected()&&(b=a.GetLayer(c));if(null!=b)try{var d=b.GetDataset(),e=d.GetNumAttributeRows(),f=d.GetNumAttributeColumns();a="<table border='1px' cellpadding='1' cellspacing='0'>";a+="<tr>";for(c=0;c<f;c++)a+="<th>",a+=d.GetAttributeHeading(c),a+="</th>";a+="</tr>";for(b=0;b<e;b++){a+="<tr>";for(c=0;c<f;c++)a+="<td>",a+=d.GetAttributeCell(c,
b),a+="</td>";a+="</tr>"}AttributeTableElement.innerHTML=a+"</table>"}catch(g){AttributeTableElement.innerHTML=""}};CMPanelBackgrounds.LAYER_LIST_ITEM_HEIGHT=24;CMPanelBackgrounds.LAYER_POPUP_MENU_ITEM_HEIGHT=24;
function CMPanelBackgrounds(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelBackgrounds requires a CanvasMap object on construction");this.SetParent(a);a.GetScene().AddListener(CMScene.MESSAGE_BACKGROUNDS_CHANGED,this,function(a,c,d){c.Setup(a)});this.TheElement=null;this.LayerListItemHeight=CMPanelBackgrounds.LAYER_LIST_ITEM_HEIGHT;this.LayerPopupMenuItemHeight=CMPanelBackgrounds.LAYER_POPUP_MENU_ITEM_HEIGHT}CMPanelBackgrounds.prototype=Object.create(CMBase.prototype);
CMPanelBackgrounds.prototype.contructor=CMPanelBackgrounds;CMPanelBackgrounds.prototype.SetElement=function(a){this.TheElement=a};
CMPanelBackgrounds.prototype.Setup=function(a){var b=this.TheElement,c=b.style.left,d=b.style.top;c=0;d=6;for(var e=0;e<a.Backgrounds.length;e++){var f=a.Backgrounds[e];e!=a.SelectedBackgroundIndex&&f.SetVisible(!1);var g=d+e*this.LayerListItemHeight;f=document.createElement("div");f.className="CM_BackgroundListItemClass";var h=jQuery(b).outerWidth(!1);CMUtilities.AbsolutePosition(f,c+2,g,h,this.LayerListItemHeight);b.appendChild(f);g=document.createElement("input");g.className="CM_BackgroundListRadioButtonClass";
g.name="Background";g.value=a.Backgrounds[e].Name;g.type="radio";g.TheScene=a;g.TheBackground=a.Backgrounds[e];g.ThisIndex=e;g.addEventListener("click",function(){this.checked&&this.TheScene.SetSelectedBackgroundIndex(this.ThisIndex)});g.checked=!1;a.SelectedBackgroundIndex==e&&(g.checked=!0);CMUtilities.AbsolutePosition(g,c+2,-6,14,this.LayerListItemHeight);f.appendChild(g);g=document.createElement("div");g.className="CM_BackgroundListNameClass";g.innerHTML=a.Backgrounds[e].Name;CMUtilities.AbsolutePosition(g,
c+30,0,150,this.LayerListItemHeight);f.appendChild(g)}};function CMPanelFooter(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelFooter requires a CanvasMap object on construction");this.SetParent(a);this.CoordinateUnits=CMUtilities.COORDINATE_UNITS_DD;var b=a.GetScene();this.TheCanvasMap=a;for(a=0;a<b.GetNumViews();a++)b.GetView(a).AddListener(CMView.MESSAGE_MOUSE_MOVED,this,function(a,b,e){void 0!=b.TheCoordinates&&(a=a.GetCoordinateStringFromEvent(e,b.CoordinateUnits),""==a&&(a=" "),b.TheCoordinates.innerHTML=a)})}CMPanelFooter.prototype=Object.create(CMBase.prototype);
CMPanelFooter.prototype.contructor=CMPanelFooter;
CMPanelFooter.prototype.SetElement=function(a){this.TheElement=a;var b=document.createElement("TABLE");b.width="100%";var c=b.insertRow(0),d=c.insertCell(0);c=c.insertCell(1);this.TheCredits=document.createElement("DIV");this.TheCredits.className="CM_Credits";c.appendChild(this.TheCredits);c.style.align="right";c=document.createElement("TABLE");var e=c.insertRow(0).insertCell(0);this.TheCoordinates=document.createElement("DIV");this.TheCoordinates.className="CM_MapCoordinates";e.appendChild(this.TheCoordinates);
e=c.insertRow(1).insertCell(0);this.TheSRS=document.createElement("DIV");this.TheSRS.className="CM_SRS";e.appendChild(this.TheSRS);d.appendChild(c);a.appendChild(b)};CMPanelFooter.prototype.SetCredits=function(a){this.TheCredits.innerHTML=a};CMPanelLayerList.LAYER_LIST_ITEM_HEIGHT=24;CMPanelLayerList.LAYER_POPUP_MENU_ITEM_HEIGHT=24;
function CMPanelLayerList(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelLayerList requires a CanvasMap object on construction");this.SetParent(a);a.GetScene().AddListener(CMScene.MESSAGE_LAYER_LIST_CHANGED,this,function(a,c,d){c.AddLayerList(a)});this.TheElement=null;this.LayerListItemHeight=CMPanelLayerList.LAYER_LIST_ITEM_HEIGHT;this.LayerPopupMenuItemHeight=CMPanelLayerList.LAYER_POPUP_MENU_ITEM_HEIGHT}CMPanelLayerList.prototype=Object.create(CMBase.prototype);
CMPanelLayerList.prototype.contructor=CMPanelLayerList;
CMPanelLayerList.prototype.AddLayerToList=function(a,b,c,d,e){var f=e.Layers[b];b=document.createElement("div");b.className="CM_LayerListItemClass";a.appendChild(b);var g=document.createElement("input");g.className="CM_LayerListCheckBoxClass";g.type="checkbox";g.TheLayer=f;g.checked=f.GetVisible();g.addEventListener("click",function(){this.checked?this.TheLayer.SetVisible(!0):this.TheLayer.SetVisible(!1)});CMUtilities.AbsolutePosition(g,c+2,-6,30,this.LayerListItemHeight);b.appendChild(g);g=f.GetIcon();
CMUtilities.IsDefined(g)&&(CMUtilities.AbsolutePosition(g,c+28,-5,16,16),b.appendChild(g));g=document.createElement("div");g.className="CM_LayerListNameClass";var h=f.Name;null===h&&(h="Untitled");g.innerHTML=h;g.TheLayer=f;g.TheScene=e;g.TheElement=a;g.LayerInList=b;g.TheLayerList=this;CMUtilities.AbsolutePosition(g,c+48,0,170,this.LayerListItemHeight);this.DraggingDiv=null;document.addEventListener("contextmenu",function(a){a.preventDefault();return!1});g.addEventListener("mousedown",function(a){a.preventDefault();
if(0==a.button){this.DraggingDiv=document.getElementById("DraggingDiv");null==this.DraggingDiv&&(this.DraggingDiv=document.createElement("div"),this.DraggingDiv.className="CM_DraggingDivClass",this.DraggingDiv.id="DraggingDiv");this.DraggingDiv.style.visibility="visible";this.TheElement.appendChild(this.DraggingDiv);this.TheElement.DraggingDiv=DraggingDiv;this.TheElement.DraggingLayer=this.TheLayer;var b=$(this.TheElement).offset();CMUtilities.AbsolutePosition(this.DraggingDiv,0,a.clientY-b.top,200,
0)}else b=CMUtilities.GetPopupMenu("CM_LayerPopupMenu",a.clientX,a.clientY),this.TheLayer.FillPopupMenu(b);a.stopPropagation();a.preventDefault();return!1});g.addEventListener("mouseup",function(a){a.preventDefault();return!1});b.appendChild(g);a=jQuery(a).outerWidth(!1);CMUtilities.AbsolutePosition(b,c+2,d,a,this.LayerListItemHeight)};CMPanelLayerList.prototype.SetElement=function(a){this.TheElement=a};CMPanelLayerList.prototype.Setup=function(a){for(a=this.TheElement;a.hasChildNodes();)a.removeChild(a.lastChild)};
CMPanelLayerList.prototype.AddLayerList=function(a){var b;TheElement=this.TheElement;for(TheElement.LayerListPanel=this;TheElement.firstChild;)TheElement.removeChild(TheElement.firstChild);for(var c=TheElement.style.left,d=TheElement.style.top,e=b=d=c=0;e<a.Layers.length;e++)b=d+e*this.LayerListItemHeight,this.AddLayerToList(TheElement,e,c,b,a);TheElement.addEventListener("mousemove",function(a){if(null!=this.DraggingDiv){var b=$(this).offset();CMUtilities.AbsolutePosition(this.DraggingDiv,0,a.clientY-
b.top,200,0);a.preventDefault();return!1}});TheElement.addEventListener("mouseup",function(a){if(null!=this.DraggingDiv){a.preventDefault();var b=this.LayerListPanel.GetParent().GetScene(),c=$(this).offset();b.MoveLayer(this.DraggingLayer,Math.floor((a.clientY-c.top)/this.LayerListPanel.LayerListItemHeight));this.DraggingDiv.style.visibility="hidden";this.DraggingDiv=null;this.LayerListPanel.AddLayerList(b)}return!1});TheElement.addEventListener("mouseleave",function(a){null!=this.DraggingDiv&&(this.DraggingDiv.style.visibility=
"hidden",this.DraggingDiv=null,a.preventDefault())})};function CMPanelSearch(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelSearch requires a CanvasMap object on construction");this.SetParent(a);this.TheElement=null}CMPanelSearch.prototype=Object.create(CMBase.prototype);CMPanelSearch.prototype.contructor=CMPanelSearch;
CMPanelSearch.prototype.SetElement=function(a){this.TheElement=a;a.innerHTML="Search:";var b=document.createElement("DIV");b.id="CM_SearchResults";var c=document.createElement("INPUT");c.setAttribute("type","text");a.appendChild(c);var d=document.createElement("INPUT");d.setAttribute("type","button");d.value="Submit";d.className="CM_SearchButton";d.TextField=c;d.CanvasMap=this.GetParent();d.SearchResults=b;d.onclick=function(){var a=this.TextField.value;a=a.toLowerCase();b.innerHTML="";this.CanvasMap.TheScene.GetSearchResults(a,
b)};a.appendChild(d);a.appendChild(b)};function CMPanelSettings(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelSettings requires a CanvasMap object on construction");this.SetParent(a);this.TheElement=null;a.GetScene().AddListener(CMScene.MESSAGE_SELECTION_CHANGED,this,function(a,c,d){d.GetSelected()?c.Setup(d):c.TheElement.innerHTML=""})}CMPanelSettings.prototype=Object.create(CMBase.prototype);CMPanelSettings.prototype.contructor=CMPanelSettings;
CMPanelSettings.AddSetting=function(a,b,c,d,e,f){var g,h=a.childNodes,k=null;for(g=0;g<h.length&&null==k;g++)h[g]==b&&(k=g);var l=null;for(g=k+1;g<h.length&&null==l;g++)k=h[g],"TR"==k.nodeName&&"SETTING"!=k.Type&&(l=k);h=document.createElement("TR");null==l?a.appendChild(h):a.insertBefore(h,l);l=AppendElement("TD",h);h.Type="SETTING";h.Key=c;h.PropertyType=d.Type;g=document.createTextNode(d.Name+":");l.appendChild(g);l=AppendElement("TD",h);void 0==e&&(e=d.Default);switch(d.Type){case CMBase.DATA_TYPE_CSS_STYLE:g=
document.createElement("INPUT");l.appendChild(g);g.setAttribute("type","color");g.value=CMUtilities.GetHexColorFromColor(e);g=document.createElement("INPUT");g.className="CM_SettingsInput";l.appendChild(g);g.setAttribute("type","number");l=CMUtilities.GetColorsFromAnyColor(e);void 0!=l.Transparency&&(g.value=l.Transparency);g.style.width="60px";break;case CMBase.DATA_TYPE_COLOR:g=document.createElement("INPUT");l.appendChild(g);g.setAttribute("type","color");l=CMUtilities.GetColorsFromAnyColor(e);
g.value=CMUtilities.GetHexColorFromColor(e);break;case CMBase.DATA_TYPE_INTEGER:case CMBase.DATA_TYPE_FLOAT:g=document.createElement("INPUT");g.className="CM_SettingsInput";l.appendChild(g);g.setAttribute("type","number");g.value=e;g.style.width="60px";break;case CMBase.DATA_TYPE_BOOLEAN:g=document.createElement("INPUT");l.appendChild(g);g.setAttribute("type","checkbox");g.checked=e;break;case CMBase.DATA_TYPE_COORDINATES:g=document.createElement("DIV");l.appendChild(g);g.Coordinates=e;break;case CMBase.DATA_TYPE_ENUMERATED:f=
document.createElement("SELECT");l.appendChild(f);for(l=0;l<d.Options.length;l++)k=d.Options[l],g=document.createElement("option"),g.setAttribute("value",k),k=document.createTextNode(k),g.appendChild(k),f.appendChild(g);f.value=e}l=AppendElement("DIV",h);l.innerHTML="X";l.TheSettingRow=h;l.TheGroupRow=b;l.TheTable=a;l.TheControl=f;l.PropertyKey=c;l.SettingsDefinitions=d;l.onclick=function(){CMPanelSettings.AddOptionToSelect(this.TheTable,this.TheGroupRow,this.PropertyKey,this.SettingsDefinitions,
this.TheControl);this.TheTable.removeChild(this.TheSettingRow)}};CMPanelSettings.AddOptionToSelect=function(a,b,c,d,e){a=document.createElement("option");a.text=d.Name;a.PropertyKey=c;a.SettingsDefinitions=d;e.add(a)};
CMPanelSettings.GetSettings=function(a){a=a.childNodes;var b={},c=null;for(RowNodeKey in a){var d=a[RowNodeKey];if("TR"==d.nodeName){var e=d.childNodes;if("GROUP"==d.Type)d=d.Key,c={},b[d]=c;else if("SETTING"==d.Type){var f=d.Key;e=e[1];try{var g=e.childNodes[0].value;d.PropertyType==CMBase.DATA_TYPE_CSS_STYLE?(TheColor=g,TheTransparency=e.childNodes[1].value,""==TheTransparency&&(TheTransparency=void 0),c[f]=CMUtilities.GetRGBAFromAnyColor(TheColor,TheTransparency)):d.PropertyType==CMBase.DATA_TYPE_COORDINATES?
c[f]=e.childNodes[0].Coordinates:d.PropertyType==CMBase.DATA_TYPE_INTEGER?c[f]=parseInt(g):d.PropertyType==CMBase.DATA_TYPE_FLOAT?c[f]=parseFloat(g):d.PropertyType==CMBase.DATA_TYPE_BOOLEAN?0==parseInt(g)?c[f]=!1:c[f]=!0:c[f]=g}catch(h){}}}}return b};CMPanelSettings.prototype.SetElement=function(a){this.TheElement=a};
CMPanelSettings.prototype.Setup=function(a){for(var b,c=this.TheElement;c.hasChildNodes();)c.removeChild(c.lastChild);var d=this.GetParent(CMMainContainer).GetScene().GetTimeRange(),e=a.GetSettings(d),f=a.GetSettingsDefinitions();if(null!=e){var g=document.createElement("TABLE");c.appendChild(g);for(GroupKey in f){c=f[GroupKey];var h=e[GroupKey],k=AppendElement("TR",g),l=AppendElement("TD",k);AppendElement("DIV",l).innerHTML="<b>"+GroupKey+":</b>";k.Type="GROUP";k.Key=GroupKey;var m=document.createElement("SELECT");
l=document.createElement("option");l.text="Select to add";m.add(l);m.TheTable=g;m.TheGroupRow=k;m.onchange=function(){var a=this.selectedIndex,b=this.options[a];this.remove(a);CMPanelSettings.AddSetting(this.TheTable,this.TheGroupRow,b.PropertyKey,b.SettingsDefinitions,b.SettingsDefinitions.Default,m)};for(PropertyKey in c)PropertyKey in h||(b=c[PropertyKey],CMPanelSettings.AddOptionToSelect(g,k,PropertyKey,b,m));AppendElement("TD",k).appendChild(m);for(PropertyKey in h){l=h[PropertyKey];try{b=c[PropertyKey]}catch(p){document.getElementById("demo").innerHTML=
p.message}CMPanelSettings.AddSetting(g,k,PropertyKey,b,l,m)}}e=AppendElement("TR",g);b=AppendElement("TD",e);e.Type="APPLY";e=document.createElement("INPUT");b.appendChild(e);e.TheObject=a;e.TheTable=g;e.TimeSlice=d;e.setAttribute("type","button");e.setAttribute("value","Apply");e.addEventListener("click",function(){var a=CMPanelSettings.GetSettings(this.TheTable);this.TheObject.SetSettings(a,this.TimeSlice)});b=AppendElement("TR",g);d=AppendElement("TD",b);b.Type="GET";b=document.createElement("INPUT");
d.appendChild(b);b.TheObject=a;b.TheTable=g;b.setAttribute("type","button");b.setAttribute("value","Get");b.addEventListener("click",function(){var a=CMPanelSettings.GetSettings(this.TheTable),b=new CMDialog("LayerVector_Settings_Dialog",600,400),c=JSON.stringify(a,null,"\t");c=c.replace("\n","\n");a=document.createElement("PRE");c=document.createTextNode(c);a.appendChild(c);b.TheElement.appendChild(a)})}};function CMPanelTabs(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelTabs requires a CanvasMap object on construction");this.SetParent(a);this.Tabs=[];this.TabContents=[]}CMPanelTabs.prototype=Object.create(CMBase.prototype);CMPanelTabs.prototype.contructor=CMPanelTabs;CMPanelTabs.prototype.GetTabIndexFromName=function(a){for(var b=-1,c=0;c<this.Tabs.length;c++)this.Tabs[c].Name==a&&(b=c);return b};
CMPanelTabs.prototype.SetElement=function(a){this.TheElement=a;this.TabContainer=document.createElement("DIV");this.TabContainer.className="CM_Tabs";this.TheElement.appendChild(this.TabContainer)};
CMPanelTabs.prototype.AddTab=function(a,b,c,d){if(null!=this.TheElement){var e=document.createElement("button");e.id=a+"_tab";e.className="tablinks";void 0!=c&&(e.title=c);e.innerHTML=b;e.Selected=!1;e.TabPanel=this;e.Name=b;e.onclick=function(){this.TabPanel.SelectTab(this.Name);CMMainContainer.HidePopupWindow()};this.Tabs.push(e);this.TabContainer.appendChild(e);0==CMUtilities.IsDefined(d)&&(d=document.createElement("DIV"),d.id=a,d.className="CM_TabContent");d.style.display="none";this.TabContents.push(d);
this.TheElement.appendChild(d)}return d};CMPanelTabs.prototype.SelectTab=function(a){for(var b=0;b<this.Tabs.length;b++)this.Tabs[b].Name==a?(this.TabContents[b].style.display="block",this.Tabs[b].className=this.Tabs[b].className+=" active"):(this.TabContents[b].style.display="none",this.Tabs[b].className=this.Tabs[b].className.replace(" active",""))};CMPanelTabs.prototype.GetTabContentElement=function(a){var b=null;a=this.GetTabIndexFromName(a);-1!=a&&(b=this.TabContents[a]);return b};
CMPanelTabs.prototype.RemoveTab=function(a){a=this.GetTabIndexFromName(a);if(-1!=a){var b=this.Tabs[a];b.parentNode.removeChild(b);this.Tabs.splice(a,1);this.TabContents.splice(a,1)}};function CMPanelTime(a){this.TheCanvasMap=a;this.RightSide=100;this.VerticalSpacing=20;this.TimeSpacing=50;this.SelectedColumn=this.SelectedRow=0;var b;this.SetElement=function(a){b=a;a=document.createElement("canvas");a.width=500;a.height=500;a.id="TIME_EDITOR_CANVAS";b.appendChild(a);b.GetColumnFromEvent=function(a){a=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this).x;return Math.floor((a-this.TimePanel.RightSide)/this.TimePanel.TimeSpacing)};b.GetSelectedRowFromEvent=function(a){a=CMUtilities.GetElementCoordinate(a.clientX,
a.clientY,this).y;return Math.floor(a/this.TimePanel.VerticalSpacing-1)};b.TimePanel=this;b.addEventListener("mousedown",function(a){var b=this.GetColumnFromEvent(a);var c=this.GetSelectedRowFromEvent(a);var d=this.TimePanel.GetNumRows();var h=this.TimePanel.TheCanvasMap.GetScene();var k=h.GetTimes();var l=k[b],m=k.length;0>=m&&(m=1);event.preventDefault();0==event.button&&-1<=b&&b<m&&-1<=c&&c<d&&(this.TimePanel.SelectedRow=c,this.TimePanel.SelectedColumn=b,this.TimePanel.TheCanvasMap.GetScene().SetTimeRange(k[b]),
h.Repaint(),this.TimePanel.PaintTimeEditor(),0==this.TimePanel.SelectedRow?(this.TimePanel.SettingsPanel.Setup(h),h.SetSelected(!0)):(d=this.TimePanel.GetRowObject(this.TimePanel.SelectedRow),null!=d&&(this.TimePanel.SettingsPanel.Setup(d),d.SetSelected(!0))));0!=event.button&&(-1==c?(a=CMUtilities.GetPopupMenu("CM_LayerPopupMenu",a.clientX,a.clientY),0<=b&&(d=l+1,b!=k.length-1&&(d=(k[b+1]+l)/2),c=document.createElement("div"),c.setAttribute("id","CM_SettingsElement"),c.className="CM_LayerListPopupMenuItem",
c.innerHTML="Insert Right...",c.TheSlice=d,c.TimePanel=this.TimePanel,c.ThePopupMenu=a,c.addEventListener("click",function(a){this.TimePanel.TheCanvasMap.GetScene().InsertTime(this.TheSlice);this.ThePopupMenu.style.visibility="hidden";a.stopPropagation()}),a.appendChild(c)),0<b&&(d=(k[b-1]+l)/2,c=document.createElement("div"),c.setAttribute("id","CM_SettingsElement"),c.className="CM_LayerListPopupMenuItem",c.innerHTML="Insert Left...",c.TheSlice=d,c.TimePanel=this.TimePanel,c.ThePopupMenu=a,c.addEventListener("click",
function(a){this.TimePanel.TheCanvasMap.GetScene().InsertTime(this.TheSlice);this.ThePopupMenu.style.visibility="hidden";a.stopPropagation()}),a.appendChild(c)),0<b&&(c=document.createElement("div"),c.setAttribute("id","CM_SettingsElement"),c.className="CM_LayerListPopupMenuItem",c.innerHTML="Delete...",c.TheSlice=l,c.TimePanel=this.TimePanel,c.ThePopupMenu=a,c.addEventListener("click",function(a){this.TimePanel.TheCanvasMap.GetScene().DeleteTime(this.TheSlice);this.ThePopupMenu.style.visibility=
"hidden";a.stopPropagation()}),a.appendChild(c))):(a=CMUtilities.GetPopupMenu("CM_LayerPopupMenu",a.clientX,a.clientY),0<=b&&(d=this.TimePanel.GetRowObject(this.TimePanel.SelectedRow),k=d.GetTimes(),k=k.indexOf(l),c=document.createElement("div"),c.setAttribute("id","CM_SettingsElement"),c.className="CM_LayerListPopupMenuItem",c.TheSlice=l,c.TimePanel=this.TimePanel,c.ThePopupMenu=a,-1==k?(c.innerHTML="Add Settings...",c.addEventListener("click",function(a){this.TimePanel.GetRowObject(this.TimePanel.SelectedRow).InsertTime(this.TheSlice);
this.ThePopupMenu.style.visibility="hidden";a.stopPropagation();this.TimePanel.PaintTimeEditor()}),a.appendChild(c)):0!=k&&(c.innerHTML="Delete Settings...",c.addEventListener("click",function(a){this.TimePanel.GetRowObject(this.TimePanel.SelectedRow).DeleteTime(this.TheSlice);this.ThePopupMenu.style.visibility="hidden";a.stopPropagation()}),a.appendChild(c)))),0==a.childNodes.length&&CMMainContainer.HidePopupWindow());event.stopPropagation();event.preventDefault();return!1})};a=a.GetScene();a.AddListener(CMScene.MESSAGE_LAYER_LIST_CHANGED,
this,function(a,b,e){b.PaintTimeEditor()});a.AddListener(CMScene.MESSAGE_TIME_SLICES_CHANGED,this,function(a,b,e){b.PaintTimeEditor()});a.AddListener(CMScene.MESSAGE_SELECTION_CHANGED,this,function(a,b,e){b.PaintTimeEditor()});this.PaintTimeEditor()}
CMPanelTime.prototype.GetRowObject=function(a){var b=null,c=this.TheCanvasMap.GetScene();if(0==a)b=c;else for(var d=c.Layers.length,e=1,f=0;f<d&&null==b;f++){var g=c.GetLayer(f);e==a&&(b=g);e++;for(var h=g.GetNumChildren(),k=0;k<h&&null==b;k++){var l=g.GetChild(k);e==a&&(b=l);e++}}return b};function AppendElement(a,b){a=document.createElement(a);b.appendChild(a);return a}CMPanelTime.prototype.GetColumnLeft=function(a){return this.RightSide+a*this.TimeSpacing};
CMPanelTime.prototype.GetRowTop=function(a){return(a+1)*this.VerticalSpacing};CMPanelTime.prototype.SetSettingsPanel=function(a){this.SettingsPanel=a};function PaintLine(a,b,c,d,e){a.beginPath();a.moveTo(b,c);a.lineTo(d,e);a.stroke()}CMPanelTime.prototype.GetNumRows=function(){for(var a=this.TheCanvasMap.GetScene(),b=a.Layers.length,c=b+1,d=0;d<b;d++){var e=a.GetLayer(d);c+=e.GetNumChildren()}return c};
CMPanelTime.prototype.PaintTimeSliceSettingsSymbols=function(a,b,c,d){for(var e=0;e<a.length;e++)null!=b.GetSettings(a[e])&&d.fillText("O",this.RightSide+e*this.TimeSpacing+4,c-4)};
CMPanelTime.prototype.PaintTimeEditor=function(){var a=this.TheCanvasMap.GetScene();var b=a.GetTimes();var c=document.getElementById("TIME_EDITOR_CANVAS");if(null!=c){var d=c.getContext("2d");a=this.TheCanvasMap.GetScene();var e=a.Layers.length,f=c.offsetWidth,g=c.offsetWidth,h=0;d.fillStyle="#ffffff";d.fillRect(0,0,f,g);d.fill();c=(h+1)*this.VerticalSpacing;PaintLine(d,0,c,f,c);h++;d.strokeStyle="#000000";d.lineWidth=1;c=(h+1)*this.VerticalSpacing;d.font="14px  arial";d.fillStyle="#000000";d.fillText("Layers",
4,c-4);this.PaintTimeSliceSettingsSymbols(b,a,c,d);PaintLine(d,0,c,f,c);h++;for(var k=0;k<e;k++){var l=a.GetLayer(k),m=l.GetName();c=(h+1)*this.VerticalSpacing;d.fillText(m,4,c-4);this.PaintTimeSliceSettingsSymbols(b,l,c,d);PaintLine(d,0,c,f,c);h++;m=l.GetNumChildren();for(var p=0;p<m;p++){var q=l.GetChild(p);c=(h+1)*this.VerticalSpacing;d.fillText(q.GetName(),14,c-4);this.PaintTimeSliceSettingsSymbols(b,q,c,d);PaintLine(d,0,c,f,c);h++}}for(k=0;k<b.length;k++)a=this.RightSide+k*this.TimeSpacing,d.fillText(b[k],
a+4,this.VerticalSpacing-4),PaintLine(d,a,0,a,g);a=this.RightSide+b.length*this.TimeSpacing;PaintLine(d,a,0,a,g);-1!=this.SelectedColumn&&(a=this.GetColumnLeft(this.SelectedColumn),c=this.GetRowTop(this.SelectedRow),d.strokeStyle="#000000",d.lineWidth=2,d.rect(a+1,c+1,this.TimeSpacing-2,this.VerticalSpacing-2),d.stroke())}};function CMPanelTool(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelTool requires a CanvasMap object on construction");this.SetParent(a);this.Tools=[]}CMPanelTool.prototype=Object.create(CMBase.prototype);CMPanelTool.prototype.contructor=CMPanelTool;CMPanelTool.prototype.GetToolIndexFromID=function(a){for(var b=-1,c=0;c<this.Tools.length;c++)this.Tools[c].id==a&&(b=c);return b};CMPanelTool.prototype.SetElement=function(a){this.TheElement=a;this.Tools=[]};
CMPanelTool.prototype.AddTool=function(a,b,c,d,e,f){if(null!=this.TheElement){if("string"===typeof a){var g=a;a=document.createElement("DIV");a.id=g;a.className="CM_Tool"}else g=a.id;a.style.backgroundColor="none";a.title=e;a.cursor="pointer";a.innerHTML="<img id='"+g+"_Image' class='CMTool_Image' \r\n\t\t  src='"+b+"'alt='ID Marker'>";a.Selected=!1;a.ToolPanel=this;a.UnselectedFilePath=b;a.SelectedFilePath=c;a.TheFunction=f;a.onclick=function(){var a=this.ToolPanel;a.GetParent(CMMainContainer);a.SelectTool(this.id);
CMMainContainer.HidePopupWindow();void 0!=this.TheFunction&&this.TheFunction(d)};this.TheElement.appendChild(a);this.Tools.push(a)}return a};
CMPanelTool.prototype.MakeToolGroup=function(a){for(var b,c=0;c<a.length;c++)b=a[c],b.parentNode.removeChild(b);var d=document.createElement("DIV");d.className="CM_ToolGroup";b=document.createElement("TABLE");d.appendChild(b);b.style.borderSpacing="0px";var e=b.insertRow(0),f=0;for(c=0;c<a.length;c++){b=a[c];b.className="CM_ToolInGroup";var g=e.insertCell(-1);c!=a.length-1&&(g.style.borderRight="thin solid #999");g.appendChild(b);f+=28}d.style.width=f+"px";this.TheElement.appendChild(d);return d};
CMPanelTool.prototype.RemoveToolGroupElement=function(a){this.TheElement.removeChild(a)};CMPanelTool.prototype.AddToolGroupElement=function(a){this.TheElement.appendChild(a)};CMPanelTool.prototype.RemoveTool=function(a){a=this.GetToolIndexFromID(a);if(-1!=a){var b=this.Tools[a];b.parentNode.removeChild(b);this.Tools.splice(a,1)}};
CMPanelTool.prototype.SelectTool=function(a){for(var b,c=0;c<this.Tools.length;c++){var d=this.Tools[c];d.id==a?(d.Selected=!0,b=document.getElementById(a+"_Image"),b.src=d.SelectedFilePath):d.Selected&&(void 0!=d.UnselectFunction&&d.UnselectFunction(),d.Selected=!1,b=document.getElementById(d.id+"_Image"),b.src=d.UnselectedFilePath)}};function CMProjector(){}CMProjector.EPSG_WGS84_UTM_1_NORTH=32601;CMProjector.EPSG_WGS84_UTM_1_SOUTH=32701;CMProjector.WGS_84=1;CMProjector.NAD_27=2;CMProjector.NAD_83=3;CMProjector.DegreesToRadians=function(a){return Math.PI/180*a};CMProjector.RadiansToDegrees=function(a){return DegreeAngle=a/(Math.PI/180)};CMProjector.prototype.ProjectToGeographic=function(a,b){return{Longitude:a,Latitude:b}};CMProjector.prototype.ProjectFromGeographic=function(a,b){return{Easting:a,Northing:b}};
CMProjector.prototype.GetBounds=function(){return{East:180,West:-180,North:90,South:-90}};CMProjector.prototype.ProjectGeoJSONFromGeographic=function(a){a=a.features;for(var b=0;b<a.length;b++)CMUtilities.ApplyToGeometryCoordinates(a[b].geometry,Projector_ApplyProjectionToCoordinates,this)};function Projector_ApplyProjectionToCoordinates(a,b){a=a.ProjectFromGeographic(b[0],b[1]);b[0]=a.Easting;b[1]=a.Northing;return a};var Mercator_PixelsPerDegreee=[.71111111111111,1.4222222222222,2.8444444444444,5.6888888888889,11.377777777778,22.755555555556,45.511111111111,91.022222222222,182.04444444444,364.08888888889,728.17777777778,1456.3555555556,2912.7111111111,5825.4222222222,11650.844444444,23301.688888889,46603.377777778,93206.755555556,186413.51111111,372827.02222222],Mercator_PixelsPerRadian=[40.743665431525,81.48733086305,162.9746617261,325.9493234522,651.8986469044,1303.7972938088,2607.5945876176,5215.1891752352,
10430.37835047,20860.756700941,41721.513401882,83443.026803764,166886.05360753,333772.10721505,667544.21443011,1335088.4288602,2670176.8577204,5340353.7154409,1.0680707430882E7,2.1361414861763E7],Mercator_Offsets=[128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864],Mercator_NumColumns=[0,1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288];
function CMProjectorGoogleMaps(){CMProjector.call(this);this.ZoomLevel=18}CMProjectorGoogleMaps.prototype=Object.create(CMProjector.prototype);CMProjectorGoogleMaps.prototype.contructor=CMProjectorGoogleMaps;
CMProjectorGoogleMaps.prototype.ProjectFromGeographic=function(a,b){var c=Mercator_Offsets[this.ZoomLevel];a=Math.round(c+a*Mercator_PixelsPerDegreee[this.ZoomLevel]);b=Math.sin(CMProjector.DegreesToRadians(b));b=Math.max(b,-.9999);b=Math.min(b,.9999);return{Easting:a,Northing:-Math.round(c+.5*Math.log((1+b)/(1-b))*-Mercator_PixelsPerRadian[this.ZoomLevel])}};
CMProjectorGoogleMaps.prototype.ProjectToGeographic=function(a,b){var c=Mercator_Offsets[this.ZoomLevel];a=(a-c)/Mercator_PixelsPerDegreee[this.ZoomLevel];b=CMProjector.RadiansToDegrees(2*Math.atan(Math.exp((-b-c)/-Mercator_PixelsPerRadian[this.ZoomLevel]))-Math.PI/2);return{Longitude:a,Latitude:b}};CMProjectorGoogleMaps.prototype.SetZoomLevel=function(a){this.ZoomLevel=a};function CMProjectorUTM(){CMProjector.call(this);this.Datum=CMProjector.WGS_84;this.UTMZone=10;this.South=!1}CMProjectorUTM.prototype=Object.create(CMProjector.prototype);CMProjectorUTM.prototype.contructor=CMProjectorUTM;CMProjectorUTM.PI=3.14159265;CMProjectorUTM.deg2rad=CMProjectorUTM.PI/180;CMProjectorUTM.rad2deg=180/CMProjectorUTM.PI;CMProjectorUTM.EquatorialRadii=[6378135,6378137,6378206,6378137];CMProjectorUTM.SquaresOfEccentricity=[.006694318,.00669438,.006768658,.00669438];
CMProjectorUTM.prototype.SetDatum=function(a){this.Datum=a};CMProjectorUTM.prototype.SetZone=function(a){this.UTMZone=a};CMProjectorUTM.prototype.SetSouth=function(a){this.South=a};
CMProjectorUTM.prototype.ProjectFromGeographic=function(a,b){void 0==this.Datum&&alert("Sorry, the datum must be defined to call ProjectFromGeographic in the CMProjectorUTM class");-180>a&&(a=-180);180<a&&(a=180);-90>b&&(b=-90);90<b&&(b=90);var c=null;if(0<=this.Datum&&4>this.Datum){c=CMProjectorUTM.EquatorialRadii[this.Datum];var d=CMProjectorUTM.SquaresOfEccentricity[this.Datum];parseInt((a+180)/360*360-180);var e=b*CMProjectorUTM.deg2rad,f=a*CMProjectorUTM.deg2rad;var g=(6*(this.UTMZone-1)-180+
3)*CMProjectorUTM.deg2rad;a=d/(1-d);b=c/Math.sqrt(1-d*Math.sin(e)*Math.sin(e));var h=Math.tan(e)*Math.tan(e);var k=a*Math.cos(e)*Math.cos(e);g=Math.cos(e)*(f-g);c=.9996*(c*((1-d/4-3*d*d/64-5*d*d*d/256)*e-(3*d/8+3*d*d/32+45*d*d*d/1024)*Math.sin(2*e)+(15*d*d/256+45*d*d*d/1024)*Math.sin(4*e)-35*d*d*d/3072*Math.sin(6*e))+b*Math.tan(e)*(g*g/2+(5-h+9*k+4*k*k)*g*g*g*g/24+(61-58*h+h*h+600*k-330*a)*g*g*g*g*g*g/720));this.South&&(c+=1E7);c={Easting:.9996*b*(g+(1-h+k)*g*g*g/6+(5-18*h+h*h+72*k-58*a)*g*g*g*g*
g/120)+5E5,Northing:c}}return c};
CMProjectorUTM.prototype.ProjectToGeographic=function(a,b){void 0==this.Datum&&alert("Sorry, the datum must be defined to call ProjectToGeographic in the CMProjectorUTM class");var c=null;if(0<=this.Datum&&4>this.Datum){var d=CMProjectorUTM.EquatorialRadii[this.Datum];var e=CMProjectorUTM.SquaresOfEccentricity[this.Datum];var f=(1-Math.sqrt(1-e))/(1+Math.sqrt(1-e));var g=b;1==this.South&&(g-=1E7);b=6*(this.UTMZone-1)-180+3;c=e/(1-e);g=g/.9996/(d*(1-e/4-3*e*e/64-5*e*e*e/256));var h=g+(3*f/2-27*f*f*
f/32)*Math.sin(2*g)+(21*f*f/16-55*f*f*f*f/32)*Math.sin(4*g)+151*f*f*f/96*Math.sin(6*g);var k=d/Math.sqrt(1-e*Math.sin(h)*Math.sin(h));f=Math.tan(h)*Math.tan(h);g=c*Math.cos(h)*Math.cos(h);d=d*(1-e)/Math.pow(1-e*Math.sin(h)*Math.sin(h),1.5);a=(a-5E5)/(.9996*k);d=h-k*Math.tan(h)/d*(a*a/2-(5+3*f+10*g-4*g*g-9*c)*a*a*a*a/24+(61+90*f+298*g+45*f*f-252*c-3*g*g)*a*a*a*a*a*a/720);d*=CMProjectorUTM.rad2deg;a=(a-(1+2*f+g)*a*a*a/6+(5-2*g+28*f-3*g*g+8*c+24*f*f)*a*a*a*a*a/120)/Math.cos(h);a=b+a*CMProjectorUTM.rad2deg;
-180>a&&(a=-180);180<a&&(a=180);-90>d&&(d=-90);90<d&&(d=90);c={Longitude:a,Latitude:d}}return c};CMProjectorUTM.prototype.GetBounds=function(){return{East:-80,West:-160,North:90,South:-90}};
CMProjectorUTM.prototype.GetUTMZoneFromLonLat=function(a,b){LongTemp=a+180-360*parseInt((a+180)/360)-180;a=parseInt((LongTemp+180)/6)+1;56<=b&&64>b&&3<=LongTemp&&12>LongTemp&&(a=32);72<=b&&84>b&&(0<=LongTemp&&9>LongTemp?a=31:9<=LongTemp&&21>LongTemp?a=33:21<=LongTemp&&33>LongTemp?a=35:33<=LongTemp&&42>LongTemp&&(a=37));return a};CMProjectorUTM.prototype.GetSouthFromLat=function(a){var b=!1;0>a&&(b=!0);return b};
CMProjectorUTM.prototype.GetUTMZoneFromEPSG=function(a){var b=0;a>=CMProjector.EPSG_WGS84_UTM_1_NORTH&&a<=CMProjector.EPSG_WGS84_UTM_1_NORTH+59?b=a-CMProjector.EPSG_WGS84_UTM_1_NORTH+1:a>=CMProjector.EPSG_WGS84_UTM_1_SOUTH&&a<=CMProjector.EPSG_WGS84_UTM_1_SOUTH+59&&(b=a-CMProjector.EPSG_WGS84_UTM_1_SOUTH+1);return b};CMProjectorUTM.prototype.GetSouthFromEPSG=function(a){var b=!1;a>=CMProjector.EPSG_WGS84_UTM_1_SOUTH&&a<=CMProjector.EPSG_WGS84_UTM_1_SOUTH+59&&(b=!0);return b};
CMProjectorUTM.prototype.GetEPSGFromUTM=function(a,b){return 0==b?CMProjector.EPSG_WGS84_UTM_1_NORTH+a-1:CMProjector.EPSG_WGS84_UTM_1_SOUTH+a-1};CMScaleBar.UNITS_ISO=0;CMScaleBar.UNITS_ENGLISH=1;
CMScaleBar.SettingDefintions={ScaleBar:{strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},lineWidth:{Name:"Line Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},
shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y",Type:CMBase.DATA_TYPE_FLOAT,Default:1}},UnitText:{Text:{Name:"Text",Type:CMBase.DATA_TYPE_STRING,Default:null},font:{Name:"Font",Type:CMBase.DATA_TYPE_FONT,Default:"12px Arial"},strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},
fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"}},Rectangle:{Coordinates:{Name:"Coordinates",Type:CMBase.DATA_TYPE_COORDINATES,Default:null}},RoundedRectangle:{RoundedCornerWidth:{Name:"Corner Width",
Type:CMBase.DATA_TYPE_FLOAT,Default:3},RoundedCornerHeight:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:3}},Factors:{UnitFontHeightFactor:{Name:"Corner Width",Type:CMBase.DATA_TYPE_FLOAT,Default:.35},LabelFontHeightFactor:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:.3},ScaleBarHeightFactor:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:.3},ScaleBarBaseLineFromBottomFactor:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:.2},Units:{Name:"Units",Type:CMBase.DATA_TYPE_ENUMERATED,
Options:[CMScaleBar.UNITS_ISO,CMScaleBar.UNITS_ENGLISH],Default:CMScaleBar.UNITS_ISO},Margin:{Name:"Margin",Type:CMBase.DATA_TYPE_FLOAT,Default:4}}};
function CMScaleBar(a,b,c,d){CMItem.call(this);this.TimeSlices[0].Settings.Rectangle={Coordinates:{Xs:[0,10],Ys:[0,10]}};this.TimeSlices[0].Settings.RoundedRectangle={RoundedCornerWidth:3,RoundedCornerHeight:3};this.TimeSlices[0].Settings.UnitText={};this.TimeSlices[0].Settings.ScaleBar={};this.TimeSlices[0].Settings.Factors={UnitFontHeightFactor:.35,LabelFontHeightFactor:.3,ScaleBarHeightFactor:.3,ScaleBarBaseLineFromBottomFactor:.2,Units:CMScaleBar.UNITS_ISO,Margin:4};this.RightSticky=this.BottomSticky=
null}CMScaleBar.prototype=Object.create(CMItem.prototype);CMScaleBar.prototype.contructor=CMScaleBar;CMScaleBar.RemovePixels=function(a){var b="";if(null!=a){a=a.split(" ");for(var c=0;c<a.length;c++)-1==a[c].indexOf("px")&&(""!=b&&(b+=" "),b+=a[c])}return b};CMScaleBar.prototype.SetRightSticky=function(a){this.RightSticky=a};CMScaleBar.prototype.GetRightSticky=function(){return this.RightSticky};CMScaleBar.prototype.SetBottomSticky=function(a){this.BottomSticky=a};
CMScaleBar.prototype.GetBottomSticky=function(){return this.BottomSticky};CMScaleBar.prototype.ViewMoved=function(a){};
CMScaleBar.prototype.Paint=function(a){a=this.GetSetting("Rectangle","Coordinates");var b=a.Xs[0],c=a.Xs[1],d=a.Ys[0]+a.Ys[1]/2,e=a.Xs[1]-a.Xs[0],f=a.Ys[0],g=a.Ys[1]-a.Ys[0],h=this.GetParent(CMScene);a=h.GetView(0);var k=a.GetRefXFromPixelX(b);d=a.GetRefYFromPixelY(d);var l=a.GetRefXFromPixelX(c),m=d;h=h.GetCanvasMap().GetProjector();if(null!=h){var p=h.ProjectToGeographic(k,d);k=p.Longitude;d=p.Latitude;p=h.ProjectToGeographic(l,m);l=p.Longitude;m=p.Latitude}k=k/180*Math.PI;d=d/180*Math.PI;l=l/180*
Math.PI;m=m/180*Math.PI;p=6371*Math.acos(Math.sin(d)*Math.sin(m)+Math.cos(d)*Math.cos(m)*Math.cos(Math.abs(l-k)));r==CMScaleBar.UNITS_ENGLISH&&(p*=.621371);k=a.TheContext;h=this.GetSettingGroup("Factors");var q=h.UnitFontHeightFactor;m=h.LabelFontHeightFactor;l=h.ScaleBarHeightFactor;var n=h.ScaleBarBaseLineFromBottomFactor;d=h.Margin;var r=h.Units;h=this.GetSetting("Text","font");h=CMScaleBar.RemovePixels(h);h=""+g*m+"px "+h;k.font=h;m=k.measureText("0").width;var w=e-m/2-2*d,v=p/e;e=Math.log10(v*
w);e=Math.ceil(e);e=Math.pow(10,e);var y=1;p="km";r==CMScaleBar.UNITS_ENGLISH&&(p="miles");r=this.GetSetting("UnitText","font");CMScaleBar.RemovePixels(r);r=""+g*q+"px "+this.TheUnitFontSetting;k.font=r;var u=k.measureText(p).width;for(var z=!1,x=0;0==z&&100>x;){1>e&&("km"==p||"miles"==p)&&("km"==p?(e*=1E3,p="m",v*=1E3):(e*=1E4,p="ft",v*=1E4),k.font=r,u=k.measureText(p).width);q=""+e;k.font=h;var t=k.measureText(q).width;q=e/v;q=t/2>u?q+t/2:q+u;q<w?z=!0:("m"==p||"ft"==p)&&.01>=e?z=!0:1==y?(y=5,e/=
2):5==y?(y=2,e=2*e/5):(y=1,e/=2);x+=1}q=e/v;v=b+d+m/2;w=v+q;n=f+g-g*n;t=this.GetStyle(a,0,"Style");y=this.GetStyle(a,0,"Text");u=this.GetStyle(a,0,"UnitText");z=this.GetStyle(a,0,"ScaleBar");x=this.GetSetting("RoundedRectangle","RoundedCornerWidth");var B=this.GetSetting("RoundedRectangle","RoundedCornerHeight");a.SetStyle(t);a.PaintRoundedRect(b,c,f,f+g,x,B);a.RestoreStyle();a.SetStyle(u);k.font=r;k.fillText(p,v+q+d,n);a.RestoreStyle();a.SetStyle(z);k.beginPath();k.moveTo(v,n);k.lineTo(w,n);k.stroke();
b=g*l;k.beginPath();k.moveTo(v,n);k.lineTo(v,n-b);k.stroke();k.beginPath();k.moveTo(w,n);k.lineTo(w,n-b);k.stroke();a.RestoreStyle();a.SetStyle(y);k.font=h;b=n-b-d;k.fillText("0",v-m/2,b);q=""+e;t=k.measureText(q).width;k.fillText(q,w-t/2,b);a.RestoreStyle()};CMScaleBar.CheckFit=function(a,b){};CMScene.MESSAGE_LAYER_LIST_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_LAYER_CONTENT_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_LAYER_SETTINGS_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_BACKGROUNDS_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_TIME_SLICES_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_TIME_RANGE_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_SELECTION_CHANGED=CMBase.GetUniqueNumber();
CMScene.SettingDefintions={Fill:{fillStyle:{Name:"Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"}}};function CMScene(a){CMItem.call(this);this.SetParent(a);this.Views=[];this.Layers=[];this.Backgrounds=[];this.SelectedBackgroundIndex=-1;this.MapElements=[];this.TimeSlices=[{Time:0,Settings:{Fill:{fillStyle:"rgb(210,220,255)"}}}];this.TheProjector=null;this.MinTime=0;this.Times=[0];this.TheBounds=null;this.NumRepaintBlocks=0;this.NeedRepaint=!1}CMScene.prototype=Object.create(CMItem.prototype);
CMScene.prototype.contructor=CMScene;CMScene.prototype.GetView=function(a){return this.Views[a]};CMScene.prototype.GetNumViews=function(){return this.Views.length};CMScene.prototype.GetCanvasMap=function(){return this.GetParent(CMMainContainer)};CMScene.prototype.GetTimes=function(a){return this.Times};
CMScene.prototype.AddBackground=function(a){-1==this.SelectedBackgroundIndex&&(this.SelectedBackgroundIndex=0);a.SetParent(this);var b=this.Backgrounds.length;this.Backgrounds[b]=a;this.SendMessageToListeners(CMScene.MESSAGE_BACKGROUNDS_CHANGED);return b};CMScene.prototype.SetSelectedBackgroundIndex=function(a){-1!=this.SelectedBackgroundIndex&&this.Backgrounds[this.SelectedBackgroundIndex].SetVisible(!1);this.SelectedBackgroundIndex=a;-1!=a&&this.Backgrounds[a].SetVisible(!0);this.Repaint()};
CMScene.prototype.GetSettingsDefinitions=function(){var a={};for(Key in CMScene.SettingDefintions)a[Key]=CMScene.SettingDefintions[Key];return a};CMScene.prototype.AddLayer=function(a){a.SetParent(this);var b=this.Layers.length;this.Layers[b]=a;a=a.GetTimes(this.Times);for(Time in a)-1==this.Times.indexOf(Time)&&this.InsertTime(Time);this.LayerListChanged();return b};CMScene.prototype.GetNumLayers=function(){return this.Layers.length};CMScene.prototype.GetLayer=function(a){return this.Layers[a]};
CMScene.prototype.GetLayerIndex=function(a){for(var b=-1,c=0;c<this.Layers.length;c++)this.Layers[c]==a&&(b=c);return b};CMScene.prototype.MoveLayerUp=function(a){var b=this.Layers[a];0<=a&&(this.Layers[a]=this.Layers[a-1],this.Layers[a-1]=b);this.LayerListChanged();this.Repaint()};CMScene.prototype.MoveLayerDown=function(a){var b=this.Layers[a];a<this.Layers.length&&(this.Layers[a]=this.Layers[a+1],this.Layers[a+1]=b);this.LayerListChanged();this.Repaint()};
CMScene.prototype.DeleteLayer=function(a){a=this.Layers.splice(a,1);this.LayerListChanged();this.Repaint();return a};CMScene.prototype.MoveLayer=function(a,b){var c=this.GetLayerIndex(a);0>b&&(b=0);b>=this.Layers.length&&(b=this.Layers.length-1);if(b<c){for(;c>b;c--)this.Layers[c]=this.Layers[c-1];this.Layers[b]=a}else if(b>c){for(;c<b;c++)this.Layers[c]=this.Layers[c+1];this.Layers[b]=a}this.LayerListChanged();this.Repaint()};
CMScene.prototype.GetSearchResults=function(a,b){for(var c=0;c<this.Layers.length;c++)this.Layers[c].GetSearchResults(a,b)};CMScene.prototype.AddMapElement=function(a){this.MapElements.push(a);a.SetParent(this)};CMScene.prototype.AddView=function(a){a.SetParent(this);this.Views[this.Views.length]=a;this.SetTimeRange(0)};
CMScene.prototype.ViewMoved=function(a){for(var b=0;b<this.Backgrounds.length;b++)this.Backgrounds[b].ViewMoved(a);for(b=0;b<this.Layers.length;b++)this.Layers[b].ViewMoved(a);for(b=0;b<this.MapElements.length;b++)this.MapElements[b].ViewMoved(a)};CMScene.prototype.SetTimeRange=function(a){this.MinTime=a;this.SendMessageToListeners(CMScene.MESSAGE_TIME_RANGE_CHANGED)};CMScene.prototype.GetTimeRange=function(){return this.MinTime};
CMScene.prototype.In=function(a,b,c,d){for(var e=null,f=this.Layers.length-1;0<=f&&null==e;f--){var g=this.Layers[f].In(a,b,c,d);-1!=g&&(e={LayerIndex:f,FeatureIndex:g})}return e};CMScene.prototype.MouseDown=function(a,b,c,d){for(var e=!1,f=this.Layers.length-1;0<=f&&0==e;f--)e=this.Layers[f].MouseDown(a,b,c,d);return e};CMScene.prototype.MouseMove=function(a,b,c,d){for(var e=!1,f=this.Layers.length-1;0<=f&&0==e;f--)e=this.Layers[f].MouseMove(a,b,c,d);return e};
CMScene.prototype.MouseUp=function(a,b,c,d){for(var e=!1,f=this.Layers.length-1;0<=f&&0==e;f--)e=this.Layers[f].MouseUp(a,b,c,d);return e};
CMScene.prototype.Resize=function(a){for(var b,c,d=0;d<this.Layers.length;d++)this.Layers[d].Resize(a);for(d=0;d<this.MapElements.length;d++){var e=this.MapElements[d];a=e.GetRightSticky();if(null!=a)if(c=this.GetCanvasMap().GetElement(CMMainContainer.CANVAS),c=jQuery(c).width(),a.MoveFlag){var f=b.Xs[1]-b.Xs[0];b.Xs[0]=c-a.Offset-f;b.Xs[1]=b.Ys[0]+f}else b.Xs[1]=c-a.Offset;a=e.GetBottomSticky();null!=a&&(c=this.GetCanvasMap().GetElement(CMMainContainer.CANVAS),c=jQuery(c).height(),b=e.GetSetting("Rectangle",
"Coordinates"),a.MoveFlag?(e=b.Ys[1]-b.Ys[0],b.Ys[0]=c-a.Offset-e,b.Ys[1]=b.Ys[0]+e):b.Ys[1]=c-a.Offset)}for(d=0;d<this.Views.length;d++)this.Views[d].Resize();this.Repaint()};
CMScene.prototype.Paint=function(a){if(0==this.NumRepaintBlocks){this.GetCanvasMap().AddToDebugPanel("CMScene.Paint Starting:"+CMUtilities.GetSeconds());this.NeedRepaint=!1;this.IncrementRepaintBlocks();a.PaintStart();var b=this.GetStyle(a,0,"Fill");void 0!=b&&(a.SetStyle(b),a.PaintBackground(),a.RestoreStyle());-1!=this.SelectedBackgroundIndex&&this.Backgrounds[this.SelectedBackgroundIndex].Paint(a);for(b=0;b<this.Layers.length;b++)this.Layers[b].Paint(a);for(b=0;b<this.Layers.length;b++)this.Layers[b].PaintSelected(a);
for(b=0;b<this.MapElements.length;b++)this.MapElements[b].Paint(a);a.PaintEnd();this.DecrementRepaintBlocks();this.GetCanvasMap().AddToDebugPanel("CMScene.Paint Done: "+CMUtilities.GetSeconds());this.NeedRepaint&&this.Repaint()}else this.GetCanvasMap().AddToDebugPanel("CMScene.Paint NeedRepaint=true: "+CMUtilities.GetSeconds()),this.NeedRepaint=!0};
CMScene.prototype.Repaint=function(){for(var a=0;a<this.Views.length;a++)this.Paint(this.Views[a]);this.GetCanvasMap().AddToDebugPanel("CMScene.Repaint Exit:"+CMUtilities.GetSeconds())};CMScene.prototype.IncrementRepaintBlocks=function(){this.NumRepaintBlocks++};CMScene.prototype.DecrementRepaintBlocks=function(){this.NumRepaintBlocks--};CMScene.prototype.LayerListChanged=function(){this.SendMessageToListeners(CMScene.MESSAGE_LAYER_LIST_CHANGED,this)};
CMScene.prototype.LayerContentChanged=function(a){this.SendMessageToListeners(CMScene.MESSAGE_LAYER_CONTENT_CHANGED,a)};CMScene.prototype.LayerSettingsChanged=function(a){this.SendMessageToListeners(CMScene.MESSAGE_LAYER_SETTINGS_CHANGED,a);this.Repaint()};CMScene.prototype.SelectionChanged=function(a){this.SendMessageToListeners(CMScene.MESSAGE_SELECTION_CHANGED,a);this.Repaint()};CMScene.prototype.SetProjector=function(a){this.TheProjector=a};CMScene.prototype.GetProjector=function(){return this.TheProjector};
CMScene.prototype.SetBoundsDirty=function(){this.TheBounds=null};CMScene.prototype.GetBounds=function(){if(null!=this.Layers&&null==this.TheBounds)for(var a=0;a<this.Layers.length;a++){var b=this.Layers[a];null==this.TheBounds&&null!=b.TheBounds?this.TheBounds=CMUtilities.CloneBounds(b.TheBounds):null!=b.TheBounds&&CMUtilities.AddToBounds(this.TheBounds,b.TheBounds)}return this.TheBounds};CMScene.prototype.InsertTime=function(a){a=parseFloat(a);CMUtilities.InsertIntoSortedArray(this.Times,a);this.SendMessageToListeners(CMScene.MESSAGE_TIME_SLICES_CHANGED)};
CMScene.prototype.DeleteTime=function(a){a=parseFloat(a);a=this.Times.indexOf(a);-1!=a&&this.Times.splice(a,1);this.SendMessageToListeners(CMScene.MESSAGE_TIME_SLICES_CHANGED)};CMScene.prototype.CMItem_UnselectAll=CMItem.prototype.UnselectAll;CMScene.prototype.UnselectAll=function(a){this.CMItem_UnselectAll(a);for(var b=0;b<this.Layers.length;b++)this.Layers[b].UnselectAll(a)};CMTile.UPPER_RIGHT=-1;CMTile.LOWER_RIGHT=-2;CMTile.LOWER_LEFT=-3;CMTile.UPPER_LEFT=-4;CMTile.NumTilesLoaded=0;function CMTile(a,b,c,d){this.GlobalRow=d;this.GlobalColumn=c;this.ZoomLevel=b;this.ChildTiles=this.TheRasterRequest=this.TheRaster=this.TheData=null;this.TheDataset=a;this.LoadStatus=CMDataset.LOAD_STATUS_NONE;this.TheRequest=null;this.PaintTileInfo=!1}
CMTile.prototype.LoadTile=function(a){var b="Tiles_"+this.ZoomLevel+"/"+this.GlobalColumn+"/"+this.GlobalRow+".js";this.TheDataset.GetParent(CMMainContainer).AddToDebugPanel(this.TheDataset.GetName()+" Requesting tile "+b+", "+CMUtilities.GetSeconds());var c=this.TheDataset.URL+b,d=new XMLHttpRequest;this.TheRequest=d;d.open("GET",c,!0);d.TheView=a;d.TheURL=c;d.TheDataset=this.TheDataset;d.TheTile=this;d.FileName=b;this.LoadStatus=CMDataset.LOAD_STATUS_LOADING;d.onreadystatechange=function(){if(4==
this.readyState)if(200==this.status){var a=JSON.parse(this.responseText),b=this.TheTile;CMTile.NumTilesLoaded++;b.TheData=a;b.LoadStatus=CMDataset.LOAD_STATUS_LOADED;"HaveRaster"in b.TheData&&b.TheData.HaveRaster&&b.LoadTileRaster(this.TheView);if(0<b.TheData.NumChildTiles)for(a=0;2>a;a++)for(var c=0;2>c;c++)if(0<b.TheData.ChildTiles[a][c]){null==b.ChildTiles&&(b.ChildTiles=[],b.ChildTiles[0]=[null,null],b.ChildTiles[1]=[null,null]);var d=new CMTile(this.TheDataset,b.ZoomLevel+1,2*b.GlobalColumn+
c,2*b.GlobalRow+(1-a));this.PaintTileInfo&&d.SetPaintTileInfo(this.PaintTileInfo);b.ChildTiles[a][c]=d}this.ZoomToBounds&&this.TheView.ZoomToBounds(this.TheDataset.GetBounds());this.TheDataset.GetParent(CMMainContainer).AddToDebugPanel(this.TheDataset.GetName()+" Received tile "+this.FileName+" repainting:"+CMUtilities.GetSeconds());this.TheDataset.GetParent(CMScene).Repaint()}else alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")")};d.send()};
CMTile.prototype.LoadTileRaster=function(a){a="Tiles_"+this.ZoomLevel+"/"+this.GlobalColumn+"/"+this.GlobalRow+".png";this.TheRaster=new Image;this.TheRaster.TheTile=this;a="Tiles_"+this.ZoomLevel+"/"+this.GlobalColumn+"/"+this.GlobalRow+".png";this.TheRasterRequest={LoadStatus:CMDataset.LOAD_STATUS_NONE,Type:CMDataset.REQUEST_TYPE_IMAGE,TheImage:this.TheRaster,src:this.TheDataset.URL+a,TheFunction:function(){this.TheTile.TheDataset.GetParent(CMScene).Repaint()}};this.TheRasterRequest.TheTile=this;
CMDataset.MakeRequest(this.TheRasterRequest)};CMTile.prototype.AddToFeatureBounds=function(a,b){if("Features"in this.TheData)for(var c=this.TheData.Features,d=!1,e=0;e<c.length&&0==d;e++){var f=c[e];if(f.LayerFeatureIndex==a){d=!0;f=f.Areas;for(var g=0;g<f.length;g++)for(var h=f[g],k=h.Polys,l=0;l<k.length;l++){var m=this.GetPolygonCoordinates(h,l,null);m=CMUtilities.GetPolygonBounds(m.Xs,m.Ys,m.Xs.length);b=CMUtilities.AddToBounds(b,m)}}}return b};
CMTile.prototype.In=function(a,b,c){var d=-1;if(null!=this.TheData&&"Features"in this.TheData)for(var e=this.TheData.Features,f=0;f<e.length&&-1==d;f++){a.GetExtent();for(var g=e[f].Areas,h=0;h<g.length&&-1==d;h++)for(var k=g[h],l=k.Polys,m=0;m<l.length&&-1==d;m++){var p=this.GetPolygonCoordinates(k,m,null);CMUtilities.InsideAPolygon(b,c,p.Xs,p.Ys,p.Xs.length)&&(d=f)}}return d};
CMTile.prototype.MouseDown=function(a,b,c){var d=!1;if(null!=this.TheData&&(a.GetTool()==CMView.TOOL_INFO||a.GetTool()==CMView.TOOL_SELECT))if("Features"in this.TheData){var e=this.In(a,b,c);-1!=e&&(this.TheDataset.ShowInfoWindow(e,a,b,c),d=!0)}else if("TheColor"in this.TheData){if(null!=this.TheRaster){var f=this.TheDataset.TileRefWidth/Math.pow(2,this.ZoomLevel),g=this.GlobalRow*f;e=parseInt((b-this.GlobalColumn*f)/f*256);f=parseInt((g-c)/f*256);0<=e&&256>e&&0<=f&&256>f&&(d="Pixel X:"+e+" Y: "+
f,g=document.createElement("canvas"),g.width=this.TheRaster.width,g.height=this.TheRaster.height,g=g.getContext("2d"),g.drawImage(this.TheRaster,0,0),e=g.getImageData(e,f,1,1),d+=" Value:"+e.data[0]+","+e.data[1]+","+e.data[2],d=a.CreateInfoWindow("CMTile.InfoWindow",b,c,200,30,d),CMMainContainer.SetPopupWindow(d),d=!0)}if(0==d&&0<this.TheData.NumChildTiles)for(e=0;2>e;e++)for(f=0;2>f;f++)0<this.TheData.ChildTiles[e][f]&&(d=this.ChildTiles[e][f].MouseDown(a,b,c))}return d};
CMTile.prototype.CheckPaintTile=function(a,b){var c=a.GetPixelWidthFromRefWidth(b);b=!1;if(this.TheDataset.PaintDebugTile)this.TheDataset.DebugZoomLevel==this.ZoomLevel&&this.TheDataset.DebugGlobalColumn==this.GlobalColumn&&this.TheDataset.DebugGlobalRow==this.GlobalRow&&(b=!0);else if(0==b)if(256>=c&&(b=!0),null==this.ChildTiles)b=!0;else if(0<this.TheData.NumChildTiles){for(c=NumLoadedChildTiles=0;2>c;c++)for(var d=0;2>d;d++)if(0<this.TheData.ChildTiles[c][d]){var e=this.ChildTiles[c][d];e.LoadStatus==
CMDataset.LOAD_STATUS_NONE?(e.LoadTile(a),b=!0):e.LoadStatus==CMDataset.LOAD_STATUS_LOADING?b=!0:"Features"in this.TheData?NumLoadedChildTiles++:"TheColor"in this.TheData&&(null!=this.TheData.TheColor?NumLoadedChildTiles++:this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_LOADED?NumLoadedChildTiles++:this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_CANCELED&&this.LoadTileRaster(a))}else 0==this.TheData.ChildTiles[c][d]&&NumLoadedChildTiles++;4>NumLoadedChildTiles&&(b=!0)}return b};
CMTile.prototype.GetPolygonCoordinates=function(a,b,c){Result=null;var d=this.TheDataset.TileRefWidth/Math.pow(2,this.ZoomLevel),e=this.GlobalColumn*d,f=this.GlobalRow*d,g=e+d;d=f+d;var h=a.Edges;b=a.Polys[b];if(b.Closed)a=b.EdgeIndexes[0],e=h[a],null!=c&&(c[a]=!0),Result={Xs:e.Xs,Ys:e.Ys};else{for(var k=[],l=[],m=0,p=0;p<b.EdgeIndexes.length;p++)if(a=b.EdgeIndexes[p],0<=a){for(var q=h[a].Xs,n=h[a].Ys,r=0;r<q.length;r++)k[m]=q[r],l[m]=n[r],m++;null!=c&&(c[a]=!0)}else switch(a){case CMTile.UPPER_RIGHT:k[m]=
g;l[m]=d;m++;break;case CMTile.LOWER_RIGHT:k[m]=g;l[m]=f;m++;break;case CMTile.LOWER_LEFT:k[m]=e;l[m]=f;m++;break;case CMTile.UPPER_LEFT:k[m]=e,l[m]=d,m++}Result={Xs:k,Ys:l}}return Result};
CMTile.prototype.PaintTile=function(a,b,c,d){var e,f=0,g=1/Math.pow(2,this.ZoomLevel)*256,h=this.GlobalColumn*g,k=this.GlobalRow*g,l={XMin:h,XMax:h+g,YMax:k+g,YMin:k};if(CMUtilities.BoundsOverlap(l,b.GetExtent())&&null!=this.TheData){var m=d/2,p=0;if(this.CheckPaintTile(b,d)){if("Features"in this.TheData)for(a=this.TheData.Features,c=0;c<a.length;c++)for(b.GetExtent(),m=a[c].Areas,p=0;p<m.length;p++){var q=m[p];d=q.Edges;var n=q.Polys,r=[];for(e=0;e<d.length;e++)r[e]=!1;for(e=0;e<n.length;e++){var w=
this.GetPolygonCoordinates(q,e,r);b.PaintRefPoly2(w.Xs,w.Ys,!0,!1)}for(q=0;q<d.length;q++)for(n=d[q].Xs,r=d[q].Ys,e=1;e<n.length;e++)b.PaintRefLine(n[e-1],r[e-1],n[e],r[e])}"TheColor"in this.TheData&&(null==this.TheData.TheColor?null!=this.TheRasterRequest&&(this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_LOADED?b.PaintRefImageScaled(this.TheRaster,h,k+g,g,-g):this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_CANCELED&&this.LoadTileRaster(b)):(a=this.TheData.TheColor,null!==a&&(a="rgb("+
a[0]+","+a[1]+","+a[2]+")",a={fillStyle:""+a+"",lineWidth:0},null!=a&&b.SetStyle(a),b.PaintRefBounds(l),null!=a&&b.RestoreStyle())));this.PaintTileInfo&&(a={font:"20px Arial",fillStyle:"red",lineWidth:1,strokeColor:"red",strokeStyle:"#000"},null!=a&&b.SetStyle(a),b.PaintRefText(this.ZoomLevel+"_"+this.GlobalColumn+"_"+this.GlobalRow,h+g/2,k+g/2,20),b.PaintRefLine(h,k,h,k+g),b.PaintRefLine(h+g,k,h+g,k+g),b.PaintRefLine(h,k,h+g,k),b.PaintRefLine(h,k+g,h+g,k+g),null!=a&&b.RestoreStyle())}else if(0<this.TheData.NumChildTiles)for(g=
0;2>g;g++)for(h=0;2>h;h++)0<this.TheData.ChildTiles[g][h]&&(p+=this.ChildTiles[g][h].PaintTile(a,b,c,m));f++}return f};CMTile.prototype.SetPaintTileInfo=function(a){this.PaintTileInfo=a};function CMUtilities(){}CMUtilities.COORDINATE_UNITS_DD=0;CMUtilities.COORDINATE_UNITS_DMS=1;CMUtilities.COORDINATE_UNITS_METERS=2;CMUtilities.COORDINATE_UNITS_FEET=3;CMUtilities.COORDINATE_UNITS_PIXELS=4;CMUtilities.COORDINATE_UNITS_ZOOM=5;CMUtilities.QUANTILES=1;CMUtilities.IsDefined=function(a){var b=!0;if(void 0==a||null==a)b=!1;return b};CMUtilities.AbsolutePosition=function(a,b,c,d,e){a.style.position="absolute";a.style.left=b+"px";a.style.top=c+"px";a.style.width=d+"px";a.style.height=e+"px"};
CMUtilities.GetPopupMenu=function(a,b,c){var d=document.getElementById("LayerPopupMenu");null==d&&(d=document.createElement("DIV"),d.className=a,d.id="LayerPopupMenu",document.body.appendChild(d));for(;d.firstChild;)d.removeChild(d.firstChild);this.ThePopupMenu=d;d.style.position="absolute";d.style.left=b+"px";d.style.top=c+"px";CMMainContainer.SetPopupWindow(d);d.style.visibility="visible";return d};
CMUtilities.GetElementCoordinate=function(a,b,c){c=c.getBoundingClientRect();return{x:Math.round(a-c.left),y:Math.round(b-c.top)}};CMUtilities.GetTwoDigitHex=function(a){a=parseInt(a);a=a.toString(16);2>a.length&&(a="0"+a);return a};CMUtilities.GetRGBColorFromNamedColor=function(a){a=$("<div></div>").appendTo("body").css("background-color",a);var b=window.getComputedStyle(a[0]).backgroundColor;a.remove();return b};
CMUtilities.GetRGBAValuesFromRGBA=function(a){var b={Red:255,Green:255,Blue:255};if("undefined"!=typeof a){if(-1<a.indexOf("rgb")){var c=a.indexOf("(");a=a.substring(c+1);c=a.indexOf(")");a=a.substring(0,c)}a=a.split(",");b.Red=parseFloat(a[0]);b.Green=parseFloat(a[1]);b.Blue=parseFloat(a[2]);3<a.length&&(b.Transparency=parseFloat(a[3]))}return b};
CMUtilities.GetHexFromRGB=function(a){var b=CMUtilities.GetRGBAValuesFromRGBA(a);a=CMUtilities.GetTwoDigitHex(b.Red);var c=CMUtilities.GetTwoDigitHex(b.Green);b=CMUtilities.GetTwoDigitHex(b.Blue);return"#"+a+c+b};CMUtilities.GetHexColorFromColor=function(a){void 0!=a&&(a=""+a,-1<a.indexOf("rgb")?a=CMUtilities.GetHexFromRGB(a):"0"<=a.charAt(0)&&"9">=a.charAt(0)?a=CMUtilities.GetHexFromRGB(a):-1==a.indexOf("#")&&(a=CMUtilities.GetRGBColorFromNamedColor(a),a=CMUtilities.GetHexFromRGB(a)));return a};
CMUtilities.GetRGBFromHex=function(a){var b=a.substring(1,3),c=a.substring(3,5);a=a.substring(5,7);return{Red:parseInt(b,16),Green:parseInt(c,16),Blue:parseInt(a,16),Transparency:1}};
CMUtilities.GetColorsFromAnyColor=function(a,b){var c={Red:255,Green:255,Blue:255};void 0!=a&&(a=""+a,-1<a.indexOf("rgb")?c=CMUtilities.GetRGBAValuesFromRGBA(a):"0"<=a.charAt(0)&&"9">=a.charAt(0)?(a=a.split(","),c.Red=parseFloat(a[0]),c.Green=parseFloat(a[1]),c.Blue=parseFloat(a[2]),3<a.length&&(c.Transparency=parseFloat(a[3]))):-1!=a.indexOf("#")?c=CMUtilities.GetRGBFromHex(a):-1==a.indexOf("#")&&(c=CMUtilities.GetRGBColorFromNamedColor(a),c=CMUtilities.GetRGBAValuesFromRGBA(c)),void 0!=b&&(c.Transparency=
b));return c};CMUtilities.GetRGBAFromAnyColor=function(a,b){a=CMUtilities.GetColorsFromAnyColor(a,b);return a=void 0==a.Transparency?"rgb("+a.Red+","+a.Green+","+a.Blue+")":"rgba("+a.Red+","+a.Green+","+a.Blue+","+a.Transparency+")"};
CMUtilities.GetColorsFromArrays=function(a,b,c){for(var d,e,f,g=CMUtilities.GetHistogram(a,1E3),h=[],k=[],l=[],m=0;m<b.length;m++){var p=CMUtilities.GetRGBFromHex(b[m]);h[m]=p.Red;k[m]=p.Green;l[m]=p.Blue}p=[];var q=[];if(void 0!=c){for(m=0;m<a.length;m++){e=0;for(b=a[m];b>c[e+1]&&e<c.length-1;)e++;e>=h.length&&(e=h.length-1);f=h[e];d=k[e];e=l[e];d="rgb("+f+","+d+","+e+")";p[m]=d}for(m=0;m<c.length;m++)q[m]=Math.round(c[m])+" to "+Math.round(c[m+1])}else{c=g.Min;g=g.Max-c;for(m=0;m<a.length;m++)e=
0,0!=g&&(e=parseInt((a[m]-c)/g*b.length)),f=h[e],d=k[e],e=l[e],d="rgb("+f+","+d+","+e+")",p[m]=d;for(m=0;m<b.length;m++)a=c+m*g,q[m]=a+" to "+(a+g)}return{LegendLabels:q,FeatureColors:p}};
CMUtilities.AddLegend=function(a,b,c,d,e,f,g){var h=document.createElement("DIV");var k="<div><table>";for(var l=0;l<b.length;l++)k+="<tr>",k+="<td>",k+="<div style='border:solid black 1px;background-color:"+b[l]+";width:12px;height:12px'></div>",k+="</td>",k+="<td>",k+="<div>"+c[l]+"</div>",k+="</td>",k+="<tr>";h.innerHTML=k+"</table>";a.appendChild(h);CMUtilities.AbsolutePosition(h,d,e,f,g);return h};
CMUtilities.GetMinMax=function(a){for(var b,c,d,e=0;e<a.length;e++)b=a[e],0==e?d=c=b:(b<c&&(c=b),b>d&&(d=b));return{Min:c,Max:d}};CMUtilities.GetHistogram=function(a,b){var c=CMUtilities.GetMinMax(a),d=c.Min;c=c.Max;for(var e=c-d,f=[],g=[],h=0;h<b;h++)f[h]=0,g[h]=d+e*h;if(0!=e)for(h=0;h<a.length;h++)Bin=Math.round((a[h]-d)/e*b),Bin>=b&&(Bin=b-1),f[Bin]++;return{Min:d,Max:c,Bins:f,Labels:g}};
CMUtilities.GetQuantiles=function(a,b){for(var c=a.Bins,d=0,e=0;e<c.length;e++)d+=c[e];d/=b;b=(a.Max-a.Min)/b;var f=[];f[0]=a.Min;var g=d,h=0;for(e=0;e<c.length;e++)h+=c[e],h>=g&&(f.push(a.Min+b*e),g+=d);f.push(a.Max);return f};CMUtilities.FlipArray=function(a){for(var b=[],c=a.length-1,d=0;d<=c;d++)b.push(a[c-d]);return b};CMUtilities.InsertIntoSortedArray=function(a,b,c){void 0==c&&(c=!1);var d=a.indexOf(b);if(-1!=d)c&&a.splice(d,0,b);else{for(d=0;d<a.length&&a[d]<b;)d++;a.splice(d,0,b)}};
CMUtilities.GetRegularPolygon=function(a,b,c,d,e){var f=null;if(0<a){f=[[],[]];var g=2*Math.PI/a;e=(e-180)*Math.PI*2/360;b=b/2/Math.cos(g/2);var h=e;for(var k=0;k<a;k++){e=b*Math.sin(h);var l=b*Math.cos(h);f[0][k]=c+e;f[1][k]=d+l;h+=g}}return f};
CMUtilities.GetStar=function(a,b,c,d,e){var f=null;if(0<a){f=[[],[]];var g=2*Math.PI/a/2;e=(e-180)*Math.PI*2/360;b=b/2/Math.cos(g/2);var h=b/2.5;var k=e;for(var l=0;l<a;l++){e=b*Math.sin(k);var m=b*Math.cos(k);f[0][2*l]=c+e;f[1][2*l]=d+m;k+=g;e=h*Math.sin(k);m=h*Math.cos(k);f[0][2*l+1]=c+e;f[1][2*l+1]=d+m;k+=g}}return f};CMUtilities.PositionControl=function(a,b,c,d){void 0!=b&&(a.style.position=b,a.style.left=c+"px",a.style.top=d+"px")};
CMUtilities.CreateSelectControl=function(a,b,c,d,e){for(var f=document.createElement("SELECT"),g=-1,h=0;h<a.length;h++){b==a[h]&&(g=h);var k=document.createElement("option");k.text=a[h];f.add(k)}-1!=g&&(f.selectedIndex=g);CMUtilities.PositionControl(f,c,d,e);return f};CMUtilities.CreateSliderControl=function(a,b,c,d,e,f){var g=document.createElement("input");g.type="range";g.min=a;g.max=b;g.value=c;CMUtilities.PositionControl(g,d,e,f);return g};
CMUtilities.CreateCheckboxControl=function(a,b,c,d){var e=document.createElement("input");e.type="checkbox";e.value=a;CMUtilities.PositionControl(e,b,c,d);return e};CMUtilities.CreateLabelControl=function(a,b,c,d){var e=document.createElement("div");e.innerHTML=a;CMUtilities.PositionControl(e,b,c,d);return e};
CMUtilities.CreateInfoWindow=function(a,b,c,d,e,f,g){e=document.getElementById(a);null!=e&&(document.body.removeChild(e),e=null);null==e&&(e=document.createElement("DIV"),e.id=a,document.body.appendChild(e));var h=window.innerHeight,k=$(window).scrollTop(),l=window.innerWidth,m=$(window).scrollLeft();a=!0;c<h/2&&(a=!1);var p=!1;b<l/2&&(p=!0);e.style.position="absolute";e.style.width=d+"px";e.style.left=p?b-28+m+"px":b+28+m-d+"px";a?e.style.bottom=h-c-k+10+"px":e.style.top=c+10+k+"px";b=document.createElement("div");
b.className="CM_InfoBox";b.innerHTML=f;b.style.padding="10px";e.appendChild(b);f=document.createElement("div");e.appendChild(f);f.style.position="absolute";p?f.style.left="20px":f.style.right="20px";0==a?(f.style.top="-13px",f.innerHTML="<img src='"+g+"Triangle_Up.png'></img>"):(f.style.bottom="-13px",f.innerHTML="<img src='"+g+"Triangle_Down.png'></img>");e.style.visibility="visible";return e};
CMUtilities.CreateInfoWindow2=function(a,b,c,d,e,f,g){d=document.getElementById(a);null!=d&&(document.body.removeChild(d),d=null);null==d&&(d=document.createElement("DIV"),d.className="CM_InfoContainer",d.id=a,document.body.appendChild(d));var h=window.innerHeight,k=$(window).scrollTop(),l=window.innerWidth,m=$(window).scrollLeft();a=!0;c<h/2&&(a=!1);e=!1;b<l/2&&(e=!0);e?d.style.left=b+m-20+"px":d.style.right=l-(b+m)-20+"px";a?d.style.bottom=h-c-k+"px":d.style.top=c+k+"px";b=document.createElement("div");
b.innerHTML=f;d.appendChild(b);f=document.createElement("div");a?(b.className="CM_InfoBoxAboveTriangle",f.innerHTML="<img src='../../Includes/"+g+"Triangle_Down.png'></img>",f.className=e?"CM_InfoArrowSW":"CM_InfoArrowSE"):(b.className="CM_InfoBoxBelowTriangle",f.innerHTML="<img src='../../Includes/"+g+"Triangle_Up.png'></img>",f.className=e?"CM_InfoArrowNW":"CM_InfoArrowNE");d.appendChild(f);d.style.visibility="visible";return d};
CMUtilities.ApplyToGeometryCoordinates=function(a,b,c){var d=0;if("Point"==a.type)b(c,a.coordinates);else if("MultiPoint"==a.type||"LineString"==a.type)for(var e=0;e<a.coordinates.length;e++)b(c,a.coordinates[e]);else if("Polygon"==a.type||"MultiLineString"==a.type)for(var f=0;f<a.coordinates.length;f++)for(e=0;e<a.coordinates[f].length;e++)b(c,a.coordinates[f][e]);else if("MultiPolygon"==a.type)for(f=0;f<a.coordinates.length;f++)for(e=0;e<a.coordinates[f].length;e++)for(var g=0;g<a.coordinates[f][e].length;g++)b(c,
a.coordinates[f][e][g]);else if("GeometryCollection"==a.type)for(e=0;e<a.geometries.length;e++)d+=GetNumGeoJSONCoordiantes(a.geometries[e]);return d};CMUtilities.UpdateGeoJSONCoordinateBounds=function(a,b){if(void 0!=b){var c=b[0];b=b[1];0==Object.keys(a).length?(a.XMin=c,a.XMax=c,a.YMin=b,a.YMax=b):(a.XMin>c&&(a.XMin=c),a.XMax<c&&(a.XMax=c),a.YMin>b&&(a.YMin=b),a.YMax<b&&(a.YMax=b))}};
CMUtilities.InGeoJSONPolygon=function(a,b,c){var d=!1,e=[],f=[];if(void 0!=c){for(d=0;d<c.length;d++){var g=c[d][1];e[d]=c[d][0];f[d]=g}d=CMUtilities.InsideAPolygon(a,b,e,f,c.length)}return d};CMUtilities.InGeoJSONPolyline=function(a,b,c,d){var e=!1;if(void 0!=c)for(var f=c[0][0],g=c[0][1],h=1;h<c.length&&0==e;h++){var k=c[h][0],l=c[h][1];CMUtilities.DistanceToSegment(f,g,k,l,a,b)<=d&&(e=!0);CMUtilities.DistanceToSegment(f,g,k,l,a,b);f=k;g=l}return e};
CMUtilities.GetSymbol=function(a,b){var c="N";b&&(c="E");0>a&&(c="S",b&&(c="W"));return c};CMUtilities.GetDMSFromDD=function(a,b,c,d){b=CMUtilities.GetSymbol(a,b);0>a&&(a=-a);var e=Math.floor(a),f="&deg;";!0===c&&(f="\u00b0");c=e+f;a=60*(a-e);e=Math.floor(a);if(!1===d||0!=e)if(c+=e+"' ",a=Math.floor(60*(a-e)),!1===d||0!=a)c+=a+'"';return c+(" "+b)};CMUtilities.GetDMSFromLonLat=function(a,b,c){a=CMUtilities.GetDMSFromDD(a,!0,c);return CMUtilities.GetDMSFromDD(b,!1,c)+" "+a};
CMUtilities.GetDMSFromLonLatJSObject=function(a,b){a=CMUtilities.GetDMSFromDD(a,!0);return{Latitude:CMUtilities.GetDMSFromDD(b,!1),Longitude:a}};CMUtilities.GetTextFromEastingNorthing=function(a,b){var c=CMUtilities.GetSymbol(a,!0),d=CMUtilities.GetSymbol(b,!1);0>a&&(a=-a);0>b&&(b=-b);return a+" "+c+" "+b+" "+d};
CMUtilities.BoundsOverlap=function(a,b){var c=!1;a.XMin<=b.XMax&&a.XMax>=b.XMin&&a.YMin<=b.YMax&&a.YMax>=b.YMin&&(void 0!=a.ZMin&&void 0!=b.ZMin?a.ZMin<=b.ZMax&&a.ZMax>=b.ZMin&&(c=!0):c=!0);return c};CMUtilities.CloneBounds=function(a){var b={XMin:a.XMin,XMax:a.XMax,YMin:a.YMin,YMax:a.YMax};void 0!=a.ZMin&&(b.ZMin=a.ZMin,b.ZMax=a.ZMax);return b};
CMUtilities.AddToBounds=function(a,b){null==a?a=b:null!=b&&(b.XMin<a.XMin&&(a.XMin=b.XMin),b.XMax>a.XMax&&(a.XMax=b.XMax),b.YMin<a.YMin&&(a.YMin=b.YMin),b.YMax>a.YMax&&(a.YMax=b.YMax),void 0!=b.ZMin&&(void 0==a.ZMin?(a.ZMin=b.ZMin,a.ZMax=b.ZMax):(b.ZMin<a.ZMin&&(a.ZMin=b.ZMin),b.ZMax>a.ZMax&&(a.ZMax=b.ZMax))));return a};
CMUtilities.DistanceToSegment=function(a,b,c,d,e,f){var g=(d-b)/(c-a),h=d-g*c,k=g*g+1,l=(-1*(-1*e-g*f)-g*h)/k;g=(g*(1*e+g*f)- -1*h)/k;b>d&&(h=b,b=d,d=h,h=a,a=c,c=h);h=null;g<b?h=Math.sqrt((e-a)*(e-a)+(f-b)*(f-b)):g>d?h=Math.sqrt((e-c)*(e-c)+(f-d)*(f-d)):g==b&&g==d&&(a<c?l<a?h=Math.sqrt((e-a)*(e-a)+(f-b)*(f-b)):l>c&&(h=Math.sqrt((e-c)*(e-c)+(f-d)*(f-d))):l<c?h=Math.sqrt((e-c)*(e-c)+(f-d)*(f-d)):l>a&&(h=Math.sqrt((e-a)*(e-a)+(f-b)*(f-b))));null===h&&(h=Math.sqrt((l-e)*(l-e)+(g-f)*(g-f)));return h};
CMUtilities.GetLineFactors=function(a,b,c,d){var e=[2];b==d?(a=b,c=0):a==c?(c=Double.POSITIVE_INFINITY,a=Double.NaN):(c=(d-b)/(c-a),a=b-a*c);e[0]=c;e[1]=a;return e};CMUtilities.FindNumLineCrossingsToTheRight=function(a,b,c,d,e,f){var g=0;b!=d&&(a>e||c>e)&&(b<f&&d>f||b>f&&d<f)&&(a==c?e<a&&g++:(Factors=CMUtilities.GetLineFactors(a,b,c,d),e<(f-Factors[1])/Factors[0]&&g++));return g};
CMUtilities.InsideAPolygon=function(a,b,c,d,e){for(var f=!1,g=0,h=0,k=0,l=0;l<e-1;l++)d[l+1]>d[l]?h=1:d[l+1]<d[l]&&(h=-1);var m=!1;d[e-1]==d[0]&&b==d[0]&&a<c[0]&&a<c[e-1]&&(m=!0);for(l=0;l<e;l++){var p=l+1;p==e&&(p=0);d[l]==d[p]?b==d[l]&&a<c[l]&&a<c[p]&&(m=!0):(d[p]>d[l]?k=1:d[p]<d[l]&&(k=-1),m?k==h&&g++:d[l]==b?a<c[l]&&k==h&&g++:g+=CMUtilities.FindNumLineCrossingsToTheRight(c[l],d[l],c[p],d[p],a,b),m=!1,h=k)}1==g%2&&(f=!0);return f};
CMUtilities.GetPolygonBounds=function(a,b,c){var d=null;if(0<c){d=a[0];for(var e=a[0],f=b[0],g=b[0],h=1;h<c;h++)a[h]<d&&(d=a[h]),a[h]>e&&(e=a[h]),b[h]<f&&(f=b[h]),b[h]>g&&(g=b[h]);d={XMin:d,XMax:e,YMin:f,YMax:g}}return d};CMUtilities.GetLength=function(a,b,c,d){return Math.sqrt((c-a)*(c-a)+(d-b)*(d-b))};CMUtilities.GetSeconds=function(){return(new Date).getTime()/1E3};
CMUtilities.Clone=function(a){var b=a;if(null!=a&&"object"===typeof a&&0=="isActiveClone"in a){b=a instanceof Date?new a.constructor:a.constructor();for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(a.isActiveClone=null,b[c]=CMUtilities.Clone(a[c]),delete a.isActiveClone)}return b};
CMUtilities.GetCoordinateString=function(a,b,c,d,e){var f="";switch(c){case CMUtilities.COORDINATE_UNITS_DD:null!=d&&(b=d.ProjectToGeographic(a,b),a=b.Longitude,b=b.Latitude);a=Math.floor(1E4*a)/1E4;b=Math.floor(1E4*b)/1E4;c=CMUtilities.GetSymbol(a,!0);d=CMUtilities.GetSymbol(b,!1);0>a&&(a=-a);0>b&&(b=-b);f+=""+b+"\u00b0 "+d+" "+a+"\u00b0 "+c;break;case CMUtilities.COORDINATE_UNITS_DMS:null!=d&&(b=d.ProjectToGeographic(a,b),a=b.Longitude,b=b.Latitude);f+=CMUtilities.GetDMSFromLonLat(a,b,!0);break;
case CMUtilities.COORDINATE_UNITS_FEET:case CMUtilities.COORDINATE_UNITS_METERS:f+=CMUtilities.GetTextFromEastingNorthing(a,b);break;case CMUtilities.COORDINATE_UNITS_PIXELS:PixelX=e.GetPixelXFromRefX(a);PixelY=e.GetPixelYFromRefY(b);f+=""+PixelX+", "+PixelY;break;case CMUtilities.COORDINATE_UNITS_ZOOM:f+=e.GetZoomLevel()}return f};function CMUtilityBezier(){}CMUtilityBezier.GetSecondOrderEndPoints3D=function(a,b,c,d,e,f,g,h,k,l){return CMUtilityBezier.GetSecondOrderEndPointsFromSlopes3D(a,b,c,d,e,f,g,(h-b)/2,(k-c)/2,(l-d)/2)};CMUtilityBezier.GetSecondOrderEndPointsFromSlopes3D=function(a,b,c,d,e,f,g,h,k,l){var m=a-1,p=[];p[0]=[m];p[1]=[m];p[2]=[m];h=-h;k=-k;l=-l;b=b-h-e;c=c-k-f;d=d-l-g;for(var q,n,r,w=0,v=1;v<a;v++)n=1-v/a,r=n*n,m=b*r+h*n+e,q=c*r+k*n+f,n=d*r+l*n+g,p[0][w]=m,p[1][w]=q,p[2][w]=n,w++;return p};
CMUtilityBezier.GetSecondOrderPoints2D=function(a,b,c,d,e,f,g,h,k){return CMUtilityBezier.GetSecondOrderPointsFromSlopes2D(a,d,e,f,g,(f-b)/2,(g-c)/2,(h-d)/2,(k-e)/2)};CMUtilityBezier.GetSecondOrderPointsFromSlopes2D=function(a,b,c,d,e,f,g,h,k){var l=a-1,m=[];m[0]=[l];m[1]=[l];l=2*(b-d)+f+h;d=3*(d-b)-2*f-h;h=2*(c-e)+g+k;e=3*(e-c)-2*g-k;for(var p,q,n,r=0,w=1;w<a;w++)p=w/a,q=p*p,n=q*p,k=l*n+d*q+f*p+b,p=h*n+e*q+g*p+c,m[0][r]=k,m[1][r]=p,r++;return m};CMView.TOOL_HAND=1;CMView.TOOL_INFO=2;CMView.TOOL_EDIT=3;CMView.TOOL_ADD=4;CMView.TOOL_SELECT=5;CMView.MESSAGE_MOUSE_MOVED=CMBase.GetUniqueNumber();function CMView(){CMItem.call(this);this.CurrentTool=CMView.TOOL_SELECT;this.CollisionChecking=!1;this.CollisionArray=this.TheContext=this.ToolHandler=this.TheCanvasElement=null}CMView.prototype=Object.create(CMItem.prototype);CMView.prototype.contructor=CMView;CMView.prototype.GetContext=function(){return this.TheContext};
CMView.prototype.MouseDown=function(a){CMMainContainer.HidePopupWindow();return!1};CMView.prototype.MouseMove=function(a){a||(a=window.event);this.SendMessageToListeners(CMView.MESSAGE_MOUSE_MOVED,a);return!1};CMView.prototype.MouseUp=function(a){a||(a=window.event);CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement);return!1};CMView.prototype.MouseWheel=function(a){CMMainContainer.HidePopupWindow();a||(a=window.event);a.preventDefault&&a.preventDefault();return!1};
CMView.prototype.GetCoordinateStringFromEvent=function(a,b){return Text};CMView.prototype.Setup=function(a,b){this.TheCanvasContainer=a;this.TheCanvasElement=b;this.TheContext=this.TheCanvasElement.getContext("2d");this.TheCanvasElement.style.cursor="crosshair";this.SetTool(CMView.TOOL_SELECT)};CMView.prototype.Resize=function(){var a=this.TheCanvasElement,b=a.parentNode,c=jQuery(b).width();b=jQuery(b).height();a.width=c;a.height=b};CMView.prototype.SetToolHandler=function(a){this.ToolHandler=a};
CMView.prototype.GetToolHandler=function(){return this.ToolHandler};CMView.prototype.GetCanvasElement=function(){return this.TheCanvasElement};CMView.prototype.GetCanvasContainer=function(){return this.TheCanvasContainer};
CMView.prototype.AddMouseEventHandlers=function(){var a=this.GetCanvasElement();a.TheView=this;a.addEventListener("mousedown",function(a){null!=this.TheView&&(this.TheView.MouseDown(a),a.stopPropagation())});a.addEventListener("mousemove",function(a){null!=this.TheView&&this.TheView.MouseMove(a)});a.addEventListener("mouseup",function(a){null!=this.TheView&&this.TheView.MouseUp(a)});var b=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";a.attachEvent?a.attachEvent("on"+b,function(a){CMMainContainer.HidePopupWindow();
a=window.event||a;return this.TheView.MouseWheel(a)}):a.addEventListener&&a.addEventListener(b,function(a){CMMainContainer.HidePopupWindow();a=window.event||a;return this.TheView.MouseWheel(a)},!1)};
CMView.prototype.AddMobileEvents=function(){var a=new Hammer(CanvasContainer);a.get("pan").set({direction:Hammer.DIRECTION_ALL});var b=new Hammer.Pinch;a.add([b]);a.TheView=this;a.on("pinch panleft panright panup pandown",function(b){var c=a.TheView,e=c.GetRefWidthFromPixelWidth(CMMainContainer.GESTURE_PAN),f=c.GetRefCenter(),g=f.RefX;f=f.RefY;MapHeader.innerHTML=b.type;"panup"==b.type?c.SetRefCenter(g,f-e):"pandown"==b.type?c.SetRefCenter(g,f+e):"panleft"==b.type?c.SetRefCenter(g+e,f):"panright"==
b.type?c.SetRefCenter(g-e,f):"pinch"==b.type&&(e=c.GetZoomLevel(),MapHeader.textContent=b.additionalEvent,"pinchin"==b.additionalEvent?c.ZoomTo(e-CMMainContainer.GESTURE_ZOOM):c.ZoomTo(e+CMMainContainer.GESTURE_ZOOM))})};
CMView.prototype.SetTool=function(a){switch(a){case CMView.TOOL_HAND:this.TheCanvasElement.style.cursor="move";break;case CMView.TOOL_INFO:case CMView.TOOL_SELECT:this.TheCanvasElement.style.cursor="crosshair";break;case CMView.TOOL_EDIT:this.TheCanvasElement.style.cursor="crosshair"}this.CurrentTool=a};CMView.prototype.GetTool=function(){return this.CurrentTool};
CMView.prototype.SetStyle=function(a,b){!1!==b&&this.TheContext.save();if(null!=a&&void 0!=a){this.TheContext.shadowBlur=0;for(var c in a)this.TheContext[c]=a[c]}};CMView.prototype.SaveStyle=function(){this.TheContext.save()};CMView.prototype.RestoreStyle=function(){this.TheContext.restore()};CMView.prototype.PaintStart=function(){this.CollisionChecking&&(this.CollisionArray=[])};
CMView.prototype.Paint=function(){this.TheContext.clearRect(0,0,this.TheCanvasElement.width,this.TheCanvasElement.height);this.GetParent(CMScene).Paint(this)};CMView.prototype.PaintEnd=function(){this.ResetCollisions()};CMView.prototype.CheckCollision=function(a){var b=!1;if(null!==this.CollisionArray)for(var c=0;c<this.CollisionArray.length&&0==b;c++)CMUtilities.BoundsOverlap(a,this.CollisionArray[c])&&(b=!0);return b};CMView.prototype.AddToCollisions=function(a){null!==this.CollisionArray&&this.CollisionArray.push(a)};
CMView.prototype.ResetCollisions=function(){this.CollisionArray=[]};CMView.prototype.GetTextWidthInPixels=function(a){return this.TheContext.measureText(a).width};CMView.prototype.PaintImage=function(a,b,c){this.TheContext.drawImage(a,b,c)};CMView.prototype.PaintBackground=function(){this.TheContext.fillRect(0,0,this.TheCanvasElement.width,this.TheCanvasElement.height)};
CMView.prototype.PaintCircle=function(a,b,c){this.TheContext.beginPath();this.TheContext.arc(a,b,c,0,2*Math.PI);null!=this.TheContext.strokeStyle&&this.TheContext.stroke();null!=this.TheContext.fillStyle&&this.TheContext.fill()};
CMView.prototype.PaintRect=function(a,b,c,d){null!=this.TheContext.fillStyle&&this.TheContext.fillRect(a,c,b-a,d-c);if(null!=this.TheContext.strokeStyle)if(null==this.TheContext.fillStyle||void 0==this.TheContext.shadowColor)this.TheContext.stroke();else{var e=this.TheContext.shadowColor;this.TheContext.shadowColor="rgba(0,0,0,0)";this.TheContext.strokeRect(a,c,b-a,d-c);this.TheContext.shadowColor=e}};
CMView.prototype.PaintArc=function(a,b,c,d,e,f){var g=(a+b)/2,h=(c+d)/2,k=(b-a)/2;this.TheContext.save();this.TheContext.translate(g,h);this.TheContext.scale(1,(d-c)/(b-a));this.TheContext.beginPath();this.TheContext.arc(0,0,k,e,f,!1);this.TheContext.restore();null!=this.TheContext.strokeStyle&&this.TheContext.stroke();null!=this.TheContext.fillStyle&&this.TheContext.fill()};
CMView.prototype.PaintRoundedRect=function(a,b,c,d,e,f){"undefined"===typeof f&&(f=e);this.TheContext.beginPath();this.TheContext.moveTo(a+e,c);this.TheContext.lineTo(b-e,c);this.TheContext.quadraticCurveTo(b,c,b,c+f);this.TheContext.lineTo(b,d-f);this.TheContext.quadraticCurveTo(b,d,b-e,d);this.TheContext.lineTo(a+e,d);this.TheContext.quadraticCurveTo(a,d,a,d-f);this.TheContext.lineTo(a,c+f);this.TheContext.quadraticCurveTo(a,c,a+e,c);this.TheContext.closePath();null!=this.TheContext.strokeStyle&&
this.TheContext.stroke();null!=this.TheContext.fillStyle&&this.TheContext.fill()};CMView.prototype.PaintText=function(a,b,c,d){void 0!=d?(this.TheContext.translate(a,b),this.TheContext.rotate(d),this.TheContext.fillText(c,0,0),this.TheContext.rotate(-d),this.TheContext.translate(-a,-b)):this.TheContext.fillText(c,a,b)};CMView2D.SettingDefintions={View2D:{MinZoom:{Name:"Min Zoom",Type:CMBase.DATA_TYPE_FLOAT,Default:-1E5},MaxZoom:{Name:"Max Zoom",Type:CMBase.DATA_TYPE_FLOAT,Default:1E5},MaxBounds:{Name:"Max Bounds",Type:CMBase.DATA_TYPE_COORDINATES,Default:1E5}}};function CMView2D(){CMView.call(this);this.RefY=this.RefX=0;this.TimeSlices[0].Settings.View2D={MinZoom:-1E5,MaxZoom:1E5,MaxBounds:null};this.ZoomLevel=0;this.MinScale=1;this.TheContext=this.ToolHandler=this.TheCanvasElement=null}CMView2D.prototype=Object.create(CMView.prototype);
CMView2D.prototype.contructor=CMView2D;CMView2D.prototype.CMView_GetSettingsDefinitions=CMView.prototype.GetSettingsDefinitions;CMView2D.prototype.GetSettingsDefinitions=function(){var a=this.CMView_GetSettingsDefinitions();for(Key in CMView2D.SettingDefintions)a[Key]=CMView2D.SettingDefintions[Key];return a};
CMView2D.prototype.CheckMaxBounds=function(){var a=this.GetScale(),b=this.TheCanvasElement.width*a;a*=-this.TheCanvasElement.height;var c=this.GetSetting("View2D","MaxBounds");null!=c&&(c.Xs[1]-c.Xs[0]<b?this.RefX=(c.Xs[1]+c.Xs[0])/2-b/2:(this.RefX<c.Xs[0]&&(this.RefX=c.Xs[0]),this.RefX+b>c.Xs[1]&&(this.RefX=c.Xs[1]-b)),c.Ys[1]-c.Ys[0]<-a?this.RefY=(c.Ys[1]+c.Ys[0])/2-a/2:(this.RefY>c.Ys[1]&&(this.RefY=c.Ys[1]),this.RefY+a<c.Ys[0]&&(this.RefY=c.Ys[0]-a)))};
CMView2D.prototype.GetScale=function(){return this.MinScale/Math.pow(2,this.ZoomLevel)};
CMView2D.prototype.AddMobileEvents=function(){var a=new Hammer(CanvasContainer);a.get("pan").set({direction:Hammer.DIRECTION_ALL});var b=new Hammer.Pinch;a.add([b]);a.TheView=this;a.on("pinch panleft panright panup pandown",function(b){var c=a.TheView,e=c.GetRefWidthFromPixelWidth(CMMainContainer.GESTURE_PAN),f=c.GetRefCenter(),g=f.RefX;f=f.RefY;MapHeader.innerHTML=b.type;"panup"==b.type?c.SetRefCenter(g,f-e):"pandown"==b.type?c.SetRefCenter(g,f+e):"panleft"==b.type?c.SetRefCenter(g+e,f):"panright"==
b.type?c.SetRefCenter(g-e,f):"pinch"==b.type&&(e=c.GetZoomLevel(),MapHeader.textContent=b.additionalEvent,"pinchin"==b.additionalEvent?c.ZoomTo(e-CMMainContainer.GESTURE_ZOOM):c.ZoomTo(e+CMMainContainer.GESTURE_ZOOM))})};
CMView2D.prototype.MouseDown=function(a){var b=!1;a||(a=window.event);CMMainContainer.HidePopupWindow();var c=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement),d=c.x;c=c.y;var e=this.GetRefXFromPixelX(d),f=this.GetRefYFromPixelY(c);null!=this.ToolHandler&&(b=this.ToolHandler.MouseDown(this,e,f,a));0==b&&this.CurrentTool==CMView.TOOL_HAND&&(this.DragX=this.GetRefXFromPixelX(d),this.DragY=this.GetRefYFromPixelY(c),b=this.Dragging=!0);0==b&&(b=this.GetParent(CMScene).MouseDown(this,
e,f,a));0==b&&(this.DragX=this.GetRefXFromPixelX(d),this.DragY=this.GetRefYFromPixelY(c),b=this.Dragging=!0);return b};
CMView2D.prototype.MouseMove=function(a){var b=!1;a||(a=window.event);var c=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement),d=c.x;c=c.y;this.SendMessageToListeners(CMView.MESSAGE_MOUSE_MOVED,a);1==this.Dragging?(a=this.GetRefWidthFromPixelWidth(d),c=this.GetRefHeightFromPixelHeight(c),this.RefX=this.DragX-a,this.RefY=this.DragY-c,this.CheckMaxBounds(),this.Paint()):(d=this.GetRefXFromPixelX(d),c=this.GetRefYFromPixelY(c),null!=this.ToolHandler&&(b=this.ToolHandler.MouseMove(this,
d,c,a)),0==b&&(b=this.GetParent(CMScene).MouseMove(this,d,c,a)));return b};CMView2D.prototype.MouseUp=function(a){var b=!1;a||(a=window.event);var c=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement),d=c.x;c=c.y;this.Dragging?(this.DragY=this.DragX=0,this.Dragging=!1):(d=this.GetRefXFromPixelX(d),c=this.GetRefYFromPixelY(c),null!=this.ToolHandler&&(b=this.ToolHandler.MouseUp(this,d,c,a)),0==b&&(b=this.GetParent(CMScene).MouseUp(this,d,c,a)));return b};
CMView2D.prototype.MouseWheel=function(a){CMMainContainer.HidePopupWindow();a||(a=window.event);var b=a.detail?-120*a.detail:a.wheelDelta;if(0!=b){var c=this.ZoomLevel;c=0<b?c+1:c-1;b=this.GetSetting("View2D","MinZoom");var d=this.GetSetting("View2D","MaxZoom");c<b&&(c=b);c>d&&(c=d);if(c!=this.ZoomLevel){b=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement);var e=b.x,f=b.y;b=this.GetRefXFromPixelX(e);d=this.GetRefYFromPixelY(f);this.ZoomLevel=c;c=this.GetRefWidthFromPixelWidth(e);
e=this.GetRefHeightFromPixelHeight(f);this.RefX=b-c;this.RefY=d-e;CMDataset.ResetRequests();this.Paint()}}a.preventDefault&&a.preventDefault();return!1};CMView2D.prototype.GetCoordinateStringFromEvent=function(a,b){var c=this.GetCanvasElement();a=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,c);c=a.y;a=this.GetRefXFromPixelX(a.x);c=this.GetRefYFromPixelY(c);var d=this.GetParent(CMMainContainer).GetProjector();return CMUtilities.GetCoordinateString(a,c,b,d,this)};
CMView2D.prototype.GetExtent=function(){var a={},b=this.GetScale();a.XMin=this.RefX;a.YMax=this.RefY;a.XMax=this.RefX+this.TheCanvasElement.width*b;a.YMin=this.RefY-this.TheCanvasElement.height*b;return a};
CMView2D.prototype.SetRefCenter=function(a,b){var c=this.GetScale(),d=this.TheCanvasElement.width*c;c*=-this.TheCanvasElement.height;this.RefX=a-d/2;this.RefY=b-c/2;null!=this.MaxBounds&&(this.RefX<this.MaxBounds.XMin&&(this.RefX=this.MaxBounds.XMin),this.RefY>this.MaxBounds.YMax&&(this.RefY=this.MaxBounds.YMax),this.RefX+d>this.MaxBounds.XMax&&(this.RefX=this.MaxBounds.XMax-d),this.RefY+c<this.MaxBounds.YMin&&(this.RefY=this.MaxBounds.YMin-c));this.Paint()};
CMView2D.prototype.GetRefCenter=function(){var a=this.GetScale();return{RefX:this.RefX+this.TheCanvasElement.width*a/2,RefY:this.RefY-this.TheCanvasElement.height*a/2}};
CMView2D.prototype.ZoomToBounds=function(a){if(null==a)alert("Sorry, you cannot call CMView2D.ZoomToBounds(NewBounds) with NewBounds=null.");else{var b=Math.abs(a.XMax-a.XMin)/this.TheCanvasElement.width,c=Math.abs(a.YMax-a.YMin)/this.TheCanvasElement.height;b<c&&(b=c);c=this.ZoomLevel;var d=this.GetSetting("View2D","MinZoom"),e=this.GetSetting("View2D","MaxZoom");this.ZoomLevel=20;this.ZoomLevel>e&&(this.ZoomLevel=e);for(;this.GetScale()<b&&this.ZoomLevel>d;)this.ZoomLevel--;this.ZoomLevel!=c&&CMDataset.ResetRequests();
this.SetRefCenter((a.XMax+a.XMin)/2,(a.YMin+a.YMax)/2)}};CMView2D.prototype.ZoomToMaxBounds=function(){var a=this.MaxBounds;null==a&&(a=this.GetParent(CMScene).GetBounds());null!=a&&this.ZoomToBounds(a)};CMView2D.prototype.ZoomIn=function(){this.ZoomTo(this.ZoomLevel+1)};CMView2D.prototype.ZoomOut=function(){this.ZoomTo(this.ZoomLevel-1)};
CMView2D.prototype.ZoomTo=function(a){var b=this.GetSetting("View2D","MinZoom"),c=this.GetSetting("View2D","MaxZoom");a<b&&(a=b);a>c&&(a=c);a!=this.ZoomLevel&&(b=this.GetRefXFromPixelX(this.TheCanvasElement.width/2),c=this.GetRefYFromPixelY(this.TheCanvasElement.height/2),this.ZoomLevel=a,CMDataset.ResetRequests(),this.SetRefCenter(b,c))};CMView2D.prototype.GetZoomLevel=function(){return this.ZoomLevel};CMView2D.prototype.GetPixelXFromRefX=function(a){var b=this.GetScale();return(a-this.RefX)/b};
CMView2D.prototype.GetPixelYFromRefY=function(a){var b=this.GetScale();return(this.RefY-a)/b};CMView2D.prototype.GetPixelFromRef=function(a,b){a=this.GetPixelXFromRefX(a);b=this.GetPixelYFromRefY(b);return{PixelX:a,PixelY:b}};CMView2D.prototype.GetPixelWidthFromRefWidth=function(a){var b=this.GetScale();return a/b};CMView2D.prototype.GetPixelHeightFromRefHeight=function(a){var b=this.GetScale();return-a/b};CMView2D.prototype.GetRefWidthFromPixelWidth=function(a){var b=this.GetScale();return a*b};
CMView2D.prototype.GetRefHeightFromPixelHeight=function(a){var b=this.GetScale();return-a*b};CMView2D.prototype.GetRefXFromPixelX=function(a){var b=this.GetScale();return a*b+this.RefX};CMView2D.prototype.GetRefYFromPixelY=function(a){var b=this.GetScale();return-(a*b-this.RefY)};CMView2D.prototype.PaintRefBounds=function(a){this.PaintRefRect(a.XMin,a.XMax,a.YMin,a.YMax)};
CMView2D.prototype.PaintRefRect=function(a,b,c,d){a=this.GetPixelFromRef(a,d);d=a.PixelX;var e=a.PixelY;a=this.GetPixelFromRef(b,c);this.PaintRect(d,a.PixelX,e,a.PixelY)};CMView2D.prototype.PaintRefArc=function(a,b,c,d,e,f){a=this.GetPixelFromRef(a,d);d=a.PixelX;var g=a.PixelY;a=this.GetPixelFromRef(b,c);this.PaintArc(d,a.PixelX,g,a.PixelY,e,f)};
CMView2D.prototype.PaintRefRoundedRect=function(a,b,c,d,e,f){var g=this.GetPixelFromRef(a,d);a=g.PixelX;d=g.PixelY;g=this.GetPixelFromRef(b,c);b=g.PixelX;c=g.PixelY;e=this.GetPixelWidthFromRefWidth(e);f=this.GetPixelWidthFromRefWidth(f);this.PaintRoundedRect(a,b,d,c,e,f)};CMView2D.prototype.PaintRefCircle=function(a,b,c){a=this.GetPixelFromRef(a,b);this.PaintCircle(a.PixelX,a.PixelY,c)};
CMView2D.prototype.PaintRefText=function(a,b,c,d,e,f){var g=this.GetTextWidthInPixels(a),h=this.GetRefWidthFromPixelWidth(g);void 0===f&&(f=0);var k=this.GetPixelXFromRefX(b),l=this.GetPixelYFromRefY(c);if(0===f){"center"===e?k=this.GetPixelXFromRefX(b-h/2):"right"===e&&(k=this.GetPixelXFromRefX(b-h));var m={XMin:k,XMax:k+g,YMin:l-d,YMax:l}}else f===Math.PI/2?(k=this.GetPixelXFromRefX(b),l="center"===e?this.GetPixelYFromRefY(c+h/2):"right"===e?this.GetPixelYFromRefY(c+h):this.GetPixelYFromRefY(c),
m={XMin:k,XMax:k+d,YMin:l,YMax:l+g}):f===-Math.PI/2?(k=this.GetPixelXFromRefX(b),l="center"===e?this.GetPixelYFromRefY(c-h/2):"right"===e?this.GetPixelYFromRefY(c-h):this.GetPixelYFromRefY(c),m={XMin:k-d,XMax:k,YMin:l-g,YMax:l}):alert("Sorry, rotations other than 0,PI/2 and -PI/2 are not supported at this time");0==this.CheckCollision(m)&&(this.AddToCollisions(m),this.PaintText(k,l,a,f))};
CMView2D.prototype.PaintRefLine=function(a,b,c,d){var e=this.GetPixelFromRef(a,b);a=e.PixelX;b=e.PixelY;e=this.GetPixelFromRef(c,d);c=e.PixelX;d=e.PixelY;this.TheContext.beginPath();this.TheContext.moveTo(a,b);this.TheContext.lineTo(c,d);this.TheContext.stroke()};
CMView2D.prototype.PaintRefPoly2=function(a,b,c,d){if(void 0!=a){for(var e,f,g,h,k=0;k<a.length;k++){Result=this.GetPixelFromRef(a[k],b[k]);var l=Result.PixelX;var m=Result.PixelY;0==k&&(this.TheContext.beginPath(),this.TheContext.moveTo(l,m),e=l,f=m,g=l,h=m);if(l!=g||m!=h)this.TheContext.lineTo(l,m),g=l,h=m}c&&(this.TheContext.lineTo(e,f),this.TheContext.fill());!0===d&&(0==c||void 0==this.TheContext.shadowColor?this.TheContext.stroke():(a=this.TheContext.shadowColor,this.TheContext.shadowColor=
"rgba(0,0,0,0)",this.TheContext.stroke(),this.TheContext.shadowColor=a))}};CMView2D.prototype.PaintRefImage=function(a,b,c){b=this.GetPixelFromRef(b,c);this.TheContext.drawImage(a,b.PixelX,b.PixelY)};
CMView2D.prototype.PaintRefImageScaled=function(a,b,c,d,e){"object"==typeof b&&(TheBounds=b,b=TheBounds.XMin,c=TheBounds.YMax,d=TheBounds.XMax-TheBounds.XMin,e=TheBounds.YMin-TheBounds.YMax);c=this.GetPixelFromRef(b,c);b=Math.round(c.PixelX);c=Math.round(c.PixelY);d=this.GetPixelWidthFromRefWidth(d);e=this.GetPixelHeightFromRefHeight(e);d=Math.round(d);e=Math.round(e);this.TheContext.drawImage(a,b,c,d,e)};
CMView2D.prototype.PaintRefPoly=function(a,b){if(void 0!=a){var c=a[0][0],d=a[0][1];d=this.GetPixelFromRef(c,d);c=Math.round(d.PixelX);d=Math.round(d.PixelY);this.TheContext.beginPath();this.TheContext.moveTo(c,d);for(var e=c,f=d,g=1;g<a.length;g++)if(c=a[g][0],d=a[g][1],d=this.GetPixelFromRef(c,d),c=Math.round(d.PixelX),d=Math.round(d.PixelY),c!=e||d!=f)this.TheContext.lineTo(c,d),e=c,f=d;b&&this.TheContext.fill();this.TheContext.stroke()}};
CMView2D.prototype.CreateInfoWindow=function(a,b,c,d,e,f){b=this.GetPixelXFromRefX(b);c=this.GetPixelYFromRefY(c);jQuery(this.TheCanvasElement).offset();var g=this.TheCanvasElement.getBoundingClientRect();b+=g.left;c+=g.top;g=this.GetParent(CMMainContainer).ImageFolder;return CMUtilities.CreateInfoWindow(a,b,c,d,e,f,g)};
