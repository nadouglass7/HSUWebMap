CMPanelLayerList.LAYER_LIST_ITEM_HEIGHT=24;CMPanelLayerList.LAYER_POPUP_MENU_ITEM_HEIGHT=24;function CMPanelLayerList(TheCanvasMap){CMBase.call(this);if(TheCanvasMap==undefined)alert("Sorry, the CMPanelLayerList requires a CanvasMap object on construction");this.SetParent(TheCanvasMap);var TheScene=TheCanvasMap.GetScene();TheScene.AddListener(CMScene.MESSAGE_LAYER_LIST_CHANGED,this,function(TheScene,TheListener,AdditionalInfo){TheListener.AddLayerList(TheScene);});this.TheElement=null;this.LayerListItemHeight=CMPanelLayerList.LAYER_LIST_ITEM_HEIGHT;this.LayerPopupMenuItemHeight=CMPanelLayerList.LAYER_POPUP_MENU_ITEM_HEIGHT;}CMPanelLayerList.prototype=Object.create(CMBase.prototype);CMPanelLayerList.prototype.contructor=CMPanelLayerList;CMPanelLayerList.prototype.AddLayerToList=function(TheElement,LayerIndex,Left,LayerInListTop,TheScene){var TheLayer=TheScene.Layers[LayerIndex];var LayerInList=document.createElement('div');LayerInList.className="CM_LayerListItemClass";TheElement.appendChild(LayerInList);var TheCheckBox=document.createElement('input');TheCheckBox.className="CM_LayerListCheckBoxClass";TheCheckBox.type="checkbox"
TheCheckBox.TheLayer=TheLayer;TheCheckBox.checked=TheLayer.GetVisible();TheCheckBox.addEventListener('click',function(){if(this.checked){this.TheLayer.SetVisible(true);}else{this.TheLayer.SetVisible(false);}});CMUtilities.AbsolutePosition(TheCheckBox,Left+2,-6,30,this.LayerListItemHeight);LayerInList.appendChild(TheCheckBox);var TheIcon=TheLayer.GetIcon();if(CMUtilities.IsDefined(TheIcon)){CMUtilities.AbsolutePosition(TheIcon,Left+28,-5,16,16);LayerInList.appendChild(TheIcon);}var TheLayerName=document.createElement('div');TheLayerName.className="CM_LayerListNameClass";var TheName=TheLayer.Name;if(TheName===null)TheName="Untitled";TheLayerName.innerHTML=TheName;TheLayerName.TheLayer=TheLayer;TheLayerName.TheScene=TheScene;TheLayerName.TheElement=TheElement;TheLayerName.LayerInList=LayerInList;TheLayerName.TheLayerList=this;CMUtilities.AbsolutePosition(TheLayerName,Left+48,0,170,this.LayerListItemHeight);this.DraggingDiv=null;document.addEventListener("contextmenu",function(event){event.preventDefault();return(false);});TheLayerName.addEventListener('mousedown',function(event){event.preventDefault();if(event.button==0){this.DraggingDiv=document.getElementById("DraggingDiv");if(this.DraggingDiv==null){this.DraggingDiv=document.createElement('div');this.DraggingDiv.className="CM_DraggingDivClass";this.DraggingDiv.id="DraggingDiv";}this.DraggingDiv.style.visibility="visible";this.TheElement.appendChild(this.DraggingDiv);this.TheElement.DraggingDiv=DraggingDiv;this.TheElement.DraggingLayer=this.TheLayer;var TheElementPosition=$(this.TheElement).offset();CMUtilities.AbsolutePosition(this.DraggingDiv,0,event.clientY-TheElementPosition.top,200,0);}else{var ThePopupMenu=CMUtilities.GetPopupMenu("CM_LayerPopupMenu",event.clientX,event.clientY);this.TheLayer.FillPopupMenu(ThePopupMenu);}event.stopPropagation();event.preventDefault();return(false);});TheLayerName.addEventListener('mouseup',function(event){event.preventDefault();return(false);});LayerInList.appendChild(TheLayerName);var LayerListWidth=jQuery(TheElement).outerWidth(false);CMUtilities.AbsolutePosition(LayerInList,Left+2,LayerInListTop,LayerListWidth,this.LayerListItemHeight);}
CMPanelLayerList.prototype.SetElement=function(TheElement){this.TheElement=TheElement;}
CMPanelLayerList.prototype.Setup=function(TheObject){var SettingsPopup=this.TheElement;while(SettingsPopup.hasChildNodes()){SettingsPopup.removeChild(SettingsPopup.lastChild);}}
CMPanelLayerList.prototype.AddLayerList=function(TheScene){TheElement=this.TheElement;TheElement.LayerListPanel=this;while(TheElement.firstChild){TheElement.removeChild(TheElement.firstChild);}var Left=TheElement.style.left;var Top=TheElement.style.top;Left=0;Top=0;var LayerInListTop=0;for(var i=0;(i<TheScene.Layers.length);i++){var LayerInListTop=Top+(i*this.LayerListItemHeight);this.AddLayerToList(TheElement,i,Left,LayerInListTop,TheScene);}TheElement.addEventListener('mousemove',function(event){if(this.DraggingDiv!=null){{var TheElementPosition=$(this).offset();CMUtilities.AbsolutePosition(this.DraggingDiv,0,event.clientY-TheElementPosition.top,200,0);}event.preventDefault();return(false);}});TheElement.addEventListener('mouseup',function(event){if(this.DraggingDiv!=null){event.preventDefault();var TheCanvasMap=this.LayerListPanel.GetParent();var TheScene=TheCanvasMap.GetScene();var TheElementPosition=$(this).offset();var NewY=event.clientY-TheElementPosition.top;var NewIndex=Math.floor(NewY/this.LayerListPanel.LayerListItemHeight);TheScene.MoveLayer(this.DraggingLayer,NewIndex);this.DraggingDiv.style.visibility="hidden";this.DraggingDiv=null;this.LayerListPanel.AddLayerList(TheScene);}return(false);});TheElement.addEventListener('mouseleave',function(event){if(this.DraggingDiv!=null){this.DraggingDiv.style.visibility="hidden";this.DraggingDiv=null;event.preventDefault();}});};