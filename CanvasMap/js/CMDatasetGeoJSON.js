function CMDatasetGeoJSON(){CMDataset.call(this);this.TheData=null;}CMDatasetGeoJSON.prototype=Object.create(CMDataset.prototype);CMDatasetGeoJSON.prototype.contructor=CMDatasetGeoJSON;CMDatasetGeoJSON.prototype.GetBoundingBoxFromGeoJSON=function(TheData){var TheBounds={};this.FeatureBounds=[];if(TheData!=null){var TheFeatures=TheData.features;for(var i=0;i<TheFeatures.length;i++){var TheGeometry=TheFeatures[i].geometry;var TheFeatureBounds={};CMUtilities.ApplyToGeometryCoordinates(TheGeometry,CMUtilities.UpdateGeoJSONCoordinateBounds,TheFeatureBounds);if(Object.keys(TheBounds).length==0){TheBounds.XMin=TheFeatureBounds.XMin;TheBounds.XMax=TheFeatureBounds.XMax;TheBounds.YMin=TheFeatureBounds.YMin;TheBounds.YMax=TheFeatureBounds.YMax;}else{if(TheBounds.XMin>TheFeatureBounds.XMin)TheBounds.XMin=TheFeatureBounds.XMin;if(TheBounds.XMax<TheFeatureBounds.XMax)TheBounds.XMax=TheFeatureBounds.XMax;if(TheBounds.YMin>TheFeatureBounds.YMin)TheBounds.YMin=TheFeatureBounds.YMin;if(TheBounds.YMax<TheFeatureBounds.YMax)TheBounds.YMax=TheFeatureBounds.YMax;}this.FeatureBounds[i]=TheFeatureBounds;}}return(TheBounds);}
CMDatasetGeoJSON.prototype.PaintRefGeometry=function(TheLayer,TheView,FeatureIndex,TheGeometry,SelectedOnly){if(TheGeometry.type=="LineString"){this.PaintRefLineString(TheGeometry.coordinates);}else if(TheGeometry.type=="MultiLineString"){for(var j=0;j<TheGeometry.coordinates.length;j++){TheCoordinates=TheGeometry.coordinates[j];this.PaintRefLineString(TheLayer,TheView,FeatureIndex,TheCoordinates,SelectedOnly);}}else if(TheGeometry.type=="Polygon"){for(var j=0;j<TheGeometry.coordinates.length;j++){TheCoordinates=TheGeometry.coordinates[j];this.PaintRefPolygon(TheLayer,TheView,FeatureIndex,TheCoordinates,SelectedOnly);}}else if(TheGeometry.type=="MultiPolygon"){for(var i=0;i<TheGeometry.coordinates.length;i++){var TheCoordinateArrays=TheGeometry.coordinates[i];for(var j=0;j<TheCoordinateArrays.length;j++){TheCoordinates=TheCoordinateArrays[j];this.PaintRefPolygon(TheLayer,TheView,FeatureIndex,TheCoordinates,SelectedOnly);}}}else if(TheGeometry.type=="GeometryCollection"){for(var j=0;j<TheGeometry.geometries.length;j++){this.PaintRefGeometry(TheLayer,TheView,FeatureIndex,TheGeometry.geometries[j],SelectedOnly);}}}
CMDatasetGeoJSON.prototype.PaintRefPolygon=function(TheLayer,TheView,FeatureIndex,TheCoordinates,SelectedOnly){TheLayer.PaintPoly(TheView,FeatureIndex,TheCoordinates,true,SelectedOnly);}
CMDatasetGeoJSON.prototype.PaintRefLineString=function(TheLayer,TheView,FeatureIndex,TheCoordinates,SelectedOnly){TheLayer.PaintPoly(TheView,FeatureIndex,TheCoordinates,false,SelectedOnly);}
CMDatasetGeoJSON.prototype.SetBounds=function(NewBounds){this.TheBounds=NewBounds;}
CMDatasetGeoJSON.prototype.GetBounds=function(){return(this.TheBounds);}
CMDatasetGeoJSON.prototype.GetFeatureBounds=function(FeatgureIndex){return(this.FeatureBounds[FeatgureIndex]);}
CMDatasetGeoJSON.prototype.GetNumAttributeRows=function(){var Result=0;if(this.TheData!=null){Result=this.TheData.features.length;}return(Result);}
CMDatasetGeoJSON.prototype.GetNumAttributeColumns=function(){var Result=0;if(this.TheData!=null){var Properties=this.TheData.features[0].properties;for(var key in Properties)Result++;}return(Result);}
CMDatasetGeoJSON.prototype.GetAttributeHeading=function(ColumnIndex){var Result="";if(this.TheData!=null){var Properties=this.TheData.features[0].properties;var TheKey=null;var Column=0;for(var key in Properties){if(Column==ColumnIndex)TheKey=key;Column++;}if(TheKey!=null){Result=TheKey;}}return(Result);}
CMDatasetGeoJSON.prototype.GetAttributeCell=function(ColumnIndex,RowIndex){var Result="";if(this.TheData!=null){var Properties=this.TheData.features[0].properties;var TheKey=null;var Column=0;for(var key in Properties){if(Column==ColumnIndex)TheKey=key;Column++;}if(TheKey!=null){Result=this.TheData.features[RowIndex].properties[TheKey];}}return(Result);}
CMDatasetGeoJSON.prototype.AddAttributeHeading=function(NewHeading,DefaultValue){var Result="";if(this.TheData!=null){var TheFeatures=this.TheData.features;for(i=0;i<TheFeatures.length;i++){TheFeatures[i].properties[NewHeading]=DefaultValue;}}return(Result);}
CMDatasetGeoJSON.prototype.GetAttributeCellByHeading=function(Heading,RowIndex){var Result="";if(this.TheData!=null){var Properties=this.TheData.features[RowIndex].properties;Result=Properties[Heading];}return(Result);}
CMDatasetGeoJSON.prototype.SetAttributeCell=function(ColumnIndex,RowIndex,Value){"use strict";var Result="";if(this.TheData!==null){var Properties=this.TheData.features[RowIndex].properties;Properties[ColumnIndex]=Value;}return(Result);};CMDatasetGeoJSON.prototype.SetAttributeCellByHeading=function(Heading,RowIndex,Value){var Result="";if(this.TheData!=null){var Properties=this.TheData.features[RowIndex].properties;Properties[Heading]=Value;}};CMDatasetGeoJSON.prototype.SetURL=function(URL,ZoomToBounds){this.URL=URL;var TheRequest=new XMLHttpRequest();TheRequest.open("GET",URL,true);TheRequest.TheURL=URL;TheRequest.TheDataset=this;TheRequest.ZoomToBounds=ZoomToBounds;TheRequest.onreadystatechange=function(){if(this.readyState==4){if(this.status==200){var TheText=TheRequest.responseText;var TheGeoJSONObject=JSON.parse(TheText);var TheProjector=this.TheDataset.GetProjector();if(TheProjector!=null){TheProjector.ProjectGeoJSONFromGeographic(TheGeoJSONObject);}this.TheDataset.SetData(TheGeoJSONObject);if(this.ZoomToBounds){var TheMainContainer=this.TheDataset.GetParent(CMMainContainer);TheMainContainer.ZoomToBounds(this.TheDataset.GetBounds());}if(this.TheDataset.GetParent(CMMainContainer)!=null){this.TheDataset.GetParent(CMMainContainer).AddToDebugPanel(this.TheDataset.GetName()+" Received info, repainting:"+CMUtilities.GetSeconds());}{this.TheDataset.SendMessageToListeners(CMDataset.MESSAGE_DATASET_LOADED);}}else alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")");}}
TheRequest.send();};CMDatasetGeoJSON.prototype.SaveDataToURL=function(URL){var TheGeoJSONObject=JSON.stringify(this.TheData);URL=URL+encodeURI("?Data="+TheGeoJSONObject);var TheRequest=new XMLHttpRequest();TheRequest.open("PUT",URL,true);TheRequest.TheURL=URL;TheRequest.TheDataset=this;TheRequest.onreadystatechange=function(){if(this.readyState==4){if(this.status==200){var TheText=TheRequest.responseText;var TheGeoJSONObject=JSON.parse(TheText);}else alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")");}}
TheRequest.send(TheGeoJSONObject);}
CMDatasetGeoJSON.prototype.SetData=function(TheData){this.TheData=TheData;var TheBounds=this.GetBoundingBoxFromGeoJSON(TheData);this.SetBounds(TheBounds);};CMDatasetGeoJSON.prototype.GetNumFeatures=function(){var Result=0;if((this.TheData!=null))Result=this.TheData.features.length;return(Result);}
CMDatasetGeoJSON.prototype.In=function(TheView,RefX,RefY){var FeatureIndex=-1;if((this.TheData!=null)){var Tolerance=TheView.GetRefWidthFromPixelWidth(this.ClickTolerance);var TheFeatures=this.TheData.features;for(var i=0;(i<TheFeatures.length)&&(FeatureIndex==-1);i++){var Result=this.InFeature(TheView,RefX,RefY,i);if(Result)FeatureIndex=i;}}return(FeatureIndex);}
CMDatasetGeoJSON.prototype.InFeature=function(TheView,RefX,RefY,FeatureIndex){var Result=false;if(this.TheData!=null){var Tolerance=TheView.GetRefWidthFromPixelWidth(this.ClickTolerance);var TheFeatures=this.TheData.features;var TheFeature=TheFeatures[FeatureIndex];var TheGeometry=TheFeature.geometry;var Result=false;if(TheGeometry.type=="Point"){var TheCoordinates=TheGeometry.coordinates;if((Math.abs(TheCoordinates[0]-RefX)<=Tolerance)&&(Math.abs(TheCoordinates[1]-RefY)<=Tolerance)){Result=true;}}else if(TheGeometry.type=="LineString"){var TheCoordinates=TheGeometry.coordinates;Result=CMUtilities.InGeoJSONPolyline(RefX,RefY,TheCoordinates,Tolerance);}else if(TheGeometry.type=="MultiLineString"){for(var j=0;j<(TheGeometry.coordinates.length)&&(Result==false);j++){TheCoordinates=TheGeometry.coordinates[j];Result=CMUtilities.InGeoJSONPolyline(RefX,RefY,TheCoordinates,Tolerance);}}else if(TheGeometry.type=="Polygon"){TheCoordinates=TheGeometry.coordinates[0];Result=CMUtilities.InGeoJSONPolygon(RefX,RefY,TheCoordinates);}else if(TheGeometry.type=="MultiPolygon"){for(var j=0;(j<TheGeometry.coordinates.length)&&(Result==false);j++){TheCoordinates=TheGeometry.coordinates[j][0];Result=CMUtilities.InGeoJSONPolygon(RefX,RefY,TheCoordinates);}}}return(Result);};CMDatasetGeoJSON.prototype.Paint=function(TheLayer,TheView,SelectedOnly,MouseOverOnly){if((TheView instanceof CMView2D)&&(this.TheData!=null)){if(MouseOverOnly==undefined)MouseOverOnly=false;this.GetParent(CMMainContainer).AddToDebugPanel(this.GetName()+" Starting Paint:"+CMUtilities.GetSeconds());var TheFeatures=this.TheData.features;var ViewBounds=TheView.GetExtent();for(var FeatureIndex=0;FeatureIndex<TheFeatures.length;FeatureIndex++){var Draw=false;if((SelectedOnly==false)&&(MouseOverOnly==false)){Draw=true;}else if((SelectedOnly)&&(this.SelectedFeature==FeatureIndex)){Draw=true;}else if((MouseOverOnly)&&(this.MouseOverFeatureIndex==FeatureIndex)){Draw=true;}if(Draw){var TheFeatureBounds=this.GetFeatureBounds(FeatureIndex);if((CMUtilities.BoundsOverlap(ViewBounds,TheFeatureBounds))){var TheFeature=TheFeatures[FeatureIndex];var TheGeometry=TheFeature.geometry;var Result=false;if(TheGeometry.type=="Point"){var TheCoordinates=TheGeometry.coordinates;TheLayer.PaintPoint(TheView,FeatureIndex,TheCoordinates[0],TheCoordinates[1],SelectedOnly);}else{var TheGeometry=TheFeatures[FeatureIndex].geometry;this.PaintRefGeometry(TheLayer,TheView,FeatureIndex,TheGeometry,SelectedOnly);}}}}this.GetParent(CMMainContainer).AddToDebugPanel(this.GetName()+" Leaving Paint:"+CMUtilities.GetSeconds());}}
CMDatasetGeoJSON.prototype.GetSearchResults=function(SearchPhrase,ResultsPanel){if((this.TheData!=null)){TheFeatures=this.TheData.features;for(var i=0;i<TheFeatures.length;i++){var TheFeature=TheFeatures[i];var Properties=TheFeature.properties;{var Found=false;for(var key in Properties){if((Found==false)&&(Properties.hasOwnProperty(key))){var TheProperty=Properties[key];if(typeof(TheProperty)=="string"){TheProperty=TheProperty.toLowerCase();if(TheProperty.indexOf(SearchPhrase)!=-1){var ThisResult=document.createElement("DIV");ThisResult.innerHTML=Properties[key];ThisResult.className="CM_SearchResult";ThisResult.TheDataset=this;ThisResult.FeatureIndex=i;ThisResult.onclick=function(){var TheScene=this.TheDataset.GetParent(CMScene);TheScene.UnselectAll();this.TheDataset.SetSelectedFeature(this.FeatureIndex);var TheBounds=this.TheDataset.FeatureBounds[this.FeatureIndex];var TheView=TheScene.GetView(0);this.className="CM_SearchResultSelected";TheView.ZoomToBounds(TheBounds);}
ResultsPanel.appendChild(ThisResult);Found=true;}}}}}}}}
CMDatasetGeoJSON.prototype.CMDataset_GetIcon=CMDataset.prototype.GetIcon;CMDatasetGeoJSON.prototype.GetIcon=function(TheLayer,Default){var TheIcon=this.CMDataset_GetIcon(TheLayer,Default);if((this.TheData!=null)){TheFeatures=this.TheData.features;if(TheFeatures.length>0){var TheGeometry=TheFeatures[0].geometry;if((TheGeometry.type=="LineString")||(TheGeometry.type=="MultiLineString")){TheIcon=document.createElement('div');TheIcon.className="CM_LayerListIconClass";TheIcon.TheLayer=this;TheIcon.style.backgroundColor="rgba(0,0,0,0)";TheIcon.style.borderColor="rgba(0,0,0,0)";var TheCanvas=document.createElement('CANVAS');TheCanvas.width=16;TheCanvas.height=16;TheIcon.appendChild(TheCanvas);var StrokeStyle=TheLayer.GetSetting("Style","strokeStyle");var TheContext=TheCanvas.getContext("2d");TheContext.strokeStyle=StrokeStyle;TheContext.moveTo(0,0);TheContext.lineTo(16,16);TheContext.stroke();}}}return(TheIcon);}
CMDatasetGeoJSON.prototype.AddPoint=function(X,Y){var Projector=this.GetProjector();if(Projector!=null){var Result=Projector.ProjectFromGeographic(X,Y);X=Result.Easting;Y=Result.Northing;}var TheFeature={"type":"Feature","properties":{"scalerank":10},"geometry":{"type":"Point","coordinates":[X,Y]}};if(this.TheData==null){this.TheData={"type":"FeatureCollection","features":[]};}var TheFeatures=this.TheData.features;TheFeatures.push(TheFeature);this.GetBoundingBoxFromGeoJSON(this.TheData);}