CMScaleBar.UNITS_ISO=0;CMScaleBar.UNITS_ENGLISH=1;CMScaleBar.SettingDefintions={ScaleBar:{strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},lineWidth:{Name:"Line Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:['butt','round','square'],Default:'round'},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:['bevel','round','miter'],Default:'round'},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y",Type:CMBase.DATA_TYPE_FLOAT,Default:1}},UnitText:{Text:{Name:"Text",Type:CMBase.DATA_TYPE_STRING,Default:null},font:{Name:"Font",Type:CMBase.DATA_TYPE_FONT,Default:"12px Arial"},strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:['butt','round','square'],Default:'round'},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:['bevel','round','miter'],Default:'round'}},Rectangle:{Coordinates:{Name:"Coordinates",Type:CMBase.DATA_TYPE_COORDINATES,Default:null}},RoundedRectangle:{RoundedCornerWidth:{Name:"Corner Width",Type:CMBase.DATA_TYPE_FLOAT,Default:3},RoundedCornerHeight:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:3},},Factors:{UnitFontHeightFactor:{Name:"Corner Width",Type:CMBase.DATA_TYPE_FLOAT,Default:0.35},LabelFontHeightFactor:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:0.3},ScaleBarHeightFactor:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:0.3},ScaleBarBaseLineFromBottomFactor:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:0.2},Units:{Name:"Units",Type:CMBase.DATA_TYPE_ENUMERATED,Options:[CMScaleBar.UNITS_ISO,CMScaleBar.UNITS_ENGLISH],Default:CMScaleBar.UNITS_ISO},Margin:{Name:"Margin",Type:CMBase.DATA_TYPE_FLOAT,Default:4},}};function CMScaleBar(X,Y,Width,Height){CMItem.call(this)
this.TimeSlices[0].Settings.Rectangle={Coordinates:{Xs:[0,10],Ys:[0,10]}};this.TimeSlices[0].Settings.RoundedRectangle={RoundedCornerWidth:3,RoundedCornerHeight:3};this.TimeSlices[0].Settings.UnitText={};this.TimeSlices[0].Settings.ScaleBar={};this.TimeSlices[0].Settings.Factors={UnitFontHeightFactor:0.35,LabelFontHeightFactor:0.3,ScaleBarHeightFactor:0.3,ScaleBarBaseLineFromBottomFactor:0.2,Units:CMScaleBar.UNITS_ISO,Margin:4,};this.BottomSticky=null;this.RightSticky=null;};CMScaleBar.prototype=Object.create(CMItem.prototype);CMScaleBar.prototype.contructor=CMScaleBar;CMScaleBar.RemovePixels=function(Style){var Result="";if(Style!=null){var Tokens=Style.split(" ");for(var i=0;i<Tokens.length;i++){if(Tokens[i].indexOf("px")==-1){if(Result!="")Result+=" ";Result+=Tokens[i];}}}return(Result);}
CMScaleBar.prototype.SetRightSticky=function(New){this.RightSticky=New;}
CMScaleBar.prototype.GetRightSticky=function(){return(this.RightSticky);}
CMScaleBar.prototype.SetBottomSticky=function(New){this.BottomSticky=New;}
CMScaleBar.prototype.GetBottomSticky=function(){return(this.BottomSticky);}
CMScaleBar.prototype.ViewMoved=function(TheView){}
CMScaleBar.prototype.Paint=function(TheView){var TheCoordinates=this.GetSetting("Rectangle","Coordinates");var LeftX=TheCoordinates.Xs[0];var RightX=TheCoordinates.Xs[1];var MiddleY=(TheCoordinates.Ys[0]+TheCoordinates.Ys[1]/2);var Width=TheCoordinates.Xs[1]-TheCoordinates.Xs[0];var MinY=TheCoordinates.Ys[0];var Height=TheCoordinates.Ys[1]-TheCoordinates.Ys[0];var TheScene=this.GetParent(CMScene);var TheView=TheScene.GetView(0);var Lon1=TheView.GetRefXFromPixelX(LeftX);var Lat1=TheView.GetRefYFromPixelY(MiddleY);var Lon2=TheView.GetRefXFromPixelX(RightX);var Lat2=Lat1;var TheProjector=TheScene.GetCanvasMap().GetProjector();if(TheProjector!=null){var Result=TheProjector.ProjectToGeographic(Lon1,Lat1);Lon1=Result.Longitude;Lat1=Result.Latitude;var Result=TheProjector.ProjectToGeographic(Lon2,Lat2);Lon2=Result.Longitude;Lat2=Result.Latitude;}Lon1=Lon1/180*Math.PI;Lat1=Lat1/180*Math.PI;Lon2=Lon2/180*Math.PI;Lat2=Lat2/180*Math.PI;var DeltaAngle=Math.acos(Math.sin(Lat1)*Math.sin(Lat2)+Math.cos(Lat1)*Math.cos(Lat2)*Math.cos(Math.abs(Lon2-Lon1)));var Distance=DeltaAngle*6371;if(Units==CMScaleBar.UNITS_ENGLISH)Distance*=0.621371;var ctx=TheView.TheContext;var FactorSettings=this.GetSettingGroup("Factors");var UnitFontHeightFactor=FactorSettings["UnitFontHeightFactor"];var LabelFontHeightFactor=FactorSettings["LabelFontHeightFactor"];var ScaleBarHeightFactor=FactorSettings["ScaleBarHeightFactor"];var ScaleBarBaseLineFromBottomFactor=FactorSettings["ScaleBarBaseLineFromBottomFactor"];var Margin=FactorSettings["Margin"];var Units=FactorSettings["Units"];var TheLabelFontSetting=this.GetSetting("Text","font");TheLabelFontSetting=CMScaleBar.RemovePixels(TheLabelFontSetting);var LabelFontSize=""+(Height*LabelFontHeightFactor);var TheLabelFont=LabelFontSize+"px "+TheLabelFontSetting;ctx.font=TheLabelFont;var ZeroText=""+0;var ZeroWidth=ctx.measureText(ZeroText).width;var AvailablePixels=Width-(ZeroWidth/2)-(Margin*2);var RefDistancePerPixel=Distance/Width;var ScaleBarWidthInRefUnits=RefDistancePerPixel*AvailablePixels;var N=Math.log10(ScaleBarWidthInRefUnits);N=Math.ceil(N);ScaleBarWidthInRefUnits=Math.pow(10,N);var Interval=1;var NumDigits=N+1;var UnitString="km";if(Units==CMScaleBar.UNITS_ENGLISH)UnitString="miles";var TheUnitFontSetting=this.GetSetting("UnitText","font");TheUnitFontSetting=CMScaleBar.RemovePixels(TheUnitFontSetting);var UnitFontSize=""+(Height*UnitFontHeightFactor);var TheUnitFont=UnitFontSize+"px "+this.TheUnitFontSetting;ctx.font=TheUnitFont;var UnitWidth=ctx.measureText(UnitString).width;var ScaleBarWidthInPixels;var Fits=false;var Count=0;while((Fits==false)&&(Count<100)){if((ScaleBarWidthInRefUnits<1)&&((UnitString=="km")||(UnitString=="miles"))){if(UnitString=="km"){ScaleBarWidthInRefUnits*=1000;UnitString="m";RefDistancePerPixel=RefDistancePerPixel*1000;}else{ScaleBarWidthInRefUnits*=10000;UnitString="ft";RefDistancePerPixel=RefDistancePerPixel*10000;}ctx.font=TheUnitFont;var UnitWidth=ctx.measureText(UnitString).width;}var LabelText=""+ScaleBarWidthInRefUnits;ctx.font=TheLabelFont;var LabelWidth=ctx.measureText(LabelText).width;ScaleBarWidthInPixels=ScaleBarWidthInRefUnits/RefDistancePerPixel;var FullWidth=ScaleBarWidthInPixels;if((LabelWidth/2)>UnitWidth)FullWidth+=(LabelWidth/2);else FullWidth+=UnitWidth;if(FullWidth<AvailablePixels){Fits=true;}else if(((UnitString=="m")||(UnitString=="ft"))&&(ScaleBarWidthInRefUnits<=0.01)){Fits=true;}else{if(Interval==1){Interval=5;ScaleBarWidthInRefUnits=ScaleBarWidthInRefUnits/2;}else if(Interval==5){Interval=2;ScaleBarWidthInRefUnits=ScaleBarWidthInRefUnits*2/5;}else{Interval=1;ScaleBarWidthInRefUnits=ScaleBarWidthInRefUnits/2;}}Count+=1;}var ScaleBarWidthInPixels=ScaleBarWidthInRefUnits/RefDistancePerPixel;var ScaleBarLeft=LeftX+Margin+(ZeroWidth/2);var ScaleBarRight=ScaleBarLeft+ScaleBarWidthInPixels;var ScaleBarY=MinY+Height-(Height*ScaleBarBaseLineFromBottomFactor);var TheStyleSettings=this.GetStyle(TheView,0,"Style");var TheLabelSettings=this.GetStyle(TheView,0,"Text");var TheUnitTextSettings=this.GetStyle(TheView,0,"UnitText");var TheScaleBarSettings=this.GetStyle(TheView,0,"ScaleBar");var RoundedCornerWidth=this.GetSetting("RoundedRectangle","RoundedCornerWidth");var RoundedCornerHeight=this.GetSetting("RoundedRectangle","RoundedCornerHeight");TheView.SetStyle(TheStyleSettings);TheView.PaintRoundedRect(LeftX,RightX,MinY,MinY+Height,RoundedCornerWidth,RoundedCornerHeight);TheView.RestoreStyle();TheView.SetStyle(TheUnitTextSettings);ctx.font=TheUnitFont;ctx.fillText(UnitString,ScaleBarLeft+ScaleBarWidthInPixels+Margin,ScaleBarY);TheView.RestoreStyle();TheView.SetStyle(TheScaleBarSettings);ctx.beginPath();ctx.moveTo(ScaleBarLeft,ScaleBarY);ctx.lineTo(ScaleBarRight,ScaleBarY);ctx.stroke();var ScaleBarHeight=Height*ScaleBarHeightFactor;ctx.beginPath();ctx.moveTo(ScaleBarLeft,ScaleBarY);ctx.lineTo(ScaleBarLeft,ScaleBarY-ScaleBarHeight);ctx.stroke();ctx.beginPath();ctx.moveTo(ScaleBarRight,ScaleBarY);ctx.lineTo(ScaleBarRight,ScaleBarY-ScaleBarHeight);ctx.stroke();TheView.RestoreStyle();TheView.SetStyle(TheLabelSettings);ctx.font=TheLabelFont;var LabelBaseLine=ScaleBarY-ScaleBarHeight-Margin;ctx.fillText("0",ScaleBarLeft-(ZeroWidth/2),LabelBaseLine);var LabelText=""+ScaleBarWidthInRefUnits;var LabelWidth=ctx.measureText(LabelText).width;ctx.fillText(LabelText,ScaleBarRight-LabelWidth/2,LabelBaseLine);TheView.RestoreStyle();}
CMScaleBar.CheckFit=function(AvailablePixels,ScaleBarWidthInRefUnits){};